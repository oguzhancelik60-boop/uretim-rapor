<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#D32F2F">
    <title>NordPanels‚Ñ¢</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', system-ui, sans-serif; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
        input[type="number"] { -moz-appearance: textfield; }
        .input-field { font-size: 16px !important; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .offline-badge { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #EF4444; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; z-index: 1001; }
        .offline-badge.show { display: flex; align-items: center; gap: 8px; }
        .pending-badge { position: fixed; top: 10px; left: 10px; background: #F59E0B; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 1001; display: none; cursor: pointer; }
        .pending-badge.show { display: flex; align-items: center; gap: 6px; }
        .sync-badge { position: fixed; top: 10px; right: 10px; background: #10B981; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 1001; display: none; }
        .sync-badge.show { display: flex; align-items: center; gap: 6px; }
        .login-page { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%); position: relative; overflow: hidden; }
        .bg-glow { position: absolute; width: 400px; height: 400px; background: radial-gradient(circle, rgba(211,47,47,0.3) 0%, transparent 70%); border-radius: 50%; filter: blur(60px); }
        .bg-glow-1 { top: -200px; left: -200px; }
        .bg-glow-2 { bottom: -200px; right: -200px; }
        .login-card { background: white; border-radius: 32px; padding: 40px 32px; width: 90%; max-width: 380px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); position: relative; z-index: 10; }
        .logo-box { width: 80px; height: 80px; background: linear-gradient(135deg, #D32F2F, #B71C1C); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 32px; color: white; margin: 0 auto 16px; box-shadow: 0 10px 40px rgba(211,47,47,0.4); }
        .brand { font-size: 26px; font-weight: 800; text-align: center; color: #1a1a2e; }
        .brand span { color: #D32F2F; }
        .tagline { font-size: 10px; color: #888; text-align: center; letter-spacing: 3px; margin-top: 4px; }
        .login-input { width: 100%; padding: 14px 18px; background: #f5f5f5; border: 2px solid transparent; border-radius: 12px; font-size: 15px; margin-bottom: 12px; transition: all 0.2s; }
        .login-input:focus { outline: none; border-color: #D32F2F; background: white; }
        .login-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #D32F2F, #B71C1C); border: none; border-radius: 12px; color: white; font-size: 15px; font-weight: 700; cursor: pointer; }
        .login-error { background: #FEE2E2; color: #DC2626; padding: 12px; border-radius: 10px; margin-bottom: 12px; font-size: 13px; display: none; text-align: center; }
        .login-error.show { display: block; }
        .demo-box { margin-top: 16px; padding: 12px; background: #f9f9f9; border-radius: 10px; font-size: 11px; }
        .demo-item { background: white; padding: 6px 10px; border-radius: 6px; margin: 4px 0; font-family: monospace; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="offlineBadge" class="offline-badge">üì¥ –û—Ñ—Ñ–ª–∞–π–Ω</div>
    <div id="pendingBadge" class="pending-badge" onclick="syncPending()">‚è≥ <span id="pendingCount">0</span></div>
    <div id="syncBadge" class="sync-badge">‚òÅÔ∏è Sync</div>
    <div id="app"></div>
<script>
// CONFIG
const SUPABASE_URL = 'https://exxznkibcoyaemlqmcon.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eHpua2liY295YWVtbHFtY29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMTk4MzMsImV4cCI6MjA4MzY5NTgzM30.AqAud6Mo6x1sy7FB_at8f2BnTZSVsytXHXC_b5WX0yQ';
const CLOUDINARY_CLOUD = 'de8orxjfy';
const CLOUDINARY_PRESET = 'uretim_unsigned';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const STANDART = { en: '1250', boy: '2500', kalinlik: '1.5' };
const USERS = {
    'admin': { password: 'admin123', name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', isAdmin: true, perms: ['kurutma', 'papel'] },
    'ali': { password: 'ali123', name: '–ê–ª–∏', isAdmin: false, perms: ['kurutma'] },
    'mehmet': { password: 'mehmet123', name: '–ú–µ—Ö–º–µ—Ç', isAdmin: false, perms: ['kurutma', 'papel'] },
    'ayse': { password: 'ayse123', name: '–ê–π—à–µ', isAdmin: false, perms: ['papel'] }
};
const PROSES = [
    { id: 'agac', name: '–ü—Ä–∏—ë–º –ª–µ—Å–∞', icon: 'üå≥', color: 'bg-green-500', active: false },
    { id: 'soyma', name: '–õ—É—â–µ–Ω–∏–µ', icon: '‚úÇÔ∏è', color: 'bg-yellow-500', active: false },
    { id: 'kurutma', name: '–°—É—à–∫–∞', icon: 'üî•', color: 'bg-orange-500', active: true },
    { id: 'papel', name: '–†–µ–±—Ä–æ—Å–∫–ª–µ–π–∫–∞', icon: '‚ûï', color: 'bg-blue-500', active: true },
    { id: 'tutkal', name: '–°–∫–ª–µ–∏–≤–∞–Ω–∏–µ', icon: 'üíß', color: 'bg-purple-500', active: false },
    { id: 'depo', name: '–°–∫–ª–∞–¥', icon: 'üì¶', color: 'bg-indigo-500', active: false }
];

// STATE
const createKurutma = () => [1,2,3,4].map(id => ({ id, ...STANDART, qp: '', qd: '', photo: null, preview: null, aiResult: null }));
const createPapel = () => [
    { id: 1, type: 'poperechny', name: '–ü–æ–ø–µ—Ä–µ—á–Ω—ã–π', icon: '‚ÜîÔ∏è', color: 'blue', ...STANDART, shpon: '', photo: null, preview: null, aiResult: null },
    { id: 2, type: 'prodolny', name: '–ü—Ä–æ–¥–æ–ª—å–Ω—ã–π', icon: '‚ÜïÔ∏è', color: 'green', ...STANDART, shpon: '', photo: null, preview: null, aiResult: null }
];

let S = {
    logged: false, user: null, proses: null, tab: 'entry', shift: 'sabah',
    date: new Date().toISOString().split('T')[0],
    kurutma: createKurutma(), papel: createPapel(),
    reports: [], papelReports: [],
    fStart: '', fEnd: '', filtering: false, loading: false, saving: false
};

// HELPER FUNCTIONS
function updateOnline() {
    const b = document.getElementById('offlineBadge');
    if (b) navigator.onLine ? b.classList.remove('show') : b.classList.add('show');
}

function updatePendingBadge() {
    const p = getPending();
    const b = document.getElementById('pendingBadge');
    const c = document.getElementById('pendingCount');
    if (b && c) {
        if (p.length > 0) { b.classList.add('show'); c.textContent = p.length; }
        else { b.classList.remove('show'); }
    }
}

function showSync() {
    const b = document.getElementById('syncBadge');
    if (b) { b.classList.add('show'); setTimeout(() => b.classList.remove('show'), 2000); }
}

function showToast() {
    const t = document.getElementById('toast');
    if (t) { t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); }
}

// OFFLINE
function getPending() { return JSON.parse(localStorage.getItem('pending') || '[]'); }
function savePending(r) { const p = getPending(); p.push({...r, pid: Date.now()}); localStorage.setItem('pending', JSON.stringify(p)); updatePendingBadge(); }
function removePending(id) { localStorage.setItem('pending', JSON.stringify(getPending().filter(r => r.pid !== id))); updatePendingBadge(); }

async function syncPending() {
    if (!navigator.onLine) return alert('–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞');
    const p = getPending();
    let s = 0;
    for (const r of p) {
        const t = r.type === 'papel' ? 'papel_ekleme_reports' : 'reports';
        const { error } = await db.from(t).insert([r.data]);
        if (!error) { removePending(r.pid); s++; }
    }
    if (s) { showSync(); loadReports(); alert('‚úÖ ' + s + ' —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ!'); }
}

window.addEventListener('online', () => { updateOnline(); if (getPending().length) setTimeout(syncPending, 2000); });
window.addEventListener('offline', updateOnline);

// CALCULATIONS
function calcVol(m, t) {
    const e = parseFloat(m.en) || 0, b = parseFloat(m.boy) || 0, k = parseFloat(m.kalinlik) || 0;
    const q = parseFloat(t === 'p' ? m.qp : m.qd) || 0;
    return ((e / 1000) * (b / 1000) * (k / 1000) * q).toFixed(3);
}
function totalVol(t) { return S.kurutma.reduce((s, m) => s + parseFloat(calcVol(m, t)), 0).toFixed(3); }
function totalQty(t) { return S.kurutma.reduce((s, m) => s + (parseFloat(t === 'p' ? m.qp : m.qd) || 0), 0); }
function grandTotal() { return (parseFloat(totalVol('p')) + parseFloat(totalVol('d'))).toFixed(3); }

function calcPapelVol(m) {
    const e = parseFloat(m.en) || 0, b = parseFloat(m.boy) || 0, k = parseFloat(m.kalinlik) || 0;
    const q = parseFloat(m.shpon) || 0;
    return ((e / 1000) * (b / 1000) * (k / 1000) * q).toFixed(3);
}
function totalShpon() { return S.papel.reduce((s, m) => s + (parseFloat(m.shpon) || 0), 0); }
function grandPapelTotal() { return S.papel.reduce((s, m) => s + parseFloat(calcPapelVol(m)), 0).toFixed(3); }

// CLOUD
async function uploadPhoto(file) {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY_PRESET);
    try {
        const r = await fetch('https://api.cloudinary.com/v1_1/' + CLOUDINARY_CLOUD + '/image/upload', { method: 'POST', body: fd });
        const d = await r.json();
        return d.secure_url || null;
    } catch (e) { return null; }
}

async function analyzePhoto(url, type) {
    try {
        const r = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ imageUrl: url })
        });
        const d = await r.json();
        return d.result !== undefined ? d.result : null;
    } catch (e) { return null; }
}

function verify(entered, aiRead) {
    if (aiRead === null || aiRead === undefined) return { status: 'unknown', icon: '‚ö™', color: 'gray', entered, aiRead: null, diff: null };
    const diff = Math.abs(entered - aiRead);
    if (diff <= 5) return { status: 'verified', icon: '‚úÖ', color: 'green', entered, aiRead, diff };
    return { status: 'mismatch', icon: '‚ùå', color: 'red', entered, aiRead, diff };
}

async function loadReports() {
    S.loading = true; render();
    try {
        if (S.proses === 'kurutma') {
            const { data } = await db.from('reports').select('*').order('created_at', { ascending: false });
            if (data) S.reports = data;
        } else if (S.proses === 'papel') {
            const { data } = await db.from('papel_ekleme_reports').select('*').order('created_at', { ascending: false });
            if (data) S.papelReports = data;
        }
        showSync();
    } catch (e) { console.error(e); }
    S.loading = false; render();
}

// RENDER FUNCTIONS
function render() {
    const app = document.getElementById('app');
    if (!app) return;
    updateOnline();
    updatePendingBadge();
    
    if (!S.logged) { renderLogin(); return; }
    if (!S.proses) { renderProses(); return; }
    if (S.proses === 'kurutma') renderKurutma();
    else if (S.proses === 'papel') renderPapel();
}

function renderLogin() {
    document.getElementById('app').innerHTML = `
    <div class="login-page">
        <div class="bg-glow bg-glow-1"></div>
        <div class="bg-glow bg-glow-2"></div>
        <div class="login-card">
            <div class="logo-box">NP</div>
            <div class="brand">Nord<span>Panels</span>‚Ñ¢</div>
            <div class="tagline">SMART FACTORY SYSTEM</div>
            <div style="display:flex;justify-content:center;gap:8px;margin:20px 0">
                <span style="background:#f0f0f0;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600">‚òÅÔ∏è Cloud</span>
                <span style="background:#f0f0f0;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600">ü§ñ AI</span>
                <span style="background:#f0f0f0;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600">üì± PWA</span>
            </div>
            <div id="loginError" class="login-error"></div>
            <input id="username" class="login-input" placeholder="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" type="text">
            <input id="password" class="login-input" placeholder="–ü–∞—Ä–æ–ª—å" type="password">
            <button class="login-btn" onclick="doLogin()">üöÄ –í–û–ô–¢–ò</button>
            <div class="demo-box">
                <div style="font-weight:600;margin-bottom:6px">üìã –î–µ–º–æ:</div>
                <div class="demo-item">admin / admin123</div>
                <div class="demo-item">mehmet / mehmet123</div>
            </div>
        </div>
    </div>`;
}

function renderProses() {
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gradient-to-br from-slate-100 to-indigo-100">
        <div class="bg-white shadow-lg">
            <div class="max-w-lg mx-auto p-4 flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">üè≠ –°–∏—Å—Ç–µ–º–∞ –û—Ç—á—ë—Ç–æ–≤</h1>
                    <p class="text-sm text-gray-500">${S.user.name}</p>
                </div>
                <button onclick="doLogout()" class="bg-red-500 text-white px-4 py-2 rounded-xl text-sm">–í—ã—Ö–æ–¥</button>
            </div>
        </div>
        <div class="max-w-lg mx-auto p-4 grid grid-cols-2 gap-3">
            ${PROSES.map(p => {
                const has = S.user.perms.includes(p.id);
                return `<div onclick="${has && p.active ? `selectProses('${p.id}')` : ''}" 
                    class="bg-white rounded-2xl shadow p-5 text-center ${has && p.active ? 'cursor-pointer hover:shadow-lg active:scale-95' : 'opacity-50'} transition-all">
                    <div class="${p.color} w-14 h-14 rounded-xl flex items-center justify-center text-2xl mx-auto mb-2">${p.icon}</div>
                    <div class="font-semibold text-gray-800">${p.name}</div>
                    ${!p.active ? '<div class="text-xs text-amber-500 mt-1">‚è≥ –°–∫–æ—Ä–æ</div>' : ''}
                    ${!has && p.active ? '<div class="text-xs text-red-500 mt-1">üîí</div>' : ''}
                </div>`;
            }).join('')}
        </div>
    </div>`;
}

function renderKurutma() {
    const filtered = S.filtering ? S.reports.filter(r => { const d = r.date?.split(' ')[0]; return (!S.fStart || d >= S.fStart) && (!S.fEnd || d <= S.fEnd); }) : S.reports;
    
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 pb-20">
        <div class="bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-lg">
            <div class="max-w-lg mx-auto p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <button onclick="goBack()" class="bg-white/20 w-10 h-10 rounded-xl flex items-center justify-center">‚Üê</button>
                    <div>
                        <h1 class="font-bold">üî• –°—É—à–∫–∞</h1>
                        <p class="text-xs text-orange-100">${S.user.name}${S.user.isAdmin ? ' üëë' : ''}</p>
                    </div>
                </div>
                <button onclick="doLogout()" class="bg-red-500 px-3 py-2 rounded-xl text-sm">–í—ã—Ö–æ–¥</button>
            </div>
        </div>
        <div class="max-w-lg mx-auto p-4">
            <div class="flex gap-2 mb-4 bg-white rounded-2xl p-1.5 shadow">
                <button onclick="setTab('entry')" class="flex-1 py-2.5 rounded-xl font-semibold text-sm ${S.tab === 'entry' ? 'bg-orange-500 text-white' : 'text-gray-500'}">üìù –í–≤–æ–¥</button>
                <button onclick="setTab('reports')" class="flex-1 py-2.5 rounded-xl font-semibold text-sm ${S.tab === 'reports' ? 'bg-orange-500 text-white' : 'text-gray-500'}">üìã –û—Ç—á—ë—Ç—ã</button>
            </div>
            ${S.tab === 'entry' ? renderKurutmaEntry() : renderKurutmaReports(filtered)}
        </div>
    </div>
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg hidden z-50">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</div>`;
}

function renderKurutmaEntry() {
    return `
    <div class="bg-white rounded-2xl shadow p-4 mb-3">
        <div class="flex gap-3 mb-3">
            <button onclick="setShift('sabah')" class="flex-1 py-3 rounded-xl font-semibold ${S.shift === 'sabah' ? 'bg-amber-400 text-white' : 'bg-gray-100'}">üåÖ –£—Ç—Ä–æ</button>
            <button onclick="setShift('aksam')" class="flex-1 py-3 rounded-xl font-semibold ${S.shift === 'aksam' ? 'bg-indigo-500 text-white' : 'bg-gray-100'}">üåô –í–µ—á–µ—Ä</button>
        </div>
        ${S.user.isAdmin ? `<input type="date" value="${S.date}" onchange="setDate(this.value)" class="w-full p-3 border-2 rounded-xl">` : ''}
    </div>
    ${S.kurutma.map(m => `
    <div class="bg-white rounded-2xl shadow p-4 mb-3 border-l-4 border-orange-400">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
                <div class="bg-orange-100 text-orange-600 w-10 h-10 rounded-xl flex items-center justify-center font-bold">${m.id}</div>
                <span class="font-semibold">–ú–∞—à–∏–Ω–∞ ${m.id}</span>
            </div>
            ${m.aiResult !== null ? `<span class="text-xs px-2 py-1 rounded-full bg-${verify(parseInt(m.qp)||parseInt(m.qd)||0, m.aiResult).color}-100 text-${verify(parseInt(m.qp)||parseInt(m.qd)||0, m.aiResult).color}-700">${verify(parseInt(m.qp)||parseInt(m.qd)||0, m.aiResult).icon} AI: ${m.aiResult}</span>` : ''}
        </div>
        <div class="flex gap-2 mb-3">
            <label class="flex-1 cursor-pointer"><div class="py-2.5 rounded-xl text-center text-sm font-semibold ${m.preview ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}">üì∑</div><input type="file" accept="image/*" capture="environment" onchange="handleKPhoto(${m.id},this)" class="hidden"></label>
            <label class="flex-1 cursor-pointer"><div class="py-2.5 rounded-xl text-center text-sm font-semibold ${m.preview ? 'bg-green-500 text-white' : 'bg-purple-500 text-white'}">üñºÔ∏è</div><input type="file" accept="image/*" onchange="handleKPhoto(${m.id},this)" class="hidden"></label>
        </div>
        ${m.preview ? `<div class="mb-3 relative"><img src="${m.preview}" class="w-full h-28 object-cover rounded-xl"><button onclick="clearKPhoto(${m.id})" class="absolute top-1 right-1 bg-red-500 text-white w-7 h-7 rounded-full text-sm">‚úï</button></div>` : ''}
        <div class="grid grid-cols-3 gap-2 mb-3">
            <div><label class="text-xs text-gray-400">–®–∏—Ä–∏–Ω–∞</label><input type="number" value="${m.en}" onchange="updateK(${m.id},'en',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-gray-50"></div>
            <div><label class="text-xs text-gray-400">–î–ª–∏–Ω–∞</label><input type="number" value="${m.boy}" onchange="updateK(${m.id},'boy',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-gray-50"></div>
            <div><label class="text-xs text-gray-400">–¢–æ–ª—â–∏–Ω–∞</label><input type="number" value="${m.kalinlik}" onchange="updateK(${m.id},'kalinlik',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-gray-50" step="0.1"></div>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-blue-50 p-3 rounded-xl">
                <label class="text-xs text-blue-600 font-semibold">–ü–æ–ø–µ—Ä–µ—á–Ω—ã–π</label>
                <input type="number" value="${m.qp}" onchange="updateK(${m.id},'qp',this.value)" class="input-field w-full p-2 mt-1 border-2 border-blue-200 rounded-lg text-center font-bold text-blue-700" placeholder="0">
            </div>
            <div class="bg-green-50 p-3 rounded-xl">
                <label class="text-xs text-green-600 font-semibold">–ü—Ä–æ–¥–æ–ª—å–Ω—ã–π</label>
                <input type="number" value="${m.qd}" onchange="updateK(${m.id},'qd',this.value)" class="input-field w-full p-2 mt-1 border-2 border-green-200 rounded-lg text-center font-bold text-green-700" placeholder="0">
            </div>
        </div>
    </div>`).join('')}
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-4 text-white">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="bg-white/20 rounded-xl p-3 text-center">
                <div class="text-xs opacity-80">–ü–æ–ø–µ—Ä–µ—á–Ω—ã–π</div>
                <div class="text-xl font-bold">${totalQty('p')} —à—Ç</div>
                <div class="text-sm">${totalVol('p')} m¬≥</div>
            </div>
            <div class="bg-white/20 rounded-xl p-3 text-center">
                <div class="text-xs opacity-80">–ü—Ä–æ–¥–æ–ª—å–Ω—ã–π</div>
                <div class="text-xl font-bold">${totalQty('d')} —à—Ç</div>
                <div class="text-sm">${totalVol('d')} m¬≥</div>
            </div>
        </div>
        <div class="bg-white/30 rounded-xl p-3 text-center mb-3">
            <div class="text-sm">–û–±—â–∏–π –û–±—ä—ë–º</div>
            <div class="text-3xl font-bold">${grandTotal()} m¬≥</div>
        </div>
        <button onclick="saveKurutma()" class="w-full bg-green-500 py-3 rounded-xl font-bold" ${S.saving ? 'disabled' : ''}>
            ${S.saving ? '<span class="spinner"></span> AI –∞–Ω–∞–ª–∏–∑...' : 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
        </button>
    </div>`;
}

function renderKurutmaReports(list) {
    return `
    <div class="bg-white rounded-2xl shadow p-3 mb-3">
        <div class="grid grid-cols-3 gap-2 mb-2">
            <input type="date" value="${S.fStart}" onchange="S.fStart=this.value" class="p-2 border rounded-lg text-xs">
            <input type="date" value="${S.fEnd}" onchange="S.fEnd=this.value" class="p-2 border rounded-lg text-xs">
            <button onclick="applyFilter()" class="bg-indigo-500 text-white rounded-lg text-xs">–§–∏–ª—å—Ç—Ä</button>
        </div>
        <div class="flex gap-2">
            ${S.filtering ? '<button onclick="clearFilter()" class="flex-1 bg-gray-400 text-white py-2 rounded-lg text-xs">–í—Å–µ</button>' : ''}
            <button onclick="loadReports()" class="flex-1 bg-blue-500 text-white py-2 rounded-lg text-xs">üîÑ</button>
            <button onclick="exportK()" class="flex-1 bg-green-500 text-white py-2 rounded-lg text-xs">üìä</button>
        </div>
    </div>
    ${S.loading ? '<div class="text-center py-8"><div class="spinner" style="border-top-color:#F97316;width:32px;height:32px"></div></div>' :
    list.length === 0 ? '<div class="bg-white rounded-2xl p-6 text-center text-gray-400">üìã –ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤</div>' :
    list.map(r => `
    <div class="bg-white rounded-2xl shadow p-3 mb-2 border-l-4 border-${r.verification_status === 'verified' ? 'green' : r.verification_status === 'mismatch' ? 'red' : 'gray'}-400">
        <div class="flex justify-between items-start mb-2">
            <div>
                <div class="font-semibold">${r.date}</div>
                <div class="text-xs text-gray-500">${r.shift === 'sabah' ? 'üåÖ' : 'üåô'} ${r.user_name}</div>
            </div>
            ${S.user.isAdmin ? `<button onclick="deleteK(${r.id})" class="text-red-500 text-xs">üóëÔ∏è</button>` : ''}
        </div>
        <div class="flex gap-2 text-center text-sm">
            <div class="flex-1 bg-blue-50 rounded-lg p-2"><div class="text-xs text-blue-600">–ü–æ–ø.</div><div class="font-bold text-blue-700">${r.tqp}</div></div>
            <div class="flex-1 bg-green-50 rounded-lg p-2"><div class="text-xs text-green-600">–ü—Ä–æ–¥.</div><div class="font-bold text-green-700">${r.tqd}</div></div>
            <div class="flex-1 bg-indigo-50 rounded-lg p-2"><div class="text-xs text-indigo-600">–û–±—ä—ë–º</div><div class="font-bold text-indigo-700">${r.gt} m¬≥</div></div>
        </div>
    </div>`).join('')}`;
}

function renderPapel() {
    const filtered = S.filtering ? S.papelReports.filter(r => { const d = r.date?.split(' ')[0]; return (!S.fStart || d >= S.fStart) && (!S.fEnd || d <= S.fEnd); }) : S.papelReports;
    
    document.getElementById('app').innerHTML = `
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 pb-20">
        <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-lg">
            <div class="max-w-lg mx-auto p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <button onclick="goBack()" class="bg-white/20 w-10 h-10 rounded-xl flex items-center justify-center">‚Üê</button>
                    <div>
                        <h1 class="font-bold">‚ûï –†–µ–±—Ä–æ—Å–∫–ª–µ–π–∫–∞</h1>
                        <p class="text-xs text-blue-100">${S.user.name}${S.user.isAdmin ? ' üëë' : ''}</p>
                    </div>
                </div>
                <button onclick="doLogout()" class="bg-red-500 px-3 py-2 rounded-xl text-sm">–í—ã—Ö–æ–¥</button>
            </div>
        </div>
        <div class="max-w-lg mx-auto p-4">
            <div class="flex gap-2 mb-4 bg-white rounded-2xl p-1.5 shadow">
                <button onclick="setTab('entry')" class="flex-1 py-2.5 rounded-xl font-semibold text-sm ${S.tab === 'entry' ? 'bg-blue-500 text-white' : 'text-gray-500'}">üìù –í–≤–æ–¥</button>
                <button onclick="setTab('reports')" class="flex-1 py-2.5 rounded-xl font-semibold text-sm ${S.tab === 'reports' ? 'bg-blue-500 text-white' : 'text-gray-500'}">üìã –û—Ç—á—ë—Ç—ã</button>
            </div>
            ${S.tab === 'entry' ? renderPapelEntry() : renderPapelReports(filtered)}
        </div>
    </div>
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg hidden z-50">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</div>`;
}

function renderPapelEntry() {
    return `
    <div class="bg-white rounded-2xl shadow p-4 mb-3">
        <div class="flex gap-3 mb-3">
            <button onclick="setShift('sabah')" class="flex-1 py-3 rounded-xl font-semibold ${S.shift === 'sabah' ? 'bg-amber-400 text-white' : 'bg-gray-100'}">üåÖ –£—Ç—Ä–æ</button>
            <button onclick="setShift('aksam')" class="flex-1 py-3 rounded-xl font-semibold ${S.shift === 'aksam' ? 'bg-indigo-500 text-white' : 'bg-gray-100'}">üåô –í–µ—á–µ—Ä</button>
        </div>
        ${S.user.isAdmin ? `<input type="date" value="${S.date}" onchange="setDate(this.value)" class="w-full p-3 border-2 rounded-xl">` : ''}
    </div>
    ${S.papel.map(m => `
    <div class="bg-white rounded-2xl shadow p-4 mb-3 border-l-4 border-${m.color}-500">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-3">
                <div class="bg-${m.color}-100 text-${m.color}-600 w-12 h-12 rounded-xl flex items-center justify-center text-2xl">${m.icon}</div>
                <div>
                    <div class="font-bold">–ú–∞—à–∏–Ω–∞ ${m.name}</div>
                    <div class="text-xs text-${m.color}-500">${m.type === 'poperechny' ? 'Sokrasƒ±na' : 'Suyuna'}</div>
                </div>
            </div>
            ${m.aiResult !== null ? `<span class="text-xs px-2 py-1 rounded-full bg-${verify(parseInt(m.shpon)||0, m.aiResult).color}-100 text-${verify(parseInt(m.shpon)||0, m.aiResult).color}-700">${verify(parseInt(m.shpon)||0, m.aiResult).icon} AI: ${m.aiResult}</span>` : ''}
        </div>
        <div class="flex gap-2 mb-3">
            <label class="flex-1 cursor-pointer"><div class="py-2.5 rounded-xl text-center text-sm font-semibold ${m.preview ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}">üì∑ –ö–∞–º–µ—Ä–∞</div><input type="file" accept="image/*" capture="environment" onchange="handlePPhoto(${m.id},this)" class="hidden"></label>
            <label class="flex-1 cursor-pointer"><div class="py-2.5 rounded-xl text-center text-sm font-semibold ${m.preview ? 'bg-green-500 text-white' : 'bg-purple-500 text-white'}">üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è</div><input type="file" accept="image/*" onchange="handlePPhoto(${m.id},this)" class="hidden"></label>
        </div>
        ${m.preview ? `<div class="mb-3 relative"><img src="${m.preview}" class="w-full h-32 object-cover rounded-xl border-2 border-${m.color}-200"><button onclick="clearPPhoto(${m.id})" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full">‚úï</button></div>` : ''}
        <div class="grid grid-cols-3 gap-2 mb-3">
            <div><label class="text-xs text-gray-400">–®–∏—Ä–∏–Ω–∞</label><input type="number" value="${m.en}" onchange="updateP(${m.id},'en',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-gray-50"></div>
            <div><label class="text-xs text-gray-400">–î–ª–∏–Ω–∞</label><input type="number" value="${m.boy}" onchange="updateP(${m.id},'boy',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-gray-50"></div>
            <div><label class="text-xs text-gray-400">–¢–æ–ª—â–∏–Ω–∞</label><input type="number" value="${m.kalinlik}" onchange="updateP(${m.id},'kalinlik',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-gray-50" step="0.1"></div>
        </div>
        <div class="bg-${m.color}-50 p-4 rounded-xl border-2 border-${m.color}-200">
            <label class="text-sm text-${m.color}-700 font-bold block mb-2">üìÑ –®–ø–æ–Ω (—à—Ç)</label>
            <input type="number" value="${m.shpon}" onchange="updateP(${m.id},'shpon',this.value)" class="input-field w-full p-4 border-2 border-${m.color}-300 rounded-xl text-center font-bold text-${m.color}-700 text-2xl" placeholder="0" inputmode="numeric">
        </div>
        <div class="mt-3 text-right">
            <span class="bg-${m.color}-100 text-${m.color}-700 px-3 py-1 rounded-lg text-sm font-semibold">${calcPapelVol(m)} m¬≥</span>
        </div>
    </div>`).join('')}
    
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-4 text-white">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="bg-white/20 rounded-xl p-3 text-center">
                <div class="text-xs opacity-80">‚ÜîÔ∏è –ü–æ–ø–µ—Ä–µ—á–Ω—ã–π</div>
                <div class="text-xl font-bold">${parseInt(S.papel[0].shpon)||0} —à—Ç</div>
                <div class="text-sm">${calcPapelVol(S.papel[0])} m¬≥</div>
            </div>
            <div class="bg-white/20 rounded-xl p-3 text-center">
                <div class="text-xs opacity-80">‚ÜïÔ∏è –ü—Ä–æ–¥–æ–ª—å–Ω—ã–π</div>
                <div class="text-xl font-bold">${parseInt(S.papel[1].shpon)||0} —à—Ç</div>
                <div class="text-sm">${calcPapelVol(S.papel[1])} m¬≥</div>
            </div>
        </div>
        <div class="bg-white/30 rounded-xl p-3 text-center mb-3">
            <div class="text-sm">üìÑ –í—Å–µ–≥–æ –®–ø–æ–Ω</div>
            <div class="text-2xl font-bold">${totalShpon()} —à—Ç</div>
        </div>
        <div class="bg-white/30 rounded-xl p-3 text-center mb-3">
            <div class="text-sm">–û–±—â–∏–π –û–±—ä—ë–º</div>
            <div class="text-3xl font-bold">${grandPapelTotal()} m¬≥</div>
        </div>
        <button onclick="savePapel()" class="w-full bg-green-500 py-3 rounded-xl font-bold" ${S.saving ? 'disabled' : ''}>
            ${S.saving ? '<span class="spinner"></span> AI –∞–Ω–∞–ª–∏–∑...' : 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
        </button>
    </div>`;
}

function renderPapelReports(list) {
    // Calculate totals for period
    const totals = list.reduce((acc, r) => ({
        pop: acc.pop + (r.sokrasina_shpon || 0),
        prod: acc.prod + (r.suyuna_shpon || 0),
        shpon: acc.shpon + (r.total_shpon || 0),
        vol: acc.vol + parseFloat(r.gt || 0)
    }), { pop: 0, prod: 0, shpon: 0, vol: 0 });

    return `
    <div class="bg-white rounded-2xl shadow p-3 mb-3">
        <div class="grid grid-cols-3 gap-2 mb-2">
            <input type="date" value="${S.fStart}" onchange="S.fStart=this.value" class="p-2 border rounded-lg text-xs">
            <input type="date" value="${S.fEnd}" onchange="S.fEnd=this.value" class="p-2 border rounded-lg text-xs">
            <button onclick="applyFilter()" class="bg-indigo-500 text-white rounded-lg text-xs">–§–∏–ª—å—Ç—Ä</button>
        </div>
        <div class="flex gap-2">
            ${S.filtering ? '<button onclick="clearFilter()" class="flex-1 bg-gray-400 text-white py-2 rounded-lg text-xs">–í—Å–µ</button>' : ''}
            <button onclick="loadReports()" class="flex-1 bg-blue-500 text-white py-2 rounded-lg text-xs">üîÑ</button>
            <button onclick="exportP()" class="flex-1 bg-green-500 text-white py-2 rounded-lg text-xs">üìä Excel</button>
        </div>
    </div>
    
    ${list.length > 0 ? `
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-4 mb-3 text-white">
        <div class="text-center text-sm mb-2 opacity-80">üìä –ò—Ç–æ–≥–æ –∑–∞ –ø–µ—Ä–∏–æ–¥ (${list.length} –æ—Ç—á—ë—Ç–æ–≤)</div>
        <div class="grid grid-cols-3 gap-2 text-center">
            <div class="bg-white/20 rounded-xl p-2">
                <div class="text-xs opacity-80">‚ÜîÔ∏è –ü–æ–ø.</div>
                <div class="text-lg font-bold">${totals.pop}</div>
            </div>
            <div class="bg-white/20 rounded-xl p-2">
                <div class="text-xs opacity-80">‚ÜïÔ∏è –ü—Ä–æ–¥.</div>
                <div class="text-lg font-bold">${totals.prod}</div>
            </div>
            <div class="bg-white/20 rounded-xl p-2">
                <div class="text-xs opacity-80">–û–±—ä—ë–º</div>
                <div class="text-lg font-bold">${totals.vol.toFixed(3)} m¬≥</div>
            </div>
        </div>
        <div class="bg-white/30 rounded-xl p-2 mt-2 text-center">
            <span class="text-sm">üìÑ –í—Å–µ–≥–æ –®–ø–æ–Ω: </span>
            <span class="text-xl font-bold">${totals.shpon} —à—Ç</span>
        </div>
    </div>` : ''}
    
    ${S.loading ? '<div class="text-center py-8"><div class="spinner" style="border-top-color:#3B82F6;width:32px;height:32px"></div></div>' :
    list.length === 0 ? '<div class="bg-white rounded-2xl p-6 text-center text-gray-400">üìã –ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤</div>' :
    list.map(r => {
        const v = r.verifications || [];
        const hasAI = v.length > 0;
        const statusColor = r.verification_status === 'verified' ? 'green' : r.verification_status === 'mismatch' ? 'red' : 'gray';
        const statusIcon = r.verification_status === 'verified' ? '‚úÖ' : r.verification_status === 'mismatch' ? '‚ùå' : '‚ö™';
        
        return `
    <div class="bg-white rounded-2xl shadow p-4 mb-3 border-l-4 border-${statusColor}-400">
        <div class="flex justify-between items-start mb-3">
            <div>
                <div class="font-bold text-gray-800">${r.date}</div>
                <div class="text-sm text-gray-500">${r.shift === 'sabah' ? 'üåÖ –£—Ç—Ä–æ' : 'üåô –í–µ—á–µ—Ä'} ‚Ä¢ ${r.user_name}</div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-lg">${statusIcon}</span>
                ${S.user.isAdmin ? `<button onclick="deleteP(${r.id})" class="text-red-400 hover:text-red-600 p-1">üóëÔ∏è</button>` : ''}
            </div>
        </div>
        
        <div class="grid grid-cols-3 gap-2 mb-3">
            <div class="bg-blue-50 rounded-xl p-3 text-center">
                <div class="text-xs text-blue-600 mb-1">‚ÜîÔ∏è –ü–æ–ø–µ—Ä–µ—á–Ω—ã–π</div>
                <div class="text-xl font-bold text-blue-700">${r.sokrasina_shpon || 0}</div>
            </div>
            <div class="bg-green-50 rounded-xl p-3 text-center">
                <div class="text-xs text-green-600 mb-1">‚ÜïÔ∏è –ü—Ä–æ–¥–æ–ª—å–Ω—ã–π</div>
                <div class="text-xl font-bold text-green-700">${r.suyuna_shpon || 0}</div>
            </div>
            <div class="bg-indigo-50 rounded-xl p-3 text-center">
                <div class="text-xs text-indigo-600 mb-1">–û–±—ä—ë–º</div>
                <div class="text-xl font-bold text-indigo-700">${r.gt} m¬≥</div>
            </div>
        </div>
        
        <div class="bg-gray-50 rounded-xl p-2 text-center mb-2">
            <span class="text-sm text-gray-600">üìÑ –í—Å–µ–≥–æ: </span>
            <span class="font-bold text-gray-800">${r.total_shpon || 0} —à—Ç</span>
        </div>
        
        ${hasAI ? `
        <div class="border-t pt-3 mt-2">
            <div class="text-xs text-gray-500 mb-2">ü§ñ AI –ü—Ä–æ–≤–µ—Ä–∫–∞:</div>
            ${v.map(item => {
                const machName = item.type === 'poperechny' ? '‚ÜîÔ∏è –ü–æ–ø.' : '‚ÜïÔ∏è –ü—Ä–æ–¥.';
                const diff = item.diff !== null && item.diff !== undefined ? item.diff : '-';
                const itemColor = item.status === 'verified' ? 'green' : item.status === 'mismatch' ? 'red' : 'gray';
                const aiVal = item.aiRead !== null && item.aiRead !== undefined ? item.aiRead : '-';
                const entVal = item.entered !== null && item.entered !== undefined ? item.entered : '-';
                return `
                <div class="flex justify-between items-center text-sm bg-${itemColor}-50 rounded-lg p-2 mb-1">
                    <span class="text-gray-600">${machName}</span>
                    <span>–í–≤–æ–¥: <b>${entVal}</b></span>
                    <span>AI: <b>${aiVal}</b></span>
                    <span class="text-${itemColor}-600 font-semibold">Œî${diff}</span>
                </div>`;
            }).join('')}
        </div>` : ''}
    </div>`;
    }).join('')}`;
}

// EVENT HANDLERS
window.doLogin = function() {
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    const user = USERS[u];
    const err = document.getElementById('loginError');
    if (!user || user.password !== p) {
        err.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!';
        err.classList.add('show');
        return;
    }
    S.user = user;
    S.logged = true;
    render();
};

window.doLogout = function() {
    S.logged = false;
    S.user = null;
    S.proses = null;
    S.tab = 'entry';
    render();
};

window.selectProses = async function(id) {
    S.proses = id;
    S.tab = 'entry';
    render();
    await loadReports();
};

window.goBack = function() { S.proses = null; render(); };
window.setTab = function(t) { S.tab = t; render(); };
window.setShift = function(s) { S.shift = s; render(); };
window.setDate = function(d) { S.date = d; render(); };
window.applyFilter = function() { S.filtering = true; render(); };
window.clearFilter = function() { S.fStart = ''; S.fEnd = ''; S.filtering = false; render(); };

// KURUTMA HANDLERS
window.updateK = function(id, f, v) {
    S.kurutma = S.kurutma.map(m => m.id === id ? {...m, [f]: v} : m);
    render();
};

window.handleKPhoto = function(id, input) {
    const file = input.files[0];
    if (!file) return;
    S.kurutma = S.kurutma.map(m => m.id === id ? {...m, photo: file, preview: URL.createObjectURL(file)} : m);
    render();
};

window.clearKPhoto = function(id) {
    S.kurutma = S.kurutma.map(m => m.id === id ? {...m, photo: null, preview: null, aiResult: null} : m);
    render();
};

window.saveKurutma = async function() {
    S.saving = true;
    render();
    
    const photos = {}, aiResults = {}, verifications = [];
    
    for (const m of S.kurutma) {
        if (m.photo) {
            const url = await uploadPhoto(m.photo);
            if (url) {
                photos[m.id] = url;
                const ai = await analyzePhoto(url, 'kurutma');
                aiResults[m.id] = ai;
                m.aiResult = ai;
                const entered = parseInt(m.qp) || parseInt(m.qd) || 0;
                verifications.push({ machine: m.id, ...verify(entered, ai) });
            }
        }
    }
    
    const hasAny = verifications.length > 0;
    const hasMismatch = verifications.some(v => v.status === 'mismatch');
    const status = !hasAny ? 'unknown' : hasMismatch ? 'mismatch' : 'verified';
    
    const report = {
        date: S.date + ' ' + new Date().toTimeString().slice(0, 5),
        shift: S.shift,
        user_name: S.user.name,
        machines: S.kurutma.map(m => ({ id: m.id, en: m.en, boy: m.boy, kalinlik: m.kalinlik, qp: m.qp, qd: m.qd })),
        tvp: totalVol('p'), tvd: totalVol('d'),
        tqp: totalQty('p'), tqd: totalQty('d'),
        gt: grandTotal(),
        photos, ai_results: aiResults,
        verification_status: status,
        verifications
    };
    
    if (navigator.onLine) {
        const { error } = await db.from('reports').insert([report]);
        if (!error) { showSync(); await loadReports(); }
        else { savePending({ type: 'kurutma', data: report }); }
    } else {
        savePending({ type: 'kurutma', data: report });
    }
    
    S.kurutma = createKurutma();
    S.saving = false;
    render();
    showToast();
};

window.deleteK = async function(id) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
        await db.from('reports').delete().eq('id', id);
        loadReports();
    }
};

window.exportK = function() {
    let csv = '\uFEFF' + '–î–∞—Ç–∞,–°–º–µ–Ω–∞,–û–ø–µ—Ä–∞—Ç–æ—Ä,–ü–æ–ø,–ü—Ä–æ–¥,–û–±—ä—ë–º\n';
    const list = S.filtering ? S.reports.filter(r => {
        const d = r.date?.split(' ')[0];
        return (!S.fStart || d >= S.fStart) && (!S.fEnd || d <= S.fEnd);
    }) : S.reports;
    list.forEach(r => { csv += `${r.date},${r.shift},${r.user_name},${r.tqp},${r.tqd},${r.gt}\n`; });
    downloadCSV(csv, 'kurutma');
};

// PAPEL HANDLERS
window.updateP = function(id, f, v) {
    S.papel = S.papel.map(m => m.id === id ? {...m, [f]: v} : m);
    render();
};

window.handlePPhoto = function(id, input) {
    const file = input.files[0];
    if (!file) return;
    S.papel = S.papel.map(m => m.id === id ? {...m, photo: file, preview: URL.createObjectURL(file)} : m);
    render();
};

window.clearPPhoto = function(id) {
    S.papel = S.papel.map(m => m.id === id ? {...m, photo: null, preview: null, aiResult: null} : m);
    render();
};

window.savePapel = async function() {
    S.saving = true;
    render();
    
    const photos = {}, aiResults = {}, verifications = [];
    
    for (const m of S.papel) {
        if (m.photo) {
            const url = await uploadPhoto(m.photo);
            if (url) {
                photos[m.id] = url;
                const ai = await analyzePhoto(url, 'papel');
                aiResults[m.id] = ai;
                m.aiResult = ai;
                const entered = parseInt(m.shpon) || 0;
                verifications.push({ machine: m.id, type: m.type, ...verify(entered, ai) });
            }
        }
    }
    
    const hasAny = verifications.length > 0;
    const hasMismatch = verifications.some(v => v.status === 'mismatch');
    const status = !hasAny ? 'unknown' : hasMismatch ? 'mismatch' : 'verified';
    
    const report = {
        date: S.date + ' ' + new Date().toTimeString().slice(0, 5),
        shift: S.shift,
        user_name: S.user.name,
        machines: S.papel.map(m => ({ id: m.id, type: m.type, en: m.en, boy: m.boy, kalinlik: m.kalinlik, shpon: m.shpon })),
        sokrasina_shpon: parseInt(S.papel[0].shpon) || 0,
        suyuna_shpon: parseInt(S.papel[1].shpon) || 0,
        total_shpon: totalShpon(),
        gt: grandPapelTotal(),
        photos, ai_results: aiResults,
        verification_status: status,
        verifications
    };
    
    if (navigator.onLine) {
        const { error } = await db.from('papel_ekleme_reports').insert([report]);
        if (!error) { showSync(); await loadReports(); }
        else { savePending({ type: 'papel', data: report }); }
    } else {
        savePending({ type: 'papel', data: report });
    }
    
    S.papel = createPapel();
    S.saving = false;
    render();
    showToast();
};

window.deleteP = async function(id) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
        await db.from('papel_ekleme_reports').delete().eq('id', id);
        loadReports();
    }
};

window.exportP = function() {
    let csv = '\uFEFF' + '–î–∞—Ç–∞,–°–º–µ–Ω–∞,–û–ø–µ—Ä–∞—Ç–æ—Ä,–ü–æ–ø_—à–ø–æ–Ω,–ü—Ä–æ–¥_—à–ø–æ–Ω,–í—Å–µ–≥–æ,–û–±—ä—ë–º\n';
    const list = S.filtering ? S.papelReports.filter(r => {
        const d = r.date?.split(' ')[0];
        return (!S.fStart || d >= S.fStart) && (!S.fEnd || d <= S.fEnd);
    }) : S.papelReports;
    list.forEach(r => { csv += `${r.date},${r.shift},${r.user_name},${r.sokrasina_shpon||0},${r.suyuna_shpon||0},${r.total_shpon||0},${r.gt}\n`; });
    downloadCSV(csv, 'papel');
};

// UTILS
function downloadCSV(csv, name) {
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = name + '_' + new Date().toISOString().split('T')[0] + '.csv';
    link.click();
}

// START APP
render();
</script>
</body>
</html>
