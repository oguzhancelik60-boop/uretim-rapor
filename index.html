<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="Fabrika Ã¼retim takip ve raporlama sistemi">
    <title>Ãœretim Rapor Sistemi</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ãœretim Rapor">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%234F46E5' width='100' height='100' rx='20'/><text x='50' y='68' text-anchor='middle' font-size='50'>ğŸ­</text></svg>">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .input-field { font-size: 16px !important; }
        
        /* PWA Install Banner */
        .install-banner {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(79, 70, 229, 0.4);
            z-index: 1000;
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Offline indicator */
        .offline-badge {
            display: none;
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #EF4444;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        .offline-badge.show { display: flex; align-items: center; gap: 8px; }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Sync indicator */
        .sync-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #10B981;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001;
            display: none;
        }
        .sync-badge.show { display: flex; align-items: center; gap: 6px; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Offline Badge -->
    <div id="offlineBadge" class="offline-badge">
        <span>ğŸ“´</span> Ã‡evrimdÄ±ÅŸÄ± Mod
    </div>
    
    <!-- Sync Badge -->
    <div id="syncBadge" class="sync-badge">
        <span>â˜ï¸</span> Senkronize
    </div>
    
    <!-- PWA Install Banner -->
    <div id="installBanner" class="install-banner">
        <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="text-3xl">ğŸ­</div>
                <div>
                    <div class="font-bold">UygulamayÄ± YÃ¼kle</div>
                    <div class="text-sm opacity-90">Ana ekrana ekle, offline kullan</div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="hideInstallBanner()" class="px-4 py-2 rounded-lg bg-white/20 hover:bg-white/30 transition-all">Sonra</button>
                <button onclick="installPWA()" class="px-4 py-2 rounded-lg bg-white text-indigo-600 font-bold hover:bg-gray-100 transition-all">YÃ¼kle</button>
            </div>
        </div>
    </div>

    <div id="app"></div>
    
    <script>
    // ==================== SUPABASE CONFIG ====================
    const SUPABASE_URL = 'https://exxznkibcoyaemlqmcon.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eHpua2liY295YWVtbHFtY29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMTk4MzMsImV4cCI6MjA4MzY5NTgzM30.AqAud6Mo6x1sy7FB_at8f2BnTZSVsytXHXC_b5WX0yQ';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ==================== PWA SETUP ====================
    let deferredPrompt;
    
    // Service Worker kayÄ±t
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then((registration) => {
                    console.log('SW registered:', registration.scope);
                })
                .catch((error) => {
                    console.log('SW registration failed:', error);
                });
        });
    }
    
    // PWA Install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if (!localStorage.getItem('pwaInstallDismissed')) {
            setTimeout(() => {
                document.getElementById('installBanner').style.display = 'block';
            }, 3000);
        }
    });
    
    window.installPWA = () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('PWA installed');
                }
                deferredPrompt = null;
                document.getElementById('installBanner').style.display = 'none';
            });
        }
    };
    
    window.hideInstallBanner = () => {
        document.getElementById('installBanner').style.display = 'none';
        localStorage.setItem('pwaInstallDismissed', 'true');
    };
    
    // Online/Offline status
    function updateOnlineStatus() {
        const badge = document.getElementById('offlineBadge');
        if (!navigator.onLine) {
            badge.classList.add('show');
        } else {
            badge.classList.remove('show');
        }
    }
    
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
    
    // ==================== APP CODE ====================
    
    const STANDART_OLCULER = {
        en: '1250',
        boy: '2500',
        kalinlik: '1.5'
    };

    const USERS = {
        'yonetici': { password: 'admin123', role: 'YÃ¶netici', name: 'YÃ¶netici', isAdmin: true, permissions: ['agac_kabul','papel_soyma','kurutma','papel_ekleme','tutkallama','depo'] },
        'ali': { password: 'ali123', role: 'OperatÃ¶r', name: 'Ali', isAdmin: false, permissions: ['kurutma'] },
        'mehmet': { password: 'mehmet123', role: 'OperatÃ¶r', name: 'Mehmet', isAdmin: false, permissions: ['kurutma','papel_soyma'] },
        'ayse': { password: 'ayse123', role: 'OperatÃ¶r', name: 'AyÅŸe', isAdmin: false, permissions: ['agac_kabul','depo'] }
    };

    const PROSESLER = [
        { id: 'agac_kabul', name: { tr: 'AÄŸaÃ§ Kabul', ru: 'ĞŸÑ€Ğ¸Ñ‘Ğ¼ Ğ”ĞµÑ€ĞµĞ²Ğ°', kk: 'ĞÒ“Ğ°Ñˆ Ò›Ğ°Ğ±Ñ‹Ğ»Ğ´Ğ°Ñƒ' }, icon: 'ğŸŒ³', color: 'bg-green-500', active: false },
        { id: 'papel_soyma', name: { tr: 'Papel Soyma', ru: 'Ğ ĞµĞ·ĞºĞ° Ğ¨Ğ¿Ğ¾Ğ½Ğ°', kk: 'ÒšĞ°Ğ±Ğ°Ñ‚ ĞºĞµÑÑƒ' }, icon: 'âœ‚ï¸', color: 'bg-yellow-500', active: false },
        { id: 'kurutma', name: { tr: 'Kurutma', ru: 'Ğ¡ÑƒÑˆĞºĞ°', kk: 'ĞšĞµĞ¿Ñ‚Ñ–Ñ€Ñƒ' }, icon: 'ğŸ”¥', color: 'bg-orange-500', active: true },
        { id: 'papel_ekleme', name: { tr: 'Papel Ekleme', ru: 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¨Ğ¿Ğ¾Ğ½Ğ°', kk: 'ÒšĞ°Ğ±Ğ°Ñ‚ Ò›Ğ¾ÑÑƒ' }, icon: 'â•', color: 'bg-blue-500', active: false },
        { id: 'tutkallama', name: { tr: 'Tutkallama', ru: 'Ğ¡ĞºĞ»ĞµĞ¸Ğ²Ğ°Ğ½Ğ¸Ğµ', kk: 'Ğ–ĞµĞ»Ñ–Ğ¼Ğ´ĞµÑƒ' }, icon: 'ğŸ’§', color: 'bg-purple-500', active: false },
        { id: 'depo', name: { tr: 'Depo', ru: 'Ğ¡ĞºĞ»Ğ°Ğ´', kk: 'ÒšĞ¾Ğ¹Ğ¼Ğ°' }, icon: 'ğŸ“¦', color: 'bg-indigo-500', active: false }
    ];

    function createDefaultMachines() {
        return [
            { id: 1, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '' },
            { id: 2, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '' },
            { id: 3, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '' },
            { id: 4, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '' }
        ];
    }

    let state = {
        lang: localStorage.getItem('lang') || 'tr',
        loggedIn: false,
        user: null,
        activeProses: null,
        tab: 'giris',
        shift: 'sabah',
        date: new Date().toISOString().split('T')[0],
        machines: createDefaultMachines(),
        reports: [],
        filterStart: '',
        filterEnd: '',
        filtering: false,
        loading: false
    };

    const T = {
        tr: { title: 'Ãœretim Rapor Sistemi', login: 'GiriÅŸ Yap', logout: 'Ã‡Ä±kÄ±ÅŸ', username: 'KullanÄ±cÄ± AdÄ±', password: 'Åifre', welcome: 'HoÅŸ geldiniz', dataEntry: 'Veri GiriÅŸi', reports: 'Raporlar', settings: 'Ayarlar', shift: 'Vardiya', morning: 'Sabah', evening: 'AkÅŸam', machine: 'Makine', width: 'En', length: 'Boy', thickness: 'KalÄ±nlÄ±k', poperechny: 'ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹', prodolny: 'ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹', save: 'Raporu Kaydet', saved: 'Rapor kaydedildi!', total: 'Toplam', grandTotal: 'Genel Toplam', volume: 'Hacim', qty: 'Adet', noReports: 'HenÃ¼z rapor yok', deleteAll: 'TÃ¼mÃ¼nÃ¼ Sil', confirmDelete: 'Emin misiniz?', filter: 'Filtrele', showAll: 'TÃ¼mÃ¼', startDate: 'BaÅŸlangÄ±Ã§', endDate: 'BitiÅŸ', exportExcel: 'Excel', reportDate: 'Rapor Tarihi', demo: 'Demo KullanÄ±cÄ±lar', back: 'Geri', comingSoon: 'YakÄ±nda Aktif', noPermission: 'Yetkiniz Yok', open: 'GiriÅŸ Yap', fullAccess: 'TÃ¼m eriÅŸim', onlyDrying: 'Sadece Kurutma', mm: 'mm', dimensions: 'Ã–lÃ§Ã¼ler', quantities: 'Papel SayÄ±larÄ±', standard: 'Standart', loading: 'YÃ¼kleniyor...', saving: 'Kaydediliyor...', synced: 'Senkronize edildi' },
        ru: { title: 'Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ĞÑ‚Ñ‡Ñ‘Ñ‚Ğ¾Ğ²', login: 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸', logout: 'Ğ’Ñ‹Ñ…Ğ¾Ğ´', username: 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ', password: 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ', welcome: 'Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ', dataEntry: 'Ğ’Ğ²Ğ¾Ğ´ Ğ”Ğ°Ğ½Ğ½Ñ‹Ñ…', reports: 'ĞÑ‚Ñ‡Ñ‘Ñ‚Ñ‹', settings: 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸', shift: 'Ğ¡Ğ¼ĞµĞ½Ğ°', morning: 'Ğ£Ñ‚Ñ€ĞµĞ½Ğ½ÑÑ', evening: 'Ğ’ĞµÑ‡ĞµÑ€Ğ½ÑÑ', machine: 'ĞœĞ°ÑˆĞ¸Ğ½Ğ°', width: 'Ğ¨Ğ¸Ñ€Ğ¸Ğ½Ğ°', length: 'Ğ”Ğ»Ğ¸Ğ½Ğ°', thickness: 'Ğ¢Ğ¾Ğ»Ñ‰Ğ¸Ğ½Ğ°', poperechny: 'ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹', prodolny: 'ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹', save: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ', saved: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾!', total: 'Ğ˜Ñ‚Ğ¾Ğ³Ğ¾', grandTotal: 'ĞĞ±Ñ‰Ğ¸Ğ¹ ĞĞ±ÑŠÑ‘Ğ¼', volume: 'ĞĞ±ÑŠÑ‘Ğ¼', qty: 'ĞšĞ¾Ğ»-Ğ²Ğ¾', noReports: 'ĞĞµÑ‚ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ¾Ğ²', deleteAll: 'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ', confirmDelete: 'Ğ’Ñ‹ ÑƒĞ²ĞµÑ€ĞµĞ½Ñ‹?', filter: 'Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€', showAll: 'Ğ’ÑĞµ', startDate: 'ĞĞ°Ñ‡Ğ°Ğ»Ğ¾', endDate: 'ĞšĞ¾Ğ½ĞµÑ†', exportExcel: 'Excel', reportDate: 'Ğ”Ğ°Ñ‚Ğ° ĞÑ‚Ñ‡Ñ‘Ñ‚Ğ°', demo: 'Ğ”ĞµĞ¼Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸', back: 'ĞĞ°Ğ·Ğ°Ğ´', comingSoon: 'Ğ¡ĞºĞ¾Ñ€Ğ¾', noPermission: 'ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°', open: 'ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ', fullAccess: 'ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿', onlyDrying: 'Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¡ÑƒÑˆĞºĞ°', mm: 'Ğ¼Ğ¼', dimensions: 'Ğ Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹', quantities: 'ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾', standard: 'Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚', loading: 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...', saving: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ...', synced: 'Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾' },
        kk: { title: 'Ğ•ÑĞµĞ¿ Ğ–Ò¯Ğ¹ĞµÑÑ–', login: 'ĞšÑ–Ñ€Ñƒ', logout: 'Ğ¨Ñ‹Ò“Ñƒ', username: 'ĞŸĞ°Ğ¹Ğ´Ğ°Ğ»Ğ°Ğ½ÑƒÑˆÑ‹', password: 'ÒšÒ±Ğ¿Ğ¸Ñ ÑÓ©Ğ·', welcome: 'ÒšĞ¾Ñˆ ĞºĞµĞ»Ğ´Ñ–Ò£Ñ–Ğ·', dataEntry: 'Ğ”ĞµÑ€ĞµĞºÑ‚ĞµÑ€', reports: 'Ğ•ÑĞµĞ¿Ñ‚ĞµÑ€', settings: 'Ğ‘Ğ°Ğ¿Ñ‚Ğ°ÑƒĞ»Ğ°Ñ€', shift: 'ĞÑƒÑ‹ÑÑ‹Ğ¼', morning: 'Ğ¢Ğ°Ò£Ò“Ñ‹', evening: 'ĞšĞµÑˆĞºÑ–', machine: 'ĞœĞ°ÑˆĞ¸Ğ½Ğ°', width: 'Ğ•Ğ½Ñ–', length: 'Ò°Ğ·Ñ‹Ğ½Ğ´Ñ‹Ò“Ñ‹', thickness: 'ÒšĞ°Ğ»Ñ‹Ò£Ğ´Ñ‹Ò“Ñ‹', poperechny: 'ĞšÓ©Ğ»Ğ´ĞµĞ½ĞµÒ£', prodolny: 'Ğ‘Ğ¾Ğ¹Ğ»Ñ‹Ò›', save: 'Ğ¡Ğ°Ò›Ñ‚Ğ°Ñƒ', saved: 'Ğ¡Ğ°Ò›Ñ‚Ğ°Ğ»Ğ´Ñ‹!', total: 'Ğ–Ğ¸Ñ‹Ğ½Ñ‹', grandTotal: 'Ğ–Ğ°Ğ»Ğ¿Ñ‹ ĞšÓ©Ğ»ĞµĞ¼', volume: 'ĞšÓ©Ğ»ĞµĞ¼', qty: 'Ğ¡Ğ°Ğ½Ñ‹', noReports: 'Ğ•ÑĞµĞ¿ Ğ¶Ğ¾Ò›', deleteAll: 'Ğ‘Ğ°Ñ€Ğ»Ñ‹Ò“Ñ‹Ğ½ Ğ¶Ğ¾Ñ', confirmDelete: 'Ğ¡ĞµĞ½Ñ–Ğ¼Ğ´Ñ–ÑÑ–Ğ· Ğ±Ğµ?', filter: 'Ğ¡Ò¯Ğ·Ñƒ', showAll: 'Ğ‘Ğ°Ñ€Ğ»Ñ‹Ò“Ñ‹', startDate: 'Ğ‘Ğ°ÑÑ‹', endDate: 'Ğ¡Ğ¾Ò£Ñ‹', exportExcel: 'Excel', reportDate: 'Ğ•ÑĞµĞ¿ ĞšÒ¯Ğ½Ñ–', demo: 'Ğ”ĞµĞ¼Ğ¾', back: 'ĞÑ€Ñ‚Ò›Ğ°', comingSoon: 'Ğ–Ğ°Ò›Ñ‹Ğ½Ğ´Ğ°', noPermission: 'Ğ Ò±Ò›ÑĞ°Ñ‚ Ğ¶Ğ¾Ò›', open: 'ĞÑˆÑƒ', fullAccess: 'Ğ¢Ğ¾Ğ»Ñ‹Ò› Ò›Ğ¾Ğ» Ğ¶ĞµÑ‚ĞºÑ–Ğ·Ñƒ', onlyDrying: 'Ğ¢ĞµĞº ĞšĞµĞ¿Ñ‚Ñ–Ñ€Ñƒ', mm: 'Ğ¼Ğ¼', dimensions: 'Ó¨Ğ»ÑˆĞµĞ¼Ğ´ĞµÑ€', quantities: 'Ğ¡Ğ°Ğ½Ñ‹', standard: 'Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚', loading: 'Ğ–Ò¯ĞºÑ‚ĞµĞ»ÑƒĞ´Ğµ...', saving: 'Ğ¡Ğ°Ò›Ñ‚Ğ°Ğ»ÑƒĞ´Ğ°...', synced: 'Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ´Ğ°Ğ»Ğ´Ñ‹' }
    };

    const t = (key) => T[state.lang][key] || key;
    const hasPermission = (prosesId) => state.user && state.user.permissions.includes(prosesId);

    function calcVol(m, type) {
        const en = parseFloat(m.en) || 0;
        const boy = parseFloat(m.boy) || 0;
        const kalinlik = parseFloat(m.kalinlik) || 0;
        const qty = parseFloat(type === 'p' ? m.qp : m.qd) || 0;
        return ((en/1000) * (boy/1000) * (kalinlik/1000) * qty).toFixed(3);
    }

    function totalVol(type) { return state.machines.reduce((sum, m) => sum + parseFloat(calcVol(m, type)), 0).toFixed(3); }
    function totalQty(type) { return state.machines.reduce((sum, m) => sum + (parseFloat(type === 'p' ? m.qp : m.qd) || 0), 0); }
    function grandTotal() { return (parseFloat(totalVol('p')) + parseFloat(totalVol('d'))).toFixed(3); }

    // ==================== SUPABASE FUNCTIONS ====================
    
    async function loadReports() {
        state.loading = true;
        render();
        
        try {
            const { data, error } = await supabase
                .from('reports')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            // Supabase verisini uygulama formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼r
            state.reports = data.map(r => ({
                id: r.id,
                date: r.date,
                shift: r.shift,
                user: r.user_name,
                machines: r.machines,
                tvp: r.tvp,
                tvd: r.tvd,
                tqp: r.tqp,
                tqd: r.tqd,
                gt: r.gt
            }));
            
            showSyncBadge();
        } catch (error) {
            console.error('Raporlar yÃ¼klenirken hata:', error);
            // Offline ise localStorage'dan yÃ¼kle
            state.reports = JSON.parse(localStorage.getItem('reports') || '[]');
        }
        
        state.loading = false;
        render();
    }
    
    async function saveReportToSupabase(report) {
        try {
            const { data, error } = await supabase
                .from('reports')
                .insert([{
                    date: report.date,
                    shift: report.shift,
                    user_name: report.user,
                    machines: report.machines,
                    tvp: report.tvp,
                    tvd: report.tvd,
                    tqp: report.tqp,
                    tqd: report.tqd,
                    gt: report.gt
                }])
                .select();
            
            if (error) throw error;
            
            showSyncBadge();
            return data[0];
        } catch (error) {
            console.error('Rapor kaydedilirken hata:', error);
            // Offline ise localStorage'a kaydet
            const reports = JSON.parse(localStorage.getItem('reports') || '[]');
            reports.push(report);
            localStorage.setItem('reports', JSON.stringify(reports));
            return null;
        }
    }
    
    async function deleteReportFromSupabase(id) {
        try {
            const { error } = await supabase
                .from('reports')
                .delete()
                .eq('id', id);
            
            if (error) throw error;
            showSyncBadge();
        } catch (error) {
            console.error('Rapor silinirken hata:', error);
        }
    }
    
    async function deleteAllReportsFromSupabase() {
        try {
            const { error } = await supabase
                .from('reports')
                .delete()
                .neq('id', 0); // TÃ¼mÃ¼nÃ¼ sil
            
            if (error) throw error;
            showSyncBadge();
        } catch (error) {
            console.error('Raporlar silinirken hata:', error);
        }
    }
    
    function showSyncBadge() {
        const badge = document.getElementById('syncBadge');
        badge.classList.add('show');
        setTimeout(() => badge.classList.remove('show'), 2000);
    }

    function exportExcel(rpts) {
        let csv = '\uFEFF' + `Tarih,Vardiya,KullanÄ±cÄ±,Makine,En,Boy,KalÄ±nlÄ±k,ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹ Adet,ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹ mÂ³,ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ Adet,ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ mÂ³\n`;
        rpts.forEach(r => {
            r.machines.forEach(m => { csv += `${r.date},${r.shift},${r.user},Makine ${m.id},${m.en},${m.boy},${m.kalinlik},${m.qp},${m.vp},${m.qd},${m.vd}\n`; });
            csv += `${r.date},${r.shift},${r.user},TOPLAM,,,,${r.tqp},${r.tvp},${r.tqd},${r.tvd}\n\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'rapor_' + new Date().toISOString().split('T')[0] + '.csv';
        link.click();
    }

    function shareWhatsApp(r) {
        let msg = `*ğŸ­ ${t('title')}*\n\nğŸ“… ${r.date}\nâ° ${r.shift === 'sabah' ? t('morning') : t('evening')}\nğŸ‘¤ ${r.user}\n\n`;
        r.machines.forEach(m => { 
            msg += `*${t('machine')} ${m.id}*\n`;
            msg += `ğŸ“ ${m.en}Ã—${m.boy}Ã—${m.kalinlik} mm\n`;
            msg += `ğŸ”µ ${t('poperechny')}: ${m.qp} ${t('qty')} (${m.vp} mÂ³)\n`;
            msg += `ğŸŸ¢ ${t('prodolny')}: ${m.qd} ${t('qty')} (${m.vd} mÂ³)\n\n`; 
        });
        msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        msg += `ğŸ”µ ${t('poperechny')}: ${r.tqp} ${t('qty')} â†’ ${r.tvp} mÂ³\n`;
        msg += `ğŸŸ¢ ${t('prodolny')}: ${r.tqd} ${t('qty')} â†’ ${r.tvd} mÂ³\n`;
        msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        msg += `ğŸ“Š *${t('grandTotal')}: ${r.gt} mÂ³*`;
        window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
    }

    function isStandard(m) {
        return m.en === STANDART_OLCULER.en && 
               m.boy === STANDART_OLCULER.boy && 
               m.kalinlik === STANDART_OLCULER.kalinlik;
    }

    function render() {
        const app = document.getElementById('app');
        
        // LOGIN SCREEN
        if (!state.loggedIn) {
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-800 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
                        <div class="text-center mb-8">
                            <div class="text-7xl mb-4">ğŸ­</div>
                            <h1 class="text-2xl font-bold text-gray-800">${t('title')}</h1>
                            <p class="text-sm text-green-600 mt-2">â˜ï¸ Bulut Senkronizasyonlu</p>
                            <div class="flex justify-center gap-3 mt-5">
                                <button onclick="changeLang('tr')" class="px-4 py-2 rounded-lg text-lg transition-all ${state.lang==='tr'?'bg-indigo-600 text-white shadow-lg scale-110':'bg-gray-100 hover:bg-gray-200'}">ğŸ‡¹ğŸ‡·</button>
                                <button onclick="changeLang('ru')" class="px-4 py-2 rounded-lg text-lg transition-all ${state.lang==='ru'?'bg-indigo-600 text-white shadow-lg scale-110':'bg-gray-100 hover:bg-gray-200'}">ğŸ‡·ğŸ‡º</button>
                                <button onclick="changeLang('kk')" class="px-4 py-2 rounded-lg text-lg transition-all ${state.lang==='kk'?'bg-indigo-600 text-white shadow-lg scale-110':'bg-gray-100 hover:bg-gray-200'}">ğŸ‡°ğŸ‡¿</button>
                            </div>
                        </div>
                        <div id="loginError" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center"></div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">${t('username')}</label>
                                <input id="username" type="text" class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="${t('username')}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">${t('password')}</label>
                                <input id="password" type="password" class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" placeholder="${t('password')}">
                            </div>
                            <button onclick="login()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg hover:shadow-xl">${t('login')}</button>
                        </div>
                        <div class="mt-8 p-4 bg-gray-50 rounded-xl text-sm text-gray-600">
                            <p class="font-bold mb-2 text-gray-700">${t('demo')}:</p>
                            <p class="mb-1">â€¢ <span class="font-mono bg-gray-200 px-2 py-0.5 rounded">yonetici</span> / <span class="font-mono bg-gray-200 px-2 py-0.5 rounded">admin123</span></p>
                            <p>â€¢ <span class="font-mono bg-gray-200 px-2 py-0.5 rounded">ali</span> / <span class="font-mono bg-gray-200 px-2 py-0.5 rounded">ali123</span></p>
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        // MAIN MENU
        if (!state.activeProses) {
            let prosesHTML = PROSESLER.map(p => {
                const hasAccess = hasPermission(p.id);
                return `
                    <div onclick="${hasAccess && p.active ? `selectProses('${p.id}')` : ''}" 
                         class="bg-white rounded-2xl shadow-lg p-6 transition-all ${hasAccess && p.active ? 'cursor-pointer hover:shadow-xl hover:scale-102 active:scale-98' : ''} ${!hasAccess ? 'opacity-50' : ''} ${!p.active ? 'border-2 border-dashed border-gray-300' : 'border-2 border-transparent'}">
                        <div class="flex items-center gap-4">
                            <div class="${p.color} w-16 h-16 rounded-xl flex items-center justify-center text-3xl shadow-lg">${p.icon}</div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800">${p.name[state.lang]}</h3>
                                ${!p.active ? `<p class="text-sm text-amber-600 mt-1 font-medium">â³ ${t('comingSoon')}</p>` : ''}
                                ${!hasAccess && p.active ? `<p class="text-sm text-red-500 mt-1 font-medium">ğŸ”’ ${t('noPermission')}</p>` : ''}
                                ${hasAccess && p.active ? `<p class="text-sm text-green-600 mt-1 font-medium">âœ“ ${t('open')}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-100 to-indigo-100">
                    <div class="bg-white shadow-lg">
                        <div class="max-w-6xl mx-auto p-4">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div>
                                    <h1 class="text-2xl md:text-3xl font-bold text-indigo-900">ğŸ­ ${t('title')}</h1>
                                    <p class="text-gray-600 mt-1">${t('welcome')}, <span class="font-semibold">${state.user.name}</span></p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex bg-gray-100 rounded-lg p-1">
                                        <button onclick="changeLang('tr')" class="px-3 py-1.5 rounded-md transition-all ${state.lang==='tr'?'bg-white shadow text-indigo-700 font-bold':'text-gray-600'}">ğŸ‡¹ğŸ‡·</button>
                                        <button onclick="changeLang('ru')" class="px-3 py-1.5 rounded-md transition-all ${state.lang==='ru'?'bg-white shadow text-indigo-700 font-bold':'text-gray-600'}">ğŸ‡·ğŸ‡º</button>
                                        <button onclick="changeLang('kk')" class="px-3 py-1.5 rounded-md transition-all ${state.lang==='kk'?'bg-white shadow text-indigo-700 font-bold':'text-gray-600'}">ğŸ‡°ğŸ‡¿</button>
                                    </div>
                                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-all">${t('logout')}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="max-w-6xl mx-auto p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${prosesHTML}
                        </div>
                    </div>
                </div>
            `;
            return;
        }

        // KURUTMA SCREEN
        const filteredReports = state.filtering ? state.reports.filter(r => {
            const dateStr = r.date.split(' ')[0];
            return (!state.filterStart || dateStr >= state.filterStart) && 
                   (!state.filterEnd || dateStr <= state.filterEnd);
        }) : state.reports;

        let machinesHTML = state.machines.map(m => {
            const isStd = isStandard(m);
            return `
            <div class="bg-white rounded-2xl shadow-lg p-5 mb-4 border-l-4 border-orange-400">
                <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="bg-orange-100 text-orange-600 w-10 h-10 rounded-xl flex items-center justify-center font-bold text-lg">${m.id}</div>
                        <span class="font-bold text-lg text-gray-800">${t('machine')} ${m.id}</span>
                        ${isStd ? `<span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded-full font-semibold">âœ“ ${t('standard')}</span>` : `<span class="bg-amber-100 text-amber-700 text-xs px-2 py-1 rounded-full font-semibold">âš¡ Ã–zel</span>`}
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500 mb-1">${t('volume')}</div>
                        <div class="flex gap-2">
                            <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-lg text-sm font-semibold">${calcVol(m,'p')} mÂ³</span>
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded-lg text-sm font-semibold">${calcVol(m,'d')} mÂ³</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider">ğŸ“ ${t('dimensions')} (${t('mm')})</div>
                        ${!isStd ? `<button onclick="resetToStandard(${m.id})" class="text-xs bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1 rounded-lg transition-all">â†º ${t('standard')}</button>` : ''}
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">${t('width')}</label>
                            <input type="number" value="${m.en}" onchange="updateMachine(${m.id},'en',this.value)" 
                                   class="input-field w-full p-3 border-2 ${isStd ? 'border-emerald-200 bg-emerald-50' : 'border-amber-200 bg-amber-50'} rounded-xl text-center font-semibold focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" 
                                   inputmode="numeric" placeholder="1250">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">${t('length')}</label>
                            <input type="number" value="${m.boy}" onchange="updateMachine(${m.id},'boy',this.value)" 
                                   class="input-field w-full p-3 border-2 ${isStd ? 'border-emerald-200 bg-emerald-50' : 'border-amber-200 bg-amber-50'} rounded-xl text-center font-semibold focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" 
                                   inputmode="numeric" placeholder="2500">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">${t('thickness')}</label>
                            <input type="number" value="${m.kalinlik}" onchange="updateMachine(${m.id},'kalinlik',this.value)" 
                                   class="input-field w-full p-3 border-2 ${isStd ? 'border-emerald-200 bg-emerald-50' : 'border-amber-200 bg-amber-50'} rounded-xl text-center font-semibold focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" 
                                   inputmode="decimal" placeholder="1.5" step="0.1">
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">ğŸ“¦ ${t('quantities')}</div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-blue-50 rounded-xl p-3 border-2 border-blue-200">
                            <label class="block text-xs text-blue-700 font-bold mb-1">${t('poperechny')}</label>
                            <input type="number" value="${m.qp}" onchange="updateMachine(${m.id},'qp',this.value)" 
                                   class="input-field w-full p-3 bg-white border-2 border-blue-300 rounded-xl text-center font-bold text-blue-700 text-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200" 
                                   inputmode="numeric" placeholder="0">
                        </div>
                        <div class="bg-green-50 rounded-xl p-3 border-2 border-green-200">
                            <label class="block text-xs text-green-700 font-bold mb-1">${t('prodolny')}</label>
                            <input type="number" value="${m.qd}" onchange="updateMachine(${m.id},'qd',this.value)" 
                                   class="input-field w-full p-3 bg-white border-2 border-green-300 rounded-xl text-center font-bold text-green-700 text-lg focus:border-green-500 focus:ring-2 focus:ring-green-200" 
                                   inputmode="numeric" placeholder="0">
                        </div>
                    </div>
                </div>
            </div>
        `}).join('');

        let reportsHTML = state.loading ? `
            <div class="bg-white rounded-2xl shadow p-8 text-center">
                <div class="spinner mx-auto mb-4" style="border-top-color: #4F46E5; width: 40px; height: 40px;"></div>
                <p class="text-gray-500">${t('loading')}</p>
            </div>
        ` : filteredReports.length === 0 ? `
            <div class="bg-white rounded-2xl shadow p-8 text-center">
                <div class="text-6xl mb-4">ğŸ“‹</div>
                <p class="text-gray-500">${t('noReports')}</p>
            </div>
        ` : filteredReports.map(r => `
            <div class="bg-white rounded-2xl shadow-lg p-5 mb-4">
                <div class="flex justify-between items-start mb-4 pb-3 border-b border-gray-100">
                    <div>
                        <div class="font-bold text-lg text-gray-800">${r.date}</div>
                        <div class="text-sm text-gray-500 mt-1">
                            <span class="inline-flex items-center gap-1">${r.shift === 'sabah' ? 'ğŸŒ…' : 'ğŸŒ™'} ${r.shift === 'sabah' ? t('morning') : t('evening')}</span>
                            <span class="mx-2">â€¢</span>
                            <span>ğŸ‘¤ ${r.user}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick='shareWhatsApp(${JSON.stringify(r).replace(/'/g, "\\'")})' class="bg-green-500 hover:bg-green-600 text-white w-10 h-10 rounded-xl flex items-center justify-center transition-all">ğŸ“±</button>
                        <button onclick='exportExcel([${JSON.stringify(r).replace(/'/g, "\\'")}])' class="bg-blue-500 hover:bg-blue-600 text-white w-10 h-10 rounded-xl flex items-center justify-center transition-all">ğŸ“Š</button>
                        ${state.user.isAdmin ? `<button onclick="deleteReport(${r.id})" class="bg-red-500 hover:bg-red-600 text-white w-10 h-10 rounded-xl flex items-center justify-center transition-all">ğŸ—‘ï¸</button>` : ''}
                    </div>
                </div>
                
                <div class="space-y-2 mb-4">
                    ${r.machines.map(m => `
                        <div class="bg-gray-50 rounded-xl p-3 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="bg-orange-100 text-orange-600 w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">${m.id}</div>
                                <span class="text-sm text-gray-600">${m.en}Ã—${m.boy}Ã—${m.kalinlik}</span>
                            </div>
                            <div class="flex gap-2">
                                <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-lg text-xs font-semibold">${m.qp} â†’ ${m.vp}mÂ³</span>
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded-lg text-xs font-semibold">${m.qd} â†’ ${m.vd}mÂ³</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="bg-blue-100 rounded-xl p-3 text-center">
                        <div class="text-xs text-blue-600 font-semibold">${t('poperechny')}</div>
                        <div class="text-lg font-bold text-blue-800">${r.tqp} ${t('qty')} â†’ ${r.tvp} mÂ³</div>
                    </div>
                    <div class="bg-green-100 rounded-xl p-3 text-center">
                        <div class="text-xs text-green-600 font-semibold">${t('prodolny')}</div>
                        <div class="text-lg font-bold text-green-800">${r.tqd} ${t('qty')} â†’ ${r.tvd} mÂ³</div>
                    </div>
                </div>
                
                <div class="bg-indigo-100 rounded-xl p-4 text-center">
                    <div class="text-sm text-indigo-600 font-semibold">${t('grandTotal')}</div>
                    <div class="text-2xl font-bold text-indigo-800">${r.gt} mÂ³</div>
                </div>
            </div>
        `).join('');

        app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-slate-100 to-orange-50">
                <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white shadow-lg">
                    <div class="max-w-4xl mx-auto p-4">
                        <div class="flex justify-between items-center flex-wrap gap-3">
                            <div class="flex items-center gap-3">
                                <button onclick="goBack()" class="bg-white/20 hover:bg-white/30 backdrop-blur px-4 py-2 rounded-xl font-medium transition-all">â† ${t('back')}</button>
                                <div>
                                    <h1 class="text-xl font-bold flex items-center gap-2">ğŸ”¥ ${PROSESLER.find(p=>p.id==='kurutma').name[state.lang]}</h1>
                                    <p class="text-sm text-orange-100">${state.user.name}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex bg-white/20 rounded-lg p-1">
                                    <button onclick="changeLang('tr')" class="px-2 py-1 rounded-md transition-all ${state.lang==='tr'?'bg-white text-orange-600 font-bold':''}">ğŸ‡¹ğŸ‡·</button>
                                    <button onclick="changeLang('ru')" class="px-2 py-1 rounded-md transition-all ${state.lang==='ru'?'bg-white text-orange-600 font-bold':''}">ğŸ‡·ğŸ‡º</button>
                                    <button onclick="changeLang('kk')" class="px-2 py-1 rounded-md transition-all ${state.lang==='kk'?'bg-white text-orange-600 font-bold':''}">ğŸ‡°ğŸ‡¿</button>
                                </div>
                                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-xl font-medium transition-all">${t('logout')}</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto px-4 pt-4">
                    <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-3 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-emerald-600 text-lg">ğŸ“</span>
                            <span class="text-sm text-emerald-700">
                                <strong>${t('standard')}:</strong> ${STANDART_OLCULER.en} Ã— ${STANDART_OLCULER.boy} Ã— ${STANDART_OLCULER.kalinlik} mm
                            </span>
                        </div>
                        <button onclick="resetAllToStandard()" class="text-xs bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg transition-all font-medium">
                            â†º TÃ¼mÃ¼nÃ¼ SÄ±fÄ±rla
                        </button>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto p-4">
                    <div class="flex gap-2 mb-4 bg-white rounded-2xl p-2 shadow">
                        <button onclick="setTab('giris')" class="flex-1 py-3 rounded-xl font-semibold transition-all ${state.tab==='giris'?'bg-orange-500 text-white shadow-lg':'text-gray-600 hover:bg-gray-100'}">ğŸ“ ${t('dataEntry')}</button>
                        <button onclick="setTab('raporlar')" class="flex-1 py-3 rounded-xl font-semibold transition-all ${state.tab==='raporlar'?'bg-orange-500 text-white shadow-lg':'text-gray-600 hover:bg-gray-100'}">ğŸ“‹ ${t('reports')}</button>
                        ${state.user.isAdmin ? `<button onclick="setTab('ayarlar')" class="flex-1 py-3 rounded-xl font-semibold transition-all ${state.tab==='ayarlar'?'bg-orange-500 text-white shadow-lg':'text-gray-600 hover:bg-gray-100'}">âš™ï¸ ${t('settings')}</button>` : ''}
                    </div>

                    ${state.tab === 'giris' ? `
                        <div class="bg-white rounded-2xl shadow-lg p-5 mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">${t('shift')}</label>
                                    <div class="flex gap-2">
                                        <button onclick="setShift('sabah')" class="flex-1 py-3 rounded-xl font-semibold transition-all ${state.shift==='sabah'?'bg-amber-400 text-white shadow-lg':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">ğŸŒ… ${t('morning')}</button>
                                        <button onclick="setShift('aksam')" class="flex-1 py-3 rounded-xl font-semibold transition-all ${state.shift==='aksam'?'bg-indigo-500 text-white shadow-lg':'bg-gray-100 text-gray-600 hover:bg-gray-200'}">ğŸŒ™ ${t('evening')}</button>
                                    </div>
                                </div>
                                ${state.user.isAdmin ? `
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ“… ${t('reportDate')}</label>
                                        <input type="date" value="${state.date}" onchange="setDate(this.value)" class="input-field w-full p-3 border-2 border-gray-200 rounded-xl focus:border-indigo-500">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${machinesHTML}
                        
                        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-xl p-5 text-white">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-white/20 backdrop-blur rounded-xl p-4 text-center">
                                    <div class="text-sm opacity-80">${t('poperechny')}</div>
                                    <div class="text-2xl font-bold mt-1">${totalVol('p')} mÂ³</div>
                                    <div class="text-sm opacity-80 mt-1">${totalQty('p')} ${t('qty')}</div>
                                </div>
                                <div class="bg-white/20 backdrop-blur rounded-xl p-4 text-center">
                                    <div class="text-sm opacity-80">${t('prodolny')}</div>
                                    <div class="text-2xl font-bold mt-1">${totalVol('d')} mÂ³</div>
                                    <div class="text-sm opacity-80 mt-1">${totalQty('d')} ${t('qty')}</div>
                                </div>
                            </div>
                            <div class="bg-white/30 backdrop-blur rounded-xl p-4 text-center mb-4">
                                <div class="text-lg opacity-90">${t('grandTotal')}</div>
                                <div class="text-4xl font-bold mt-1">${grandTotal()} mÂ³</div>
                                <div class="text-sm opacity-80 mt-1">${totalQty('p') + totalQty('d')} ${t('qty')}</div>
                            </div>
                            <button onclick="saveReport()" id="saveBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-xl font-bold text-lg transition-all shadow-lg hover:shadow-xl">ğŸ’¾ ${t('save')}</button>
                        </div>
                    ` : ''}

                    ${state.tab === 'raporlar' ? `
                        <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">${t('startDate')}</label>
                                    <input type="date" value="${state.filterStart}" onchange="setFilterStart(this.value)" class="w-full p-3 border-2 border-gray-200 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">${t('endDate')}</label>
                                    <input type="date" value="${state.filterEnd}" onchange="setFilterEnd(this.value)" class="w-full p-3 border-2 border-gray-200 rounded-xl">
                                </div>
                                <div class="flex items-end gap-2">
                                    <button onclick="applyFilter()" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-xl font-semibold transition-all">${t('filter')}</button>
                                    ${state.filtering ? `<button onclick="clearFilter()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white py-3 rounded-xl font-semibold transition-all">${t('showAll')}</button>` : ''}
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="loadReports()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-xl font-semibold transition-all">ğŸ”„ Yenile</button>
                                ${filteredReports.length > 0 ? `
                                    <button onclick='exportExcel(${JSON.stringify(filteredReports).replace(/'/g, "\\'")})' class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition-all">ğŸ“Š ${t('exportExcel')} (${filteredReports.length})</button>
                                ` : ''}
                            </div>
                        </div>
                        ${reportsHTML}
                    ` : ''}

                    ${state.tab === 'ayarlar' && state.user.isAdmin ? `
                        <div class="bg-white rounded-2xl shadow-lg p-5">
                            <h3 class="text-xl font-bold text-red-600 mb-4">âš ï¸ ${t('settings')}</h3>
                            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                                <p class="text-gray-600">${t('reports')}: <span class="font-bold text-2xl text-indigo-600">${state.reports.length}</span></p>
                                <p class="text-sm text-gray-500 mt-2">â˜ï¸ Veriler bulutta saklanÄ±yor</p>
                            </div>
                            <button onclick="deleteAllReports()" class="w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-bold transition-all">ğŸ—‘ï¸ ${t('deleteAll')}</button>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <div id="successMsg" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-2xl hidden transform transition-all">
                âœ… ${t('saved')}
            </div>
        `;
    }

    // GLOBAL FUNCTIONS
    window.changeLang = (l) => { state.lang = l; localStorage.setItem('lang', l); render(); };
    window.login = async () => {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const user = USERS[u];
        if (!user || user.password !== p) { 
            document.getElementById('loginError').textContent = 'KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!'; 
            document.getElementById('loginError').classList.remove('hidden'); 
            return; 
        }
        state.user = user; 
        state.loggedIn = true; 
        render();
    };
    window.logout = () => { state.loggedIn = false; state.user = null; state.activeProses = null; state.tab = 'giris'; render(); };
    window.selectProses = async (id) => { 
        state.activeProses = id; 
        state.tab = 'giris'; 
        render();
        await loadReports();
    };
    window.goBack = () => { state.activeProses = null; render(); };
    window.setTab = (t) => { state.tab = t; render(); };
    window.setShift = (s) => { state.shift = s; render(); };
    window.setDate = (d) => { state.date = d; render(); };
    window.updateMachine = (id, field, val) => { state.machines = state.machines.map(m => m.id === id ? {...m, [field]: val} : m); render(); };
    
    window.resetToStandard = (id) => { 
        state.machines = state.machines.map(m => m.id === id ? {
            ...m, 
            en: STANDART_OLCULER.en, 
            boy: STANDART_OLCULER.boy, 
            kalinlik: STANDART_OLCULER.kalinlik
        } : m); 
        render(); 
    };
    
    window.resetAllToStandard = () => { 
        state.machines = state.machines.map(m => ({
            ...m, 
            en: STANDART_OLCULER.en, 
            boy: STANDART_OLCULER.boy, 
            kalinlik: STANDART_OLCULER.kalinlik
        })); 
        render(); 
    };
    
    window.saveReport = async () => {
        const btn = document.getElementById('saveBtn');
        btn.innerHTML = `<span class="spinner"></span> ${t('saving')}`;
        btn.disabled = true;
        
        const report = { 
            date: state.date + ' ' + new Date().toTimeString().slice(0,5), 
            shift: state.shift, 
            user: state.user.name, 
            machines: state.machines.map(m => ({...m, vp: calcVol(m,'p'), vd: calcVol(m,'d')})), 
            tvp: totalVol('p'), 
            tvd: totalVol('d'), 
            tqp: totalQty('p'), 
            tqd: totalQty('d'), 
            gt: grandTotal() 
        };
        
        await saveReportToSupabase(report);
        await loadReports();
        
        state.machines = state.machines.map(m => ({
            ...m,
            en: STANDART_OLCULER.en,
            boy: STANDART_OLCULER.boy,
            kalinlik: STANDART_OLCULER.kalinlik,
            qp: '',
            qd: ''
        }));
        
        render(); 
        document.getElementById('successMsg').classList.remove('hidden'); 
        setTimeout(() => document.getElementById('successMsg').classList.add('hidden'), 3000);
    };
    
    window.deleteReport = async (id) => { 
        if (confirm(t('confirmDelete'))) {
            await deleteReportFromSupabase(id);
            await loadReports();
        }
    };
    
    window.deleteAllReports = async () => { 
        if (confirm(t('confirmDelete'))) { 
            await deleteAllReportsFromSupabase();
            await loadReports();
        } 
    };
    
    window.setFilterStart = (d) => { state.filterStart = d; };
    window.setFilterEnd = (d) => { state.filterEnd = d; };
    window.applyFilter = () => { state.filtering = true; render(); };
    window.clearFilter = () => { state.filterStart = ''; state.filterEnd = ''; state.filtering = false; render(); };
    window.exportExcel = exportExcel;
    window.shareWhatsApp = shareWhatsApp;
    window.loadReports = loadReports;

    render();
    </script>
</body>
</html>
