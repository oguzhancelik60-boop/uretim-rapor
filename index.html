<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#D32F2F">
    <title>NordPanelsâ„¢ - Ãœretim Rapor Sistemi</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .input-field { font-size: 16px !important; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .offline-badge { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #EF4444; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; z-index: 1001; }
        .offline-badge.show { display: flex; align-items: center; gap: 8px; }
        .pending-badge { position: fixed; top: 10px; left: 10px; background: #F59E0B; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 1001; display: none; cursor: pointer; }
        .pending-badge.show { display: flex; align-items: center; gap: 6px; }
        .sync-badge { position: fixed; top: 10px; right: 10px; background: #10B981; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 1001; display: none; }
        .sync-badge.show { display: flex; align-items: center; gap: 6px; }
        
        /* EPIC V2 LOGIN */
        .login-page { min-height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%); position: relative; overflow: hidden; font-family: 'Montserrat', sans-serif; }
        .bg-gradient { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at 0% 0%, rgba(211, 47, 47, 0.2) 0%, transparent 50%), radial-gradient(ellipse at 100% 0%, rgba(255, 82, 82, 0.15) 0%, transparent 50%), radial-gradient(ellipse at 100% 100%, rgba(211, 47, 47, 0.2) 0%, transparent 50%), radial-gradient(ellipse at 0% 100%, rgba(255, 82, 82, 0.15) 0%, transparent 50%); animation: bg-shift 10s ease-in-out infinite; }
        @keyframes bg-shift { 0%, 100% { filter: hue-rotate(0deg) brightness(1); } 50% { filter: hue-rotate(10deg) brightness(1.1); } }
        .orb { position: absolute; border-radius: 50%; filter: blur(60px); animation: orb-move 15s ease-in-out infinite; pointer-events: none; }
        .orb-1 { width: 400px; height: 400px; background: rgba(211, 47, 47, 0.15); top: -200px; left: -200px; }
        .orb-2 { width: 300px; height: 300px; background: rgba(255, 82, 82, 0.12); bottom: -150px; right: -150px; animation-delay: -5s; }
        .orb-3 { width: 200px; height: 200px; background: rgba(211, 47, 47, 0.1); top: 50%; right: 10%; animation-delay: -10s; }
        @keyframes orb-move { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } }
        .sparkle { position: absolute; width: 4px; height: 4px; background: white; border-radius: 50%; animation: sparkle-blink 3s ease-in-out infinite; pointer-events: none; }
        .sparkle::after { content: ''; position: absolute; top: -4px; left: 50%; transform: translateX(-50%); width: 2px; height: 12px; background: linear-gradient(to bottom, transparent, white, transparent); }
        .sparkle::before { content: ''; position: absolute; left: -4px; top: 50%; transform: translateY(-50%); width: 12px; height: 2px; background: linear-gradient(to right, transparent, white, transparent); }
        .sparkle:nth-child(1) { top: 15%; left: 20%; animation-delay: 0s; }
        .sparkle:nth-child(2) { top: 25%; right: 25%; animation-delay: 0.5s; }
        .sparkle:nth-child(3) { bottom: 30%; left: 15%; animation-delay: 1s; }
        .sparkle:nth-child(4) { bottom: 20%; right: 20%; animation-delay: 1.5s; }
        @keyframes sparkle-blink { 0%, 100% { opacity: 0; transform: scale(0); } 50% { opacity: 1; transform: scale(1); } }
        .login-card { background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%); border-radius: 32px; padding: 40px 35px; width: 90%; max-width: 380px; box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3), 0 0 100px rgba(211, 47, 47, 0.2); position: relative; z-index: 10; animation: card-appear 0.6s ease-out; }
        @keyframes card-appear { 0% { opacity: 0; transform: translateY(30px) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        .logo-section { text-align: center; margin-bottom: 25px; }
        .logo-container { position: relative; display: inline-block; margin-bottom: 20px; }
        .logo-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 3px solid transparent; border-top-color: #D32F2F; border-radius: 50%; animation: ring-spin 3s linear infinite; }
        .logo-ring-1 { width: 120px; height: 120px; }
        .logo-ring-2 { width: 140px; height: 140px; border-top-color: transparent; border-right-color: #FF5252; animation: ring-spin-reverse 4s linear infinite; }
        @keyframes ring-spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes ring-spin-reverse { 0% { transform: translate(-50%, -50%) rotate(360deg); } 100% { transform: translate(-50%, -50%) rotate(0deg); } }
        .logo-pulse { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90px; height: 90px; background: radial-gradient(circle, rgba(211, 47, 47, 0.3) 0%, transparent 70%); border-radius: 50%; animation: pulse-grow 2s ease-out infinite; }
        .logo-pulse-2 { animation-delay: 0.7s; }
        @keyframes pulse-grow { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.8; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
        .logo-icon { position: relative; width: 90px; height: 90px; background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%); border-radius: 24px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 36px; color: white; box-shadow: 0 15px 50px rgba(211, 47, 47, 0.5); z-index: 10; }
        .brand-name { font-size: 28px; font-weight: 900; color: #1a1a2e; font-family: 'Montserrat', sans-serif; }
        .brand-name span { background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .tagline { font-size: 10px; color: #888; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; margin-top: 5px; }
        .features-row { display: flex; justify-content: center; gap: 8px; margin: 20px 0; }
        .feature-badge { background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border: 2px solid rgba(211, 47, 47, 0.15); padding: 8px 14px; border-radius: 20px; font-size: 11px; color: #555; font-weight: 700; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .lang-selector { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .lang-btn { width: 48px; height: 40px; border: 2px solid #e8e8e8; border-radius: 12px; background: white; font-size: 20px; cursor: pointer; transition: all 0.3s ease; }
        .lang-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .lang-btn.active { border-color: #D32F2F; background: linear-gradient(135deg, #FEF2F2 0%, #FFF 100%); box-shadow: 0 6px 20px rgba(211, 47, 47, 0.25); transform: translateY(-2px); }
        .login-input-group { margin-bottom: 12px; position: relative; }
        .login-input { width: 100%; padding: 16px 50px 16px 20px; background: #f8f9fa; border: 2px solid transparent; border-radius: 14px; font-size: 15px; font-family: 'Montserrat', sans-serif; font-weight: 500; color: #333; transition: all 0.3s ease; }
        .login-input::placeholder { color: #999; }
        .login-input:focus { outline: none; background: white; border-color: #D32F2F; box-shadow: 0 0 0 4px rgba(211, 47, 47, 0.1); }
        .login-input-icon { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); font-size: 18px; opacity: 0.5; }
        .login-error { background: #FEE2E2; color: #DC2626; padding: 12px; border-radius: 12px; font-size: 13px; font-weight: 600; text-align: center; margin-bottom: 15px; display: none; }
        .login-error.show { display: block; }
        .login-btn { width: 100%; padding: 18px; background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%); border: none; border-radius: 14px; font-size: 15px; font-weight: 800; font-family: 'Montserrat', sans-serif; color: white; cursor: pointer; box-shadow: 0 10px 35px rgba(211, 47, 47, 0.4); text-transform: uppercase; letter-spacing: 2px; transition: all 0.3s ease; }
        .login-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 45px rgba(211, 47, 47, 0.5); }
        .demo-box { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 14px; font-size: 12px; color: #666; }
        .demo-box-title { font-weight: 700; margin-bottom: 8px; color: #333; }
        .demo-user { background: white; padding: 6px 12px; border-radius: 8px; margin: 4px 0; font-family: monospace; font-size: 11px; }
        .version-badge { text-align: center; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .version-tag { background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%); color: white; padding: 4px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; }
        .version-text { font-size: 11px; color: #999; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="offlineBadge" class="offline-badge"><span>ğŸ“´</span> Ã‡evrimdÄ±ÅŸÄ±</div>
    <div id="pendingBadge" class="pending-badge" onclick="syncPendingReports()"><span>â³</span> <span id="pendingCount">0</span> bekleyen</div>
    <div id="syncBadge" class="sync-badge"><span>â˜ï¸</span> Senkronize</div>
    <div id="app"></div>
    
    <script>
    const SUPABASE_URL = 'https://exxznkibcoyaemlqmcon.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eHpua2liY295YWVtbHFtY29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMTk4MzMsImV4cCI6MjA4MzY5NTgzM30.AqAud6Mo6x1sy7FB_at8f2BnTZSVsytXHXC_b5WX0yQ';
    const CLOUDINARY_CLOUD = 'de8orxjfy';
    const CLOUDINARY_UPLOAD_PRESET = 'uretim_unsigned';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const PENDING_KEY = 'pendingReports';
    function getPendingReports() { return JSON.parse(localStorage.getItem(PENDING_KEY) || '[]'); }
    function savePendingReport(report) { const pending = getPendingReports(); pending.push({ ...report, pendingId: Date.now() }); localStorage.setItem(PENDING_KEY, JSON.stringify(pending)); updatePendingBadge(); }
    function removePendingReport(pendingId) { const pending = getPendingReports().filter(r => r.pendingId !== pendingId); localStorage.setItem(PENDING_KEY, JSON.stringify(pending)); updatePendingBadge(); }
    function updatePendingBadge() { const pending = getPendingReports(); const badge = document.getElementById('pendingBadge'); const count = document.getElementById('pendingCount'); if (pending && badge && count) { if (pending.length > 0) { badge.classList.add('show'); count.textContent = pending.length; } else { badge.classList.remove('show'); } } }
    
    async function syncPendingReports() {
        if (!navigator.onLine) { alert('Ä°nternet baÄŸlantÄ±sÄ± yok.'); return; }
        const pending = getPendingReports();
        if (pending.length === 0) return;
        let syncedCount = 0;
        for (const report of pending) {
            try {
                const { error } = await db.from('reports').insert([{ date: report.date, shift: report.shift, user_name: report.user, machines: report.machines, tvp: report.tvp, tvd: report.tvd, tqp: report.tqp, tqd: report.tqd, gt: report.gt, photos: report.photos, ai_readings: report.ai_readings, verification_status: report.verification_status, verification_details: report.verification_details, warning_logged: false, corrected_by: null }]);
                if (!error) { removePendingReport(report.pendingId); syncedCount++; }
            } catch (err) { console.error('Senkron hatasÄ±:', err); }
        }
        if (syncedCount > 0) { showSyncBadge(); await loadReports(); alert('âœ… ' + syncedCount + ' rapor senkronize edildi!'); }
    }
    
    window.addEventListener('online', () => { updateOnlineStatus(); const pending = getPendingReports(); if (pending.length > 0) { setTimeout(syncPendingReports, 2000); } });
    window.addEventListener('offline', updateOnlineStatus);
    function updateOnlineStatus() { const badge = document.getElementById('offlineBadge'); if (badge) { if (!navigator.onLine) { badge.classList.add('show'); } else { badge.classList.remove('show'); } } }
    function showSyncBadge() { const badge = document.getElementById('syncBadge'); if (badge) { badge.classList.add('show'); setTimeout(() => badge.classList.remove('show'), 2000); } }
    
    const STANDART_OLCULER = { en: '1250', boy: '2500', kalinlik: '1.5' };
    const USERS = {
        'yonetici': { password: 'admin123', role: 'YÃ¶netici', name: 'YÃ¶netici', isAdmin: true, permissions: ['kurutma'] },
        'ali': { password: 'ali123', role: 'OperatÃ¶r', name: 'Ali', isAdmin: false, permissions: ['kurutma'] },
        'mehmet': { password: 'mehmet123', role: 'OperatÃ¶r', name: 'Mehmet', isAdmin: false, permissions: ['kurutma'] },
        'ayse': { password: 'ayse123', role: 'OperatÃ¶r', name: 'AyÅŸe', isAdmin: false, permissions: ['kurutma'] }
    };

    function createDefaultMachines() {
        return [
            { id: 1, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '', photo: null, photoPreview: null },
            { id: 2, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '', photo: null, photoPreview: null },
            { id: 3, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '', photo: null, photoPreview: null },
            { id: 4, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '', photo: null, photoPreview: null }
        ];
    }

    let state = { lang: localStorage.getItem('lang') || 'kk', loggedIn: false, user: null, activeProses: null, tab: 'giris', shift: 'sabah', date: new Date().toISOString().split('T')[0], machines: createDefaultMachines(), reports: [], filterStart: '', filterEnd: '', filtering: false, loading: false, saving: false };

    const PROSESLER = [
        { id: 'agac_kabul', name: { tr: 'AÄŸaÃ§ Kabul', ru: 'ĞŸÑ€Ğ¸Ñ‘Ğ¼ Ğ”ĞµÑ€ĞµĞ²Ğ°', kk: 'ĞÒ“Ğ°Ñˆ Ò›Ğ°Ğ±Ñ‹Ğ»Ğ´Ğ°Ñƒ' }, icon: 'ğŸŒ³', color: 'bg-green-500', active: false },
        { id: 'papel_soyma', name: { tr: 'Papel Soyma', ru: 'Ğ ĞµĞ·ĞºĞ° Ğ¨Ğ¿Ğ¾Ğ½Ğ°', kk: 'ÒšĞ°Ğ±Ğ°Ñ‚ ĞºĞµÑÑƒ' }, icon: 'âœ‚ï¸', color: 'bg-yellow-500', active: false },
        { id: 'kurutma', name: { tr: 'Kurutma', ru: 'Ğ¡ÑƒÑˆĞºĞ°', kk: 'ĞšĞµĞ¿Ñ‚Ñ–Ñ€Ñƒ' }, icon: 'ğŸ”¥', color: 'bg-orange-500', active: true },
        { id: 'papel_ekleme', name: { tr: 'Papel Ekleme', ru: 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¨Ğ¿Ğ¾Ğ½Ğ°', kk: 'ÒšĞ°Ğ±Ğ°Ñ‚ Ò›Ğ¾ÑÑƒ' }, icon: 'â•', color: 'bg-blue-500', active: false },
        { id: 'tutkallama', name: { tr: 'Tutkallama', ru: 'Ğ¡ĞºĞ»ĞµĞ¸Ğ²Ğ°Ğ½Ğ¸Ğµ', kk: 'Ğ–ĞµĞ»Ñ–Ğ¼Ğ´ĞµÑƒ' }, icon: 'ğŸ’§', color: 'bg-purple-500', active: false },
        { id: 'depo', name: { tr: 'Depo', ru: 'Ğ¡ĞºĞ»Ğ°Ğ´', kk: 'ÒšĞ¾Ğ¹Ğ¼Ğ°' }, icon: 'ğŸ“¦', color: 'bg-indigo-500', active: false }
    ];

    const T = {
        tr: { title: 'Ãœretim Rapor Sistemi', login: 'GiriÅŸ Yap', logout: 'Ã‡Ä±kÄ±ÅŸ', username: 'KullanÄ±cÄ± AdÄ±', password: 'Åifre', welcome: 'HoÅŸ geldiniz', dataEntry: 'Veri GiriÅŸi', reports: 'Raporlar', shift: 'Vardiya', morning: 'Sabah', evening: 'AkÅŸam', machine: 'Makine', width: 'En', length: 'Boy', thickness: 'KalÄ±nlÄ±k', poperechny: 'SokrasÄ±na', prodolny: 'Suyuna', save: 'Raporu Kaydet', saved: 'Rapor kaydedildi!', total: 'Toplam', grandTotal: 'Genel Toplam', volume: 'Hacim', qty: 'Adet', noReports: 'HenÃ¼z rapor yok', filter: 'Filtrele', showAll: 'TÃ¼mÃ¼', startDate: 'BaÅŸlangÄ±Ã§', endDate: 'BitiÅŸ', exportExcel: 'Excel', reportDate: 'Rapor Tarihi', demo: 'Demo KullanÄ±cÄ±lar', mm: 'mm', standard: 'Standart', loading: 'YÃ¼kleniyor...', saving: 'Kaydediliyor...', refresh: 'Yenile', takePhoto: 'FotoÄŸraf', verified: 'DoÄŸrulandÄ±', mismatch: 'Uyumsuz', correct: 'DÃ¼zelt', warn: 'UyarÄ± Kaydet', totalSummary: 'Toplam Ã–zet', mismatchCount: 'uyumsuz rapor', operatorData: 'OperatÃ¶r verisi esas alÄ±ndÄ±', analyzing: 'AI Analiz Ediyor...', piece: 'adet' },
        ru: { title: 'Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ĞÑ‚Ñ‡Ñ‘Ñ‚Ğ¾Ğ²', login: 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸', logout: 'Ğ’Ñ‹Ñ…Ğ¾Ğ´', username: 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ', password: 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ', welcome: 'Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ', dataEntry: 'Ğ’Ğ²Ğ¾Ğ´ Ğ”Ğ°Ğ½Ğ½Ñ‹Ñ…', reports: 'ĞÑ‚Ñ‡Ñ‘Ñ‚Ñ‹', shift: 'Ğ¡Ğ¼ĞµĞ½Ğ°', morning: 'Ğ£Ñ‚Ñ€ĞµĞ½Ğ½ÑÑ', evening: 'Ğ’ĞµÑ‡ĞµÑ€Ğ½ÑÑ', machine: 'ĞœĞ°ÑˆĞ¸Ğ½Ğ°', width: 'Ğ¨Ğ¸Ñ€Ğ¸Ğ½Ğ°', length: 'Ğ”Ğ»Ğ¸Ğ½Ğ°', thickness: 'Ğ¢Ğ¾Ğ»Ñ‰Ğ¸Ğ½Ğ°', poperechny: 'ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹', prodolny: 'ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹', save: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ', saved: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾!', total: 'Ğ˜Ñ‚Ğ¾Ğ³Ğ¾', grandTotal: 'ĞĞ±Ñ‰Ğ¸Ğ¹ ĞĞ±ÑŠÑ‘Ğ¼', volume: 'ĞĞ±ÑŠÑ‘Ğ¼', qty: 'ĞšĞ¾Ğ»-Ğ²Ğ¾', noReports: 'ĞĞµÑ‚ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ¾Ğ²', filter: 'Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€', showAll: 'Ğ’ÑĞµ', startDate: 'ĞĞ°Ñ‡Ğ°Ğ»Ğ¾', endDate: 'ĞšĞ¾Ğ½ĞµÑ†', exportExcel: 'Excel', reportDate: 'Ğ”Ğ°Ñ‚Ğ°', demo: 'Ğ”ĞµĞ¼Ğ¾', mm: 'Ğ¼Ğ¼', standard: 'Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚', loading: 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...', saving: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ...', refresh: 'ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ', takePhoto: 'Ğ¤Ğ¾Ñ‚Ğ¾', verified: 'ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾', mismatch: 'ĞĞµÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ', correct: 'Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ', warn: 'Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ', totalSummary: 'Ğ˜Ñ‚Ğ¾Ğ³Ğ¾', mismatchCount: 'Ğ½ĞµÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğ¹', operatorData: 'Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°', analyzing: 'AI ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚...', piece: 'ÑˆÑ‚' },
        kk: { title: 'Ğ•ÑĞµĞ¿ Ğ–Ò¯Ğ¹ĞµÑÑ–', login: 'ĞšÑ–Ñ€Ñƒ', logout: 'Ğ¨Ñ‹Ò“Ñƒ', username: 'ĞŸĞ°Ğ¹Ğ´Ğ°Ğ»Ğ°Ğ½ÑƒÑˆÑ‹', password: 'ÒšÒ±Ğ¿Ğ¸Ñ ÑÓ©Ğ·', welcome: 'ÒšĞ¾Ñˆ ĞºĞµĞ»Ğ´Ñ–Ò£Ñ–Ğ·', dataEntry: 'Ğ”ĞµÑ€ĞµĞºÑ‚ĞµÑ€', reports: 'Ğ•ÑĞµĞ¿Ñ‚ĞµÑ€', shift: 'ĞÑƒÑ‹ÑÑ‹Ğ¼', morning: 'Ğ¢Ğ°Ò£Ò“Ñ‹', evening: 'ĞšĞµÑˆĞºÑ–', machine: 'ĞœĞ°ÑˆĞ¸Ğ½Ğ°', width: 'Ğ•Ğ½Ñ–', length: 'Ò°Ğ·Ñ‹Ğ½Ğ´Ñ‹Ò“Ñ‹', thickness: 'ÒšĞ°Ğ»Ñ‹Ò£Ğ´Ñ‹Ò“Ñ‹', poperechny: 'ĞšÓ©Ğ»Ğ´ĞµĞ½ĞµÒ£', prodolny: 'Ğ‘Ğ¾Ğ¹Ğ»Ñ‹Ò›', save: 'Ğ¡Ğ°Ò›Ñ‚Ğ°Ñƒ', saved: 'Ğ¡Ğ°Ò›Ñ‚Ğ°Ğ»Ğ´Ñ‹!', total: 'Ğ–Ğ¸Ñ‹Ğ½Ñ‹', grandTotal: 'Ğ–Ğ°Ğ»Ğ¿Ñ‹ ĞšÓ©Ğ»ĞµĞ¼', volume: 'ĞšÓ©Ğ»ĞµĞ¼', qty: 'Ğ¡Ğ°Ğ½Ñ‹', noReports: 'Ğ•ÑĞµĞ¿ Ğ¶Ğ¾Ò›', filter: 'Ğ¡Ò¯Ğ·Ñƒ', showAll: 'Ğ‘Ğ°Ñ€Ğ»Ñ‹Ò“Ñ‹', startDate: 'Ğ‘Ğ°ÑÑ‹', endDate: 'Ğ¡Ğ¾Ò£Ñ‹', exportExcel: 'Excel', reportDate: 'ĞšÒ¯Ğ½Ñ–', demo: 'Ğ”ĞµĞ¼Ğ¾', mm: 'Ğ¼Ğ¼', standard: 'Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚', loading: 'Ğ–Ò¯ĞºÑ‚ĞµĞ»ÑƒĞ´Ğµ...', saving: 'Ğ¡Ğ°Ò›Ñ‚Ğ°Ğ»ÑƒĞ´Ğ°...', refresh: 'Ğ–Ğ°Ò£Ğ°Ñ€Ñ‚Ñƒ', takePhoto: 'Ğ¤Ğ¾Ñ‚Ğ¾', verified: 'Ğ Ğ°ÑÑ‚Ğ°Ğ»Ğ´Ñ‹', mismatch: 'Ğ¡Ó™Ğ¹ĞºĞµÑÑÑ–Ğ·Ğ´Ñ–Ğº', correct: 'Ğ¢Ò¯Ğ·ĞµÑ‚Ñƒ', warn: 'Ğ–Ğ°Ğ·Ñƒ', totalSummary: 'Ğ–Ğ¸Ñ‹Ğ½Ñ‹', mismatchCount: 'ÑÓ™Ğ¹ĞºĞµÑÑÑ–Ğ·Ğ´Ñ–Ğº', operatorData: 'ĞĞ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´ĞµÑ€ĞµĞºÑ‚ĞµÑ€Ñ–', analyzing: 'AI Ğ¢Ğ°Ğ»Ğ´Ğ°ÑƒĞ´Ğ°...', piece: 'Ğ´Ğ°Ğ½Ğ°' }
    };

    const t = (key) => T[state.lang][key] || key;
    function calcVol(m, type) { const en = parseFloat(m.en) || 0; const boy = parseFloat(m.boy) || 0; const kalinlik = parseFloat(m.kalinlik) || 0; const qty = parseFloat(type === 'p' ? m.qp : m.qd) || 0; return ((en/1000) * (boy/1000) * (kalinlik/1000) * qty).toFixed(3); }
    function totalVol(type) { return state.machines.reduce((sum, m) => sum + parseFloat(calcVol(m, type)), 0).toFixed(3); }
    function totalQty(type) { return state.machines.reduce((sum, m) => sum + (parseFloat(type === 'p' ? m.qp : m.qd) || 0), 0); }
    function grandTotal() { return (parseFloat(totalVol('p')) + parseFloat(totalVol('d'))).toFixed(3); }

    async function uploadToCloudinary(file) { const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); try { const response = await fetch('https://api.cloudinary.com/v1_1/' + CLOUDINARY_CLOUD + '/image/upload', { method: 'POST', body: formData }); const data = await response.json(); if (data.secure_url) { return data.secure_url.replace('/upload/', '/upload/f_jpg,q_80/'); } return null; } catch (error) { console.error('Cloudinary yÃ¼kleme hatasÄ±:', error); return null; } }

    async function analyzeWithClaude(imageUrl) { return new Promise((resolve) => { const xhr = new XMLHttpRequest(); xhr.open('POST', '/api/analyze', true); xhr.setRequestHeader('Content-Type', 'application/json'); xhr.timeout = 30000; xhr.onload = function() { try { const data = JSON.parse(xhr.responseText); resolve(data.result || null); } catch (e) { resolve(null); } }; xhr.onerror = function() { resolve(null); }; xhr.ontimeout = function() { resolve(null); }; xhr.send(JSON.stringify({ imageUrl })); }); }

    function verifyMachine(machine, aiReading) { if (!machine.photo || aiReading === null) { return { status: 'unknown', expected: null, actual: null, diff: null }; } const qp = parseInt(machine.qp) || 0; const qd = parseInt(machine.qd) || 0; if (qp > 0 && qd === 0) { const diff = Math.abs(aiReading - qp); return { status: diff <= 5 ? 'verified' : 'mismatch', type: 'poperechny', expected: aiReading, actual: qp, diff: diff }; } else if (qd > 0 && qp === 0) { const expected = aiReading * 2; const diff = Math.abs(expected - qd); return { status: diff <= 10 ? 'verified' : 'mismatch', type: 'prodolny', expected: expected, actual: qd, diff: diff }; } else if (qp > 0 && qd > 0) { const diff = Math.abs(aiReading - qp); return { status: diff <= 5 ? 'verified' : 'mismatch', type: 'poperechny', expected: aiReading, actual: qp, diff: diff }; } return { status: 'unknown', expected: null, actual: null, diff: null }; }
    function getOverallVerification(verificationDetails) { if (!verificationDetails || verificationDetails.length === 0) return 'unknown'; const hasPhoto = verificationDetails.some(v => v.status !== 'unknown'); if (!hasPhoto) return 'unknown'; const hasMismatch = verificationDetails.some(v => v.status === 'mismatch'); return hasMismatch ? 'mismatch' : 'verified'; }

    async function loadReports() { state.loading = true; render(); try { const { data, error } = await db.from('reports').select('*').order('created_at', { ascending: false }); if (error) throw error; state.reports = data.map(r => ({ id: r.id, date: r.date, shift: r.shift, user: r.user_name, machines: r.machines, tvp: r.tvp, tvd: r.tvd, tqp: r.tqp, tqd: r.tqd, gt: r.gt, photos: r.photos || {}, ai_readings: r.ai_readings || {}, verification_status: r.verification_status || 'unknown', verification_details: r.verification_details || [], warning_logged: r.warning_logged || false, corrected_by: r.corrected_by })); showSyncBadge(); } catch (error) { console.error('YÃ¼kleme hatasÄ±:', error); state.reports = []; } state.loading = false; render(); }
    async function saveReportToCloud(report) { try { const { error } = await db.from('reports').insert([{ date: report.date, shift: report.shift, user_name: report.user, machines: report.machines, tvp: report.tvp, tvd: report.tvd, tqp: report.tqp, tqd: report.tqd, gt: report.gt, photos: report.photos, ai_readings: report.ai_readings, verification_status: report.verification_status, verification_details: report.verification_details, warning_logged: false, corrected_by: null }]); if (error) throw error; return true; } catch (error) { console.error('Kaydetme hatasÄ±:', error); return false; } }
    async function updateReportWarning(id) { try { await db.from('reports').update({ warning_logged: true }).eq('id', id); showSyncBadge(); await loadReports(); } catch (error) { console.error('UyarÄ± kayÄ±t hatasÄ±:', error); } }
    function calculatePeriodTotals(reports) { let totalPoperechny = 0, totalProdolny = 0, totalVolume = 0, totalVolPoperechny = 0, totalVolProdolny = 0, mismatchCount = 0; reports.forEach(r => { totalPoperechny += parseInt(r.tqp) || 0; totalProdolny += parseInt(r.tqd) || 0; totalVolume += parseFloat(r.gt) || 0; totalVolPoperechny += parseFloat(r.tvp) || 0; totalVolProdolny += parseFloat(r.tvd) || 0; if (r.verification_status === 'mismatch') mismatchCount++; }); return { poperechny: totalPoperechny, prodolny: totalProdolny, volume: totalVolume.toFixed(3), volPoperechny: totalVolPoperechny.toFixed(3), volProdolny: totalVolProdolny.toFixed(3), mismatchCount }; }

    function render() {
        const app = document.getElementById('app');
        if (!app) return;
        updateOnlineStatus();
        updatePendingBadge();
        
        // EPIC V2 LOGIN PAGE
        if (!state.loggedIn) {
            app.innerHTML = '<div class="login-page"><div class="bg-gradient"></div><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div><div class="sparkle"></div><div class="sparkle"></div><div class="sparkle"></div><div class="sparkle"></div><div class="login-card"><div class="logo-section"><div class="logo-container"><div class="logo-pulse"></div><div class="logo-pulse logo-pulse-2"></div><div class="logo-ring logo-ring-1"></div><div class="logo-ring logo-ring-2"></div><div class="logo-icon">NP</div></div><h1 class="brand-name">Nord<span>Panels</span>â„¢</h1><p class="tagline">Smart Factory System</p></div><div class="features-row"><div class="feature-badge">â˜ï¸ Cloud</div><div class="feature-badge">ğŸ¤– AI</div><div class="feature-badge">ğŸ“± PWA</div></div><div class="lang-selector"><button class="lang-btn ' + (state.lang==='kk'?'active':'') + '" onclick="changeLang(\'kk\')">ğŸ‡°ğŸ‡¿</button><button class="lang-btn ' + (state.lang==='ru'?'active':'') + '" onclick="changeLang(\'ru\')">ğŸ‡·ğŸ‡º</button><button class="lang-btn ' + (state.lang==='tr'?'active':'') + '" onclick="changeLang(\'tr\')">ğŸ‡¹ğŸ‡·</button></div><div id="loginError" class="login-error"></div><div class="login-input-group"><input id="username" class="login-input" type="text" placeholder="' + t('username') + '"><span class="login-input-icon">ğŸ‘¤</span></div><div class="login-input-group"><input id="password" class="login-input" type="password" placeholder="' + t('password') + '"><span class="login-input-icon">ğŸ”</span></div><button class="login-btn" onclick="doLogin()">ğŸš€ ' + t('login') + '</button><div class="demo-box"><div class="demo-box-title">ğŸ“‹ ' + t('demo') + ':</div><div class="demo-user">yonetici / admin123</div><div class="demo-user">ali / ali123</div></div><div class="version-badge"><span class="version-tag">v2.0</span><span class="version-text">Kazakhstan Edition</span></div></div></div>';
            return;
        }

        // PROSES SEÃ‡Ä°MÄ°
        if (!state.activeProses) {
            app.innerHTML = '<div class="min-h-screen bg-gradient-to-br from-slate-100 to-indigo-100"><div class="bg-white shadow-lg"><div class="max-w-4xl mx-auto p-4"><div class="flex items-center justify-between"><div><h1 class="text-2xl font-bold text-indigo-900">ğŸ­ ' + t('title') + '</h1><p class="text-gray-600">' + t('welcome') + ', <span class="font-semibold">' + state.user.name + '</span></p></div><div class="flex items-center gap-2"><div class="flex bg-gray-100 rounded-lg p-1"><button onclick="changeLang(\'kk\')" class="px-3 py-1 rounded ' + (state.lang==='kk'?'bg-white shadow text-indigo-700 font-bold':'text-gray-600') + '">ğŸ‡°ğŸ‡¿</button><button onclick="changeLang(\'ru\')" class="px-3 py-1 rounded ' + (state.lang==='ru'?'bg-white shadow text-indigo-700 font-bold':'text-gray-600') + '">ğŸ‡·ğŸ‡º</button><button onclick="changeLang(\'tr\')" class="px-3 py-1 rounded ' + (state.lang==='tr'?'bg-white shadow text-indigo-700 font-bold':'text-gray-600') + '">ğŸ‡¹ğŸ‡·</button></div><button onclick="doLogout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">' + t('logout') + '</button></div></div></div></div><div class="max-w-4xl mx-auto p-4"><div class="grid grid-cols-2 md:grid-cols-3 gap-4">' + PROSESLER.map(p => { const hasAccess = state.user.permissions.includes(p.id); return '<div onclick="' + (hasAccess && p.active ? "selectProses('" + p.id + "')" : '') + '" class="bg-white rounded-2xl shadow-lg p-6 transition-all ' + (hasAccess && p.active ? 'cursor-pointer hover:shadow-xl hover:scale-105' : '') + ' ' + (!hasAccess ? 'opacity-50' : '') + ' ' + (!p.active ? 'border-2 border-dashed border-gray-300' : '') + '"><div class="text-center"><div class="' + p.color + ' w-16 h-16 rounded-xl flex items-center justify-center text-3xl mx-auto mb-3 shadow-lg">' + p.icon + '</div><h3 class="font-bold text-gray-800">' + p.name[state.lang] + '</h3>' + (!p.active ? '<p class="text-xs text-amber-600 mt-1">â³ YakÄ±nda</p>' : '') + (!hasAccess && p.active ? '<p class="text-xs text-red-500 mt-1">ğŸ”’ Yetki Yok</p>' : '') + (hasAccess && p.active ? '<p class="text-xs text-green-600 mt-1">âœ“ GiriÅŸ</p>' : '') + '</div></div>'; }).join('') + '</div></div></div>';
            return;
        }

        // KURUTMA EKRANI
        const filteredReports = state.filtering ? state.reports.filter(r => { const d = r.date.split(' ')[0]; return (!state.filterStart || d >= state.filterStart) && (!state.filterEnd || d <= state.filterEnd); }) : state.reports;
        const periodTotals = calculatePeriodTotals(filteredReports);
        const currentProses = PROSESLER.find(p => p.id === state.activeProses);

        app.innerHTML = '<div class="min-h-screen bg-gradient-to-br from-slate-100 to-orange-50 pb-8"><div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white shadow-lg"><div class="max-w-4xl mx-auto p-4"><div class="flex justify-between items-center"><div class="flex items-center gap-3"><button onclick="goBack()" class="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-xl">â† Geri</button><div><h1 class="text-xl font-bold">' + currentProses.icon + ' ' + currentProses.name[state.lang] + '</h1><p class="text-sm text-orange-100">' + state.user.name + (state.user.isAdmin ? ' ğŸ‘‘' : '') + '</p></div></div><div class="flex items-center gap-2"><div class="flex bg-white/20 rounded-lg p-1"><button onclick="changeLang(\'kk\')" class="px-2 py-1 rounded ' + (state.lang==='kk'?'bg-white text-orange-600':'') + '">ğŸ‡°ğŸ‡¿</button><button onclick="changeLang(\'ru\')" class="px-2 py-1 rounded ' + (state.lang==='ru'?'bg-white text-orange-600':'') + '">ğŸ‡·ğŸ‡º</button><button onclick="changeLang(\'tr\')" class="px-2 py-1 rounded ' + (state.lang==='tr'?'bg-white text-orange-600':'') + '">ğŸ‡¹ğŸ‡·</button></div><button onclick="doLogout()" class="bg-red-500 px-4 py-2 rounded-xl text-sm">' + t('logout') + '</button></div></div></div></div><div class="max-w-4xl mx-auto p-4"><div class="flex gap-2 mb-4 bg-white rounded-2xl p-2 shadow"><button onclick="setTab(\'giris\')" class="flex-1 py-3 rounded-xl font-semibold ' + (state.tab==='giris'?'bg-orange-500 text-white':'text-gray-600') + '">ğŸ“ ' + t('dataEntry') + '</button><button onclick="setTab(\'raporlar\')" class="flex-1 py-3 rounded-xl font-semibold ' + (state.tab==='raporlar'?'bg-orange-500 text-white':'text-gray-600') + '">ğŸ“‹ ' + t('reports') + '</button>' + (state.user.isAdmin ? '<button onclick="setTab(\'ayarlar\')" class="flex-1 py-3 rounded-xl font-semibold ' + (state.tab==='ayarlar'?'bg-orange-500 text-white':'text-gray-600') + '">âš™ï¸ Ayarlar</button>' : '') + '</div>' + (state.tab === 'giris' ? renderDataEntry() : state.tab === 'raporlar' ? renderReports(filteredReports, periodTotals) : renderSettings()) + '</div></div><div id="successMsg" class="fixed top-16 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-2xl hidden z-50">âœ… ' + t('saved') + '</div>';
    }

    function renderDataEntry() {
        return '<div class="bg-white rounded-2xl shadow-lg p-4 mb-4"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-semibold mb-2">' + t('shift') + '</label><div class="flex gap-2"><button onclick="setShift(\'sabah\')" class="flex-1 py-3 rounded-xl font-semibold ' + (state.shift==='sabah'?'bg-amber-400 text-white':'bg-gray-100') + '">ğŸŒ… ' + t('morning') + '</button><button onclick="setShift(\'aksam\')" class="flex-1 py-3 rounded-xl font-semibold ' + (state.shift==='aksam'?'bg-indigo-500 text-white':'bg-gray-100') + '">ğŸŒ™ ' + t('evening') + '</button></div></div>' + (state.user.isAdmin ? '<div><label class="block text-sm font-semibold mb-2">ğŸ“… ' + t('reportDate') + '</label><input type="date" value="' + state.date + '" onchange="setDate(this.value)" class="w-full p-3 border-2 rounded-xl"></div>' : '<div></div>') + '</div></div>' + state.machines.map(m => '<div class="bg-white rounded-2xl shadow-lg p-4 mb-3 border-l-4 border-orange-400"><div class="flex items-center gap-2 mb-3"><div class="bg-orange-100 text-orange-600 w-10 h-10 rounded-xl flex items-center justify-center font-bold text-lg">' + m.id + '</div><span class="font-bold text-lg">' + t('machine') + ' ' + m.id + '</span></div><div class="flex gap-2 mb-3"><label class="cursor-pointer flex-1"><div class="w-full py-3 rounded-xl text-center font-semibold ' + (m.photoPreview ? 'bg-green-500 text-white' : 'bg-blue-500 text-white') + '">ğŸ“· Kamera</div><input type="file" accept="image/*" capture="environment" onchange="handleMachinePhoto(' + m.id + ', this)" class="hidden"></label><label class="cursor-pointer flex-1"><div class="w-full py-3 rounded-xl text-center font-semibold ' + (m.photoPreview ? 'bg-green-500 text-white' : 'bg-purple-500 text-white') + '">ğŸ–¼ï¸ Galeri</div><input type="file" accept="image/*" onchange="handleMachinePhoto(' + m.id + ', this)" class="hidden"></label></div>' + (m.photoPreview ? '<div class="text-center text-green-600 text-sm mb-2">âœ… FotoÄŸraf eklendi</div><div class="mb-3 relative"><img src="' + m.photoPreview + '" class="w-full h-32 object-cover rounded-xl border-2 border-green-300"><button onclick="clearMachinePhoto(' + m.id + ')" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full text-xl">âœ•</button></div>' : '') + '<div class="grid grid-cols-3 gap-2 mb-3"><div><label class="text-xs text-gray-500">' + t('width') + '</label><input type="number" value="' + m.en + '" onchange="updateMachine(' + m.id + ',\'en\',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-emerald-50"></div><div><label class="text-xs text-gray-500">' + t('length') + '</label><input type="number" value="' + m.boy + '" onchange="updateMachine(' + m.id + ',\'boy\',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-emerald-50"></div><div><label class="text-xs text-gray-500">' + t('thickness') + '</label><input type="number" value="' + m.kalinlik + '" onchange="updateMachine(' + m.id + ',\'kalinlik\',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-emerald-50" step="0.1"></div></div><div class="grid grid-cols-2 gap-3"><div class="bg-blue-50 p-3 rounded-xl border-2 border-blue-200"><label class="text-xs text-blue-700 font-bold block mb-1">' + t('poperechny') + '</label><input type="number" value="' + m.qp + '" onchange="updateMachine(' + m.id + ',\'qp\',this.value)" class="input-field w-full p-3 border-2 border-blue-300 rounded-xl text-center font-bold text-blue-700 text-lg" inputmode="numeric" placeholder="0"></div><div class="bg-green-50 p-3 rounded-xl border-2 border-green-200"><label class="text-xs text-green-700 font-bold block mb-1">' + t('prodolny') + '</label><input type="number" value="' + m.qd + '" onchange="updateMachine(' + m.id + ',\'qd\',this.value)" class="input-field w-full p-3 border-2 border-green-300 rounded-xl text-center font-bold text-green-700 text-lg" inputmode="numeric" placeholder="0"></div></div><div class="mt-3 flex justify-end gap-2 text-sm"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded">' + calcVol(m,'p') + ' mÂ³</span><span class="bg-green-100 text-green-700 px-2 py-1 rounded">' + calcVol(m,'d') + ' mÂ³</span></div></div>').join('') + '<div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-5 text-white"><div class="grid grid-cols-2 gap-4 mb-4"><div class="bg-white/20 rounded-xl p-4 text-center"><div class="text-sm opacity-80">' + t('poperechny') + '</div><div class="text-2xl font-bold">' + totalQty('p') + ' ' + t('qty') + '</div><div class="text-lg">' + totalVol('p') + ' mÂ³</div></div><div class="bg-white/20 rounded-xl p-4 text-center"><div class="text-sm opacity-80">' + t('prodolny') + '</div><div class="text-2xl font-bold">' + totalQty('d') + ' ' + t('qty') + '</div><div class="text-lg">' + totalVol('d') + ' mÂ³</div></div></div><div class="bg-white/30 rounded-xl p-4 text-center mb-4"><div class="text-lg">' + t('grandTotal') + '</div><div class="text-4xl font-bold">' + grandTotal() + ' mÂ³</div></div><button onclick="doSaveReport()" id="saveBtn" class="w-full bg-green-500 hover:bg-green-600 py-4 rounded-xl font-bold text-lg" ' + (state.saving ? 'disabled' : '') + '>' + (state.saving ? '<span class="spinner"></span> ' + t('analyzing') : 'ğŸ’¾ ' + t('save')) + '</button></div>';
    }

    function renderReports(filteredReports, periodTotals) {
        const isAdmin = state.user.isAdmin;
        return (isAdmin ? '<div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-4 mb-4 text-white"><h3 class="font-bold mb-3">ğŸ“Š ' + t('totalSummary') + '</h3><div class="grid grid-cols-3 gap-2 text-center"><div class="bg-white/20 rounded-xl p-2"><div class="text-xs opacity-80">' + t('poperechny') + '</div><div class="text-lg font-bold">' + periodTotals.poperechny + ' ' + t('piece') + '</div><div class="text-sm">' + periodTotals.volPoperechny + ' mÂ³</div></div><div class="bg-white/20 rounded-xl p-2"><div class="text-xs opacity-80">' + t('prodolny') + '</div><div class="text-lg font-bold">' + periodTotals.prodolny + ' ' + t('piece') + '</div><div class="text-sm">' + periodTotals.volProdolny + ' mÂ³</div></div><div class="bg-white/20 rounded-xl p-2"><div class="text-xs opacity-80">' + t('grandTotal') + '</div><div class="text-lg font-bold">' + periodTotals.volume + ' mÂ³</div></div></div>' + (periodTotals.mismatchCount > 0 ? '<div class="bg-red-500/50 rounded-xl p-2 mt-2 text-center text-sm">âš ï¸ ' + periodTotals.mismatchCount + ' ' + t('mismatchCount') + '</div>' : '') + '</div>' : '') + '<div class="bg-white rounded-2xl shadow-lg p-4 mb-4"><div class="grid grid-cols-3 gap-2"><div><label class="text-xs text-gray-500">' + t('startDate') + '</label><input type="date" value="' + state.filterStart + '" onchange="state.filterStart=this.value" class="w-full p-2 border rounded-xl text-sm"></div><div><label class="text-xs text-gray-500">' + t('endDate') + '</label><input type="date" value="' + state.filterEnd + '" onchange="state.filterEnd=this.value" class="w-full p-2 border rounded-xl text-sm"></div><div class="flex items-end"><button onclick="applyFilter()" class="w-full bg-indigo-500 text-white py-2 rounded-xl text-sm">' + t('filter') + '</button></div></div><div class="flex gap-2 mt-2">' + (state.filtering ? '<button onclick="clearFilter()" class="flex-1 bg-gray-400 text-white py-2 rounded-xl text-sm">' + t('showAll') + '</button>' : '') + '<button onclick="doLoadReports()" class="flex-1 bg-blue-500 text-white py-2 rounded-xl text-sm">ğŸ”„ ' + t('refresh') + '</button><button onclick="exportExcel()" class="flex-1 bg-green-500 text-white py-2 rounded-xl text-sm">ğŸ“Š Excel</button></div></div>' + (state.loading ? '<div class="text-center py-8"><div class="spinner" style="width:40px;height:40px;border-top-color:#4F46E5;margin:0 auto"></div><p class="mt-2 text-gray-500">' + t('loading') + '</p></div>' : filteredReports.length === 0 ? '<div class="bg-white rounded-2xl p-8 text-center text-gray-500">ğŸ“‹ ' + t('noReports') + '</div>' : filteredReports.map(r => renderReportCard(r)).join(''));
    }

    function renderSettings() { return '<div class="bg-white rounded-2xl shadow-lg p-5"><h3 class="text-xl font-bold text-gray-800 mb-4">âš™ï¸ Ayarlar</h3><div class="bg-gray-50 rounded-xl p-4 mb-4"><div class="flex justify-between items-center"><span class="text-gray-600">Toplam Rapor:</span><span class="text-2xl font-bold text-indigo-600">' + state.reports.length + '</span></div><p class="text-sm text-gray-500 mt-2">â˜ï¸ Veriler Supabase bulutunda saklanÄ±yor</p></div><div class="space-y-3"><button onclick="doDeleteAllReports()" class="w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-bold">ğŸ—‘ï¸ TÃ¼m RaporlarÄ± Sil</button></div></div>'; }

    function renderReportCard(r) { const isAdmin = state.user.isAdmin; const statusColor = r.verification_status === 'verified' || r.verification_status === 'corrected' ? 'green' : r.verification_status === 'mismatch' ? 'red' : 'gray'; return '<div class="bg-white rounded-2xl shadow-lg p-4 mb-4 border-l-4 border-' + statusColor + '-500"><div class="flex justify-between items-start mb-3"><div><div class="font-bold">' + r.date + '</div><div class="text-sm text-gray-500">' + (r.shift === 'sabah' ? 'ğŸŒ…' : 'ğŸŒ™') + ' ' + r.user + '</div></div>' + (isAdmin ? '<div class="flex items-center gap-2"><button onclick="deleteReport(' + r.id + ')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">ğŸ—‘ï¸</button></div>' : '') + '</div><div class="grid grid-cols-2 gap-2 mb-2"><div class="bg-blue-50 rounded-xl p-2 text-center"><div class="text-xs text-blue-600">' + t('poperechny') + '</div><div class="font-bold text-blue-800">' + r.tqp + ' â†’ ' + r.tvp + ' mÂ³</div></div><div class="bg-green-50 rounded-xl p-2 text-center"><div class="text-xs text-green-600">' + t('prodolny') + '</div><div class="font-bold text-green-800">' + r.tqd + ' â†’ ' + r.tvd + ' mÂ³</div></div></div><div class="bg-indigo-100 rounded-xl p-2 text-center"><div class="text-sm text-indigo-600">' + t('grandTotal') + '</div><div class="text-xl font-bold text-indigo-800">' + r.gt + ' mÂ³</div></div></div>'; }

    window.changeLang = (l) => { state.lang = l; localStorage.setItem('lang', l); render(); };
    window.doLogin = () => { const u = document.getElementById('username').value; const p = document.getElementById('password').value; const user = USERS[u]; const errorEl = document.getElementById('loginError'); if (!user || user.password !== p) { errorEl.textContent = state.lang === 'kk' ? 'ÒšĞ°Ñ‚Ğµ Ğ´ĞµÑ€ĞµĞºÑ‚ĞµÑ€!' : state.lang === 'ru' ? 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ!' : 'HatalÄ± giriÅŸ!'; errorEl.classList.add('show'); return; } state.user = user; state.loggedIn = true; render(); };
    window.doLogout = () => { state.loggedIn = false; state.user = null; state.activeProses = null; state.tab = 'giris'; render(); };
    window.selectProses = async (id) => { state.activeProses = id; state.tab = 'giris'; render(); await loadReports(); };
    window.goBack = () => { state.activeProses = null; render(); };
    window.setTab = (t) => { state.tab = t; render(); };
    window.setShift = (s) => { state.shift = s; render(); };
    window.setDate = (d) => { state.date = d; render(); };
    window.updateMachine = (id, field, val) => { state.machines = state.machines.map(m => m.id === id ? {...m, [field]: val} : m); render(); };
    window.handleMachinePhoto = (machineId, input) => { const file = input.files[0]; if (!file) return; state.machines = state.machines.map(m => { if (m.id === machineId) { return { ...m, photo: file, photoPreview: URL.createObjectURL(file) }; } return m; }); render(); };
    window.clearMachinePhoto = (machineId) => { state.machines = state.machines.map(m => { if (m.id === machineId) { return { ...m, photo: null, photoPreview: null }; } return m; }); render(); };

    window.doSaveReport = async () => { state.saving = true; render(); const photos = {}; const aiReadings = {}; const verificationDetails = []; for (const m of state.machines) { if (m.photo) { const photoUrl = await uploadToCloudinary(m.photo); if (photoUrl) { photos[m.id] = photoUrl; const aiReading = await analyzeWithClaude(photoUrl); aiReadings[m.id] = aiReading; const verification = verifyMachine(m, aiReading); verificationDetails.push({ machineId: m.id, ...verification }); } } else { verificationDetails.push({ machineId: m.id, status: 'unknown' }); } } const verificationStatus = getOverallVerification(verificationDetails); const report = { date: state.date + ' ' + new Date().toTimeString().slice(0,5), shift: state.shift, user: state.user.name, machines: state.machines.map(m => ({ id: m.id, en: m.en, boy: m.boy, kalinlik: m.kalinlik, qp: m.qp, qd: m.qd, vp: calcVol(m,'p'), vd: calcVol(m,'d') })), tvp: totalVol('p'), tvd: totalVol('d'), tqp: totalQty('p'), tqd: totalQty('d'), gt: grandTotal(), photos, ai_readings: aiReadings, verification_status: verificationStatus, verification_details: verificationDetails }; let saved = false; if (navigator.onLine) { saved = await saveReportToCloud(report); if (saved) { showSyncBadge(); await loadReports(); } } if (!saved) { savePendingReport(report); } state.machines = createDefaultMachines(); state.saving = false; render(); const msg = document.getElementById('successMsg'); if (msg) { msg.classList.remove('hidden'); setTimeout(() => msg.classList.add('hidden'), 3000); } };

    window.deleteReport = async (id) => { if (confirm('Bu raporu silmek istediÄŸinize emin misiniz?')) { try { await db.from('reports').delete().eq('id', id); showSyncBadge(); await loadReports(); } catch (error) { console.error('Silme hatasÄ±:', error); } } };
    window.doLoadReports = loadReports;
    window.applyFilter = () => { state.filtering = true; render(); };
    window.clearFilter = () => { state.filterStart = ''; state.filterEnd = ''; state.filtering = false; render(); };
    window.doDeleteAllReports = async () => { if (confirm('TÃœM RAPORLAR SÄ°LÄ°NECEK!')) { if (confirm('Son kez: Emin misiniz?')) { try { await db.from('reports').delete().neq('id', 0); state.reports = []; showSyncBadge(); render(); } catch (error) { console.error('Silme hatasÄ±:', error); } } } };
    window.exportExcel = () => { const rpts = state.filtering ? state.reports.filter(r => { const d = r.date.split(' ')[0]; return (!state.filterStart || d >= state.filterStart) && (!state.filterEnd || d <= state.filterEnd); }) : state.reports; let csv = '\uFEFF' + 'Tarih,Vardiya,Kullanici,Poperechny,Poperechny m3,Prodolny,Prodolny m3,Toplam m3\n'; rpts.forEach(r => { csv += r.date + ',' + r.shift + ',' + r.user + ',' + r.tqp + ',' + r.tvp + ',' + r.tqd + ',' + r.tvd + ',' + r.gt + '\n'; }); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'rapor_' + new Date().toISOString().split('T')[0] + '.csv'; link.click(); };

    render();
    </script>
</body>
</html>
