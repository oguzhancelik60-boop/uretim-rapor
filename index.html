<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <title>Ãœretim Rapor Sistemi</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .input-field { font-size: 16px !important; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid white; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .offline-badge { display: none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #EF4444; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; z-index: 1001; }
        .offline-badge.show { display: flex; align-items: center; gap: 8px; }
        .pending-badge { position: fixed; top: 10px; left: 10px; background: #F59E0B; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 1001; display: none; cursor: pointer; }
        .pending-badge.show { display: flex; align-items: center; gap: 6px; }
        .sync-badge { position: fixed; top: 10px; right: 10px; background: #10B981; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 1001; display: none; }
        .sync-badge.show { display: flex; align-items: center; gap: 6px; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="offlineBadge" class="offline-badge"><span>ğŸ“´</span> Ã‡evrimdÄ±ÅŸÄ±</div>
    <div id="pendingBadge" class="pending-badge" onclick="syncPendingReports()"><span>â³</span> <span id="pendingCount">0</span> bekleyen</div>
    <div id="syncBadge" class="sync-badge"><span>â˜ï¸</span> Senkronize</div>
    <div id="app"></div>
    
    <script>
    // ==================== CONFIG ====================
    const SUPABASE_URL = 'https://exxznkibcoyaemlqmcon.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4eHpua2liY295YWVtbHFtY29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMTk4MzMsImV4cCI6MjA4MzY5NTgzM30.AqAud6Mo6x1sy7FB_at8f2BnTZSVsytXHXC_b5WX0yQ';
    const CLOUDINARY_CLOUD = 'de8orxjfy';
    const CLOUDINARY_UPLOAD_PRESET = 'uretim_unsigned';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ==================== OFFLINE SYNC ====================
    const PENDING_KEY = 'pendingReports';
    function getPendingReports() { return JSON.parse(localStorage.getItem(PENDING_KEY) || '[]'); }
    function savePendingReport(report) { const pending = getPendingReports(); pending.push({ ...report, pendingId: Date.now() }); localStorage.setItem(PENDING_KEY, JSON.stringify(pending)); updatePendingBadge(); }
    function removePendingReport(pendingId) { const pending = getPendingReports().filter(r => r.pendingId !== pendingId); localStorage.setItem(PENDING_KEY, JSON.stringify(pending)); updatePendingBadge(); }
    function updatePendingBadge() { const pending = getPendingReports(); const badge = document.getElementById('pendingBadge'); const count = document.getElementById('pendingCount'); if (pending && badge && count) { if (pending.length > 0) { badge.classList.add('show'); count.textContent = pending.length; } else { badge.classList.remove('show'); } } }
    
    async function syncPendingReports() {
        if (!navigator.onLine) { alert('Ä°nternet baÄŸlantÄ±sÄ± yok.'); return; }
        const pending = getPendingReports();
        if (pending.length === 0) return;
        let syncedCount = 0;
        for (const report of pending) {
            try {
                const { error } = await db.from('reports').insert([{ 
                    date: report.date, 
                    shift: report.shift, 
                    user_name: report.user, 
                    machines: report.machines, 
                    tvp: report.tvp, 
                    tvd: report.tvd, 
                    tqp: report.tqp, 
                    tqd: report.tqd, 
                    gt: report.gt, 
                    photos: report.photos,
                    ai_readings: report.ai_readings,
                    verification_status: report.verification_status,
                    verification_details: report.verification_details,
                    warning_logged: false,
                    corrected_by: null 
                }]);
                if (!error) { removePendingReport(report.pendingId); syncedCount++; }
            } catch (err) { console.error('Senkron hatasÄ±:', err); }
        }
        if (syncedCount > 0) { showSyncBadge(); await loadReports(); alert(`âœ… ${syncedCount} rapor senkronize edildi!`); }
    }
    
    window.addEventListener('online', () => { updateOnlineStatus(); const pending = getPendingReports(); if (pending.length > 0) { setTimeout(syncPendingReports, 2000); } });
    window.addEventListener('offline', updateOnlineStatus);
    
    function updateOnlineStatus() { const badge = document.getElementById('offlineBadge'); if (badge) { if (!navigator.onLine) { badge.classList.add('show'); } else { badge.classList.remove('show'); } } }
    function showSyncBadge() { const badge = document.getElementById('syncBadge'); if (badge) { badge.classList.add('show'); setTimeout(() => badge.classList.remove('show'), 2000); } }
    
    // ==================== APP STATE ====================
    const STANDART_OLCULER = { en: '1250', boy: '2500', kalinlik: '1.5' };
    const USERS = {
        'yonetici': { password: 'admin123', role: 'YÃ¶netici', name: 'YÃ¶netici', isAdmin: true, permissions: ['kurutma'] },
        'ali': { password: 'ali123', role: 'OperatÃ¶r', name: 'Ali', isAdmin: false, permissions: ['kurutma'] },
        'mehmet': { password: 'mehmet123', role: 'OperatÃ¶r', name: 'Mehmet', isAdmin: false, permissions: ['kurutma'] },
        'ayse': { password: 'ayse123', role: 'OperatÃ¶r', name: 'AyÅŸe', isAdmin: false, permissions: ['kurutma'] }
    };

    function createDefaultMachines() {
        return [
            { id: 1, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '', photo: null, photoPreview: null },
            { id: 2, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '', photo: null, photoPreview: null },
            { id: 3, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '', photo: null, photoPreview: null },
            { id: 4, en: STANDART_OLCULER.en, boy: STANDART_OLCULER.boy, kalinlik: STANDART_OLCULER.kalinlik, qp: '', qd: '', photo: null, photoPreview: null }
        ];
    }

    let state = {
        lang: localStorage.getItem('lang') || 'tr',
        loggedIn: false,
        user: null,
        activeProses: null,
        tab: 'giris',
        shift: 'sabah',
        date: new Date().toISOString().split('T')[0],
        machines: createDefaultMachines(),
        reports: [],
        filterStart: '',
        filterEnd: '',
        filtering: false,
        loading: false,
        saving: false
    };

    const PROSESLER = [
        { id: 'agac_kabul', name: { tr: 'AÄŸaÃ§ Kabul', ru: 'ĞŸÑ€Ğ¸Ñ‘Ğ¼ Ğ”ĞµÑ€ĞµĞ²Ğ°', kk: 'ĞÒ“Ğ°Ñˆ Ò›Ğ°Ğ±Ñ‹Ğ»Ğ´Ğ°Ñƒ' }, icon: 'ğŸŒ³', color: 'bg-green-500', active: false },
        { id: 'papel_soyma', name: { tr: 'Papel Soyma', ru: 'Ğ ĞµĞ·ĞºĞ° Ğ¨Ğ¿Ğ¾Ğ½Ğ°', kk: 'ÒšĞ°Ğ±Ğ°Ñ‚ ĞºĞµÑÑƒ' }, icon: 'âœ‚ï¸', color: 'bg-yellow-500', active: false },
        { id: 'kurutma', name: { tr: 'Kurutma', ru: 'Ğ¡ÑƒÑˆĞºĞ°', kk: 'ĞšĞµĞ¿Ñ‚Ñ–Ñ€Ñƒ' }, icon: 'ğŸ”¥', color: 'bg-orange-500', active: true },
        { id: 'papel_ekleme', name: { tr: 'Papel Ekleme', ru: 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¨Ğ¿Ğ¾Ğ½Ğ°', kk: 'ÒšĞ°Ğ±Ğ°Ñ‚ Ò›Ğ¾ÑÑƒ' }, icon: 'â•', color: 'bg-blue-500', active: false },
        { id: 'tutkallama', name: { tr: 'Tutkallama', ru: 'Ğ¡ĞºĞ»ĞµĞ¸Ğ²Ğ°Ğ½Ğ¸Ğµ', kk: 'Ğ–ĞµĞ»Ñ–Ğ¼Ğ´ĞµÑƒ' }, icon: 'ğŸ’§', color: 'bg-purple-500', active: false },
        { id: 'depo', name: { tr: 'Depo', ru: 'Ğ¡ĞºĞ»Ğ°Ğ´', kk: 'ÒšĞ¾Ğ¹Ğ¼Ğ°' }, icon: 'ğŸ“¦', color: 'bg-indigo-500', active: false }
    ];

    const T = {
        tr: { title: 'Ãœretim Rapor Sistemi', login: 'GiriÅŸ Yap', logout: 'Ã‡Ä±kÄ±ÅŸ', username: 'KullanÄ±cÄ± AdÄ±', password: 'Åifre', welcome: 'HoÅŸ geldiniz', dataEntry: 'Veri GiriÅŸi', reports: 'Raporlar', shift: 'Vardiya', morning: 'Sabah', evening: 'AkÅŸam', machine: 'Makine', width: 'En', length: 'Boy', thickness: 'KalÄ±nlÄ±k', poperechny: 'ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹', prodolny: 'ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹', save: 'Raporu Kaydet', saved: 'Rapor kaydedildi!', total: 'Toplam', grandTotal: 'Genel Toplam', volume: 'Hacim', qty: 'Adet', noReports: 'HenÃ¼z rapor yok', filter: 'Filtrele', showAll: 'TÃ¼mÃ¼', startDate: 'BaÅŸlangÄ±Ã§', endDate: 'BitiÅŸ', exportExcel: 'Excel', reportDate: 'Rapor Tarihi', demo: 'Demo KullanÄ±cÄ±lar', mm: 'mm', standard: 'Standart', loading: 'YÃ¼kleniyor...', saving: 'Kaydediliyor...', refresh: 'Yenile', takePhoto: 'FotoÄŸraf', verified: 'DoÄŸrulandÄ±', mismatch: 'Uyumsuz', correct: 'DÃ¼zelt', warn: 'UyarÄ± Kaydet', totalSummary: 'Toplam Ã–zet', mismatchCount: 'uyumsuz rapor', operatorData: 'OperatÃ¶r verisi esas alÄ±ndÄ±', analyzing: 'AI Analiz Ediyor...' },
        ru: { title: 'Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ĞÑ‚Ñ‡Ñ‘Ñ‚Ğ¾Ğ²', login: 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸', logout: 'Ğ’Ñ‹Ñ…Ğ¾Ğ´', username: 'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ', password: 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ', welcome: 'Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ', dataEntry: 'Ğ’Ğ²Ğ¾Ğ´ Ğ”Ğ°Ğ½Ğ½Ñ‹Ñ…', reports: 'ĞÑ‚Ñ‡Ñ‘Ñ‚Ñ‹', shift: 'Ğ¡Ğ¼ĞµĞ½Ğ°', morning: 'Ğ£Ñ‚Ñ€ĞµĞ½Ğ½ÑÑ', evening: 'Ğ’ĞµÑ‡ĞµÑ€Ğ½ÑÑ', machine: 'ĞœĞ°ÑˆĞ¸Ğ½Ğ°', width: 'Ğ¨Ğ¸Ñ€Ğ¸Ğ½Ğ°', length: 'Ğ”Ğ»Ğ¸Ğ½Ğ°', thickness: 'Ğ¢Ğ¾Ğ»Ñ‰Ğ¸Ğ½Ğ°', poperechny: 'ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹', prodolny: 'ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹', save: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ', saved: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾!', total: 'Ğ˜Ñ‚Ğ¾Ğ³Ğ¾', grandTotal: 'ĞĞ±Ñ‰Ğ¸Ğ¹ ĞĞ±ÑŠÑ‘Ğ¼', volume: 'ĞĞ±ÑŠÑ‘Ğ¼', qty: 'ĞšĞ¾Ğ»-Ğ²Ğ¾', noReports: 'ĞĞµÑ‚ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ¾Ğ²', filter: 'Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€', showAll: 'Ğ’ÑĞµ', startDate: 'ĞĞ°Ñ‡Ğ°Ğ»Ğ¾', endDate: 'ĞšĞ¾Ğ½ĞµÑ†', exportExcel: 'Excel', reportDate: 'Ğ”Ğ°Ñ‚Ğ°', demo: 'Ğ”ĞµĞ¼Ğ¾', mm: 'Ğ¼Ğ¼', standard: 'Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚', loading: 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...', saving: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ...', refresh: 'ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ', takePhoto: 'Ğ¤Ğ¾Ñ‚Ğ¾', verified: 'ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾', mismatch: 'ĞĞµÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ', correct: 'Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ', warn: 'Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ', totalSummary: 'Ğ˜Ñ‚Ğ¾Ğ³Ğ¾', mismatchCount: 'Ğ½ĞµÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğ¹', operatorData: 'Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°', analyzing: 'AI ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚...' },
        kk: { title: 'Ğ•ÑĞµĞ¿ Ğ–Ò¯Ğ¹ĞµÑÑ–', login: 'ĞšÑ–Ñ€Ñƒ', logout: 'Ğ¨Ñ‹Ò“Ñƒ', username: 'ĞŸĞ°Ğ¹Ğ´Ğ°Ğ»Ğ°Ğ½ÑƒÑˆÑ‹', password: 'ÒšÒ±Ğ¿Ğ¸Ñ ÑÓ©Ğ·', welcome: 'ÒšĞ¾Ñˆ ĞºĞµĞ»Ğ´Ñ–Ò£Ñ–Ğ·', dataEntry: 'Ğ”ĞµÑ€ĞµĞºÑ‚ĞµÑ€', reports: 'Ğ•ÑĞµĞ¿Ñ‚ĞµÑ€', shift: 'ĞÑƒÑ‹ÑÑ‹Ğ¼', morning: 'Ğ¢Ğ°Ò£Ò“Ñ‹', evening: 'ĞšĞµÑˆĞºÑ–', machine: 'ĞœĞ°ÑˆĞ¸Ğ½Ğ°', width: 'Ğ•Ğ½Ñ–', length: 'Ò°Ğ·Ñ‹Ğ½Ğ´Ñ‹Ò“Ñ‹', thickness: 'ÒšĞ°Ğ»Ñ‹Ò£Ğ´Ñ‹Ò“Ñ‹', poperechny: 'ĞšÓ©Ğ»Ğ´ĞµĞ½ĞµÒ£', prodolny: 'Ğ‘Ğ¾Ğ¹Ğ»Ñ‹Ò›', save: 'Ğ¡Ğ°Ò›Ñ‚Ğ°Ñƒ', saved: 'Ğ¡Ğ°Ò›Ñ‚Ğ°Ğ»Ğ´Ñ‹!', total: 'Ğ–Ğ¸Ñ‹Ğ½Ñ‹', grandTotal: 'Ğ–Ğ°Ğ»Ğ¿Ñ‹ ĞšÓ©Ğ»ĞµĞ¼', volume: 'ĞšÓ©Ğ»ĞµĞ¼', qty: 'Ğ¡Ğ°Ğ½Ñ‹', noReports: 'Ğ•ÑĞµĞ¿ Ğ¶Ğ¾Ò›', filter: 'Ğ¡Ò¯Ğ·Ñƒ', showAll: 'Ğ‘Ğ°Ñ€Ğ»Ñ‹Ò“Ñ‹', startDate: 'Ğ‘Ğ°ÑÑ‹', endDate: 'Ğ¡Ğ¾Ò£Ñ‹', exportExcel: 'Excel', reportDate: 'ĞšÒ¯Ğ½Ñ–', demo: 'Ğ”ĞµĞ¼Ğ¾', mm: 'Ğ¼Ğ¼', standard: 'Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚', loading: 'Ğ–Ò¯ĞºÑ‚ĞµĞ»ÑƒĞ´Ğµ...', saving: 'Ğ¡Ğ°Ò›Ñ‚Ğ°Ğ»ÑƒĞ´Ğ°...', refresh: 'Ğ–Ğ°Ò£Ğ°Ñ€Ñ‚Ñƒ', takePhoto: 'Ğ¤Ğ¾Ñ‚Ğ¾', verified: 'Ğ Ğ°ÑÑ‚Ğ°Ğ»Ğ´Ñ‹', mismatch: 'Ğ¡Ó™Ğ¹ĞºĞµÑÑÑ–Ğ·Ğ´Ñ–Ğº', correct: 'Ğ¢Ò¯Ğ·ĞµÑ‚Ñƒ', warn: 'Ğ–Ğ°Ğ·Ñƒ', totalSummary: 'Ğ–Ğ¸Ñ‹Ğ½Ñ‹', mismatchCount: 'ÑÓ™Ğ¹ĞºĞµÑÑÑ–Ğ·Ğ´Ñ–Ğº', operatorData: 'ĞĞ¿ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´ĞµÑ€ĞµĞºÑ‚ĞµÑ€Ñ–', analyzing: 'AI Ğ¢Ğ°Ğ»Ğ´Ğ°ÑƒĞ´Ğ°...' }
    };

    const t = (key) => T[state.lang][key] || key;
    
    function calcVol(m, type) {
        const en = parseFloat(m.en) || 0;
        const boy = parseFloat(m.boy) || 0;
        const kalinlik = parseFloat(m.kalinlik) || 0;
        const qty = parseFloat(type === 'p' ? m.qp : m.qd) || 0;
        return ((en/1000) * (boy/1000) * (kalinlik/1000) * qty).toFixed(3);
    }

    function totalVol(type) { return state.machines.reduce((sum, m) => sum + parseFloat(calcVol(m, type)), 0).toFixed(3); }
    function totalQty(type) { return state.machines.reduce((sum, m) => sum + (parseFloat(type === 'p' ? m.qp : m.qd) || 0), 0); }
    function grandTotal() { return (parseFloat(totalVol('p')) + parseFloat(totalVol('d'))).toFixed(3); }
    function isStandard(m) { return m.en === STANDART_OLCULER.en && m.boy === STANDART_OLCULER.boy && m.kalinlik === STANDART_OLCULER.kalinlik; }

    // ==================== CLOUDINARY UPLOAD ====================
    async function uploadToCloudinary(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        
        try {
            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            // URL'i JPG formatÄ±na Ã§evir ve optimize et
            if (data.secure_url) {
                // Cloudinary transformation: JPG formatÄ±, kalite 80
                return data.secure_url.replace('/upload/', '/upload/f_jpg,q_80/');
            }
            return null;
        } catch (error) {
            console.error('Cloudinary yÃ¼kleme hatasÄ±:', error);
            return null;
        }
    }

    // ==================== CLAUDE AI ANALYSIS (via Vercel Edge Function) ====================
    async function analyzeWithClaude(imageUrl) {
        try {
            // Cloudinary'nin fotoÄŸrafÄ± iÅŸlemesi iÃ§in 3 saniye bekle
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageUrl })
            });
            
            const data = await response.json();
            
            if (data.error) {
                console.error('AI hatasÄ±:', data.error);
                return null;
            }
            
            return data.result;
        } catch (error) {
            console.error('AI analiz hatasÄ±:', error);
            return null;
        }
    }

    // ==================== VERIFICATION ====================
    function verifyMachine(machine, aiReading) {
        // FotoÄŸraf veya AI okumasÄ± yoksa bilinmiyor
        if (!machine.photo || aiReading === null) {
            return { status: 'unknown', expected: null, actual: null, diff: null };
        }
        
        const qp = parseInt(machine.qp) || 0;
        const qd = parseInt(machine.qd) || 0;
        
        // Hangisi doldurulmuÅŸ?
        if (qp > 0 && qd === 0) {
            // ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹ doldurulmuÅŸ â†’ AI = ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹ olmalÄ±
            const diff = Math.abs(aiReading - qp);
            return {
                status: diff <= 5 ? 'verified' : 'mismatch',
                type: 'poperechny',
                expected: aiReading,
                actual: qp,
                diff: diff
            };
        } else if (qd > 0 && qp === 0) {
            // ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ doldurulmuÅŸ â†’ AI Ã— 2 = ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ olmalÄ±
            const expected = aiReading * 2;
            const diff = Math.abs(expected - qd);
            return {
                status: diff <= 10 ? 'verified' : 'mismatch',
                type: 'prodolny',
                expected: expected,
                actual: qd,
                diff: diff
            };
        } else if (qp > 0 && qd > 0) {
            // Ä°kisi de doldurulmuÅŸ - bu durumda ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹'Ä± kontrol et
            const diff = Math.abs(aiReading - qp);
            return {
                status: diff <= 5 ? 'verified' : 'mismatch',
                type: 'poperechny',
                expected: aiReading,
                actual: qp,
                diff: diff
            };
        }
        
        return { status: 'unknown', expected: null, actual: null, diff: null };
    }

    function getOverallVerification(verificationDetails) {
        if (!verificationDetails || verificationDetails.length === 0) return 'unknown';
        
        const hasPhoto = verificationDetails.some(v => v.status !== 'unknown');
        if (!hasPhoto) return 'unknown';
        
        const hasMismatch = verificationDetails.some(v => v.status === 'mismatch');
        return hasMismatch ? 'mismatch' : 'verified';
    }

    // ==================== SUPABASE FUNCTIONS ====================
    async function loadReports() {
        state.loading = true;
        render();
        
        try {
            const { data, error } = await db.from('reports').select('*').order('created_at', { ascending: false });
            if (error) throw error;
            
            state.reports = data.map(r => ({
                id: r.id,
                date: r.date,
                shift: r.shift,
                user: r.user_name,
                machines: r.machines,
                tvp: r.tvp,
                tvd: r.tvd,
                tqp: r.tqp,
                tqd: r.tqd,
                gt: r.gt,
                photos: r.photos || {},
                ai_readings: r.ai_readings || {},
                verification_status: r.verification_status || 'unknown',
                verification_details: r.verification_details || [],
                warning_logged: r.warning_logged || false,
                corrected_by: r.corrected_by
            }));
            
            showSyncBadge();
        } catch (error) {
            console.error('YÃ¼kleme hatasÄ±:', error);
            state.reports = [];
        }
        
        state.loading = false;
        render();
    }
    
    async function saveReportToCloud(report) {
        try {
            const { error } = await db.from('reports').insert([{
                date: report.date,
                shift: report.shift,
                user_name: report.user,
                machines: report.machines,
                tvp: report.tvp,
                tvd: report.tvd,
                tqp: report.tqp,
                tqd: report.tqd,
                gt: report.gt,
                photos: report.photos,
                ai_readings: report.ai_readings,
                verification_status: report.verification_status,
                verification_details: report.verification_details,
                warning_logged: false,
                corrected_by: null
            }]);
            if (error) throw error;
            return true;
        } catch (error) {
            console.error('Kaydetme hatasÄ±:', error);
            return false;
        }
    }

    async function updateReportWarning(id) {
        try {
            await db.from('reports').update({ warning_logged: true }).eq('id', id);
            showSyncBadge();
            await loadReports();
        } catch (error) {
            console.error('UyarÄ± kayÄ±t hatasÄ±:', error);
        }
    }

    async function correctReport(id, machineId, newValue, type) {
        try {
            const report = state.reports.find(r => r.id === id);
            if (!report) return;
            
            // Makineyi gÃ¼ncelle
            const updatedMachines = report.machines.map(m => {
                if (m.id === machineId) {
                    if (type === 'poperechny') {
                        return { ...m, qp: newValue, vp: calcVolForCorrection(m, newValue, 'p') };
                    } else {
                        return { ...m, qd: newValue, vd: calcVolForCorrection(m, newValue, 'd') };
                    }
                }
                return m;
            });
            
            // ToplamlarÄ± yeniden hesapla
            const newTqp = updatedMachines.reduce((sum, m) => sum + (parseInt(m.qp) || 0), 0);
            const newTqd = updatedMachines.reduce((sum, m) => sum + (parseInt(m.qd) || 0), 0);
            const newTvp = updatedMachines.reduce((sum, m) => sum + (parseFloat(m.vp) || 0), 0).toFixed(3);
            const newTvd = updatedMachines.reduce((sum, m) => sum + (parseFloat(m.vd) || 0), 0).toFixed(3);
            const newGt = (parseFloat(newTvp) + parseFloat(newTvd)).toFixed(3);
            
            // DoÄŸrulama detaylarÄ±nÄ± gÃ¼ncelle
            const updatedDetails = report.verification_details.map(v => {
                if (v.machineId === machineId) {
                    return { ...v, status: 'corrected', actual: newValue };
                }
                return v;
            });
            
            await db.from('reports').update({
                machines: updatedMachines,
                tqp: newTqp,
                tqd: newTqd,
                tvp: newTvp,
                tvd: newTvd,
                gt: newGt,
                verification_status: 'corrected',
                verification_details: updatedDetails,
                corrected_by: state.user.name
            }).eq('id', id);
            
            showSyncBadge();
            await loadReports();
        } catch (error) {
            console.error('DÃ¼zeltme hatasÄ±:', error);
        }
    }
    
    function calcVolForCorrection(m, qty, type) {
        const en = parseFloat(m.en) || 0;
        const boy = parseFloat(m.boy) || 0;
        const kalinlik = parseFloat(m.kalinlik) || 0;
        return ((en/1000) * (boy/1000) * (kalinlik/1000) * qty).toFixed(3);
    }
    
    async function deleteReport(id) {
        try {
            await db.from('reports').delete().eq('id', id);
            showSyncBadge();
            await loadReports();
        } catch (error) {
            console.error('Silme hatasÄ±:', error);
        }
    }

    // ==================== PERIOD TOTALS ====================
    function calculatePeriodTotals(reports) {
        let totalPoperechny = 0;
        let totalProdolny = 0;
        let totalVolume = 0;
        let mismatchCount = 0;
        
        reports.forEach(r => {
            totalPoperechny += parseInt(r.tqp) || 0;
            totalProdolny += parseInt(r.tqd) || 0;
            totalVolume += parseFloat(r.gt) || 0;
            if (r.verification_status === 'mismatch') mismatchCount++;
        });
        
        return { poperechny: totalPoperechny, prodolny: totalProdolny, volume: totalVolume.toFixed(3), mismatchCount };
    }

    // ==================== RENDER ====================
    function render() {
        const app = document.getElementById('app');
        if (!app) return;
        
        updateOnlineStatus();
        updatePendingBadge();
        
        // LOGIN
        if (!state.loggedIn) {
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-800 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
                        <div class="text-center mb-8">
                            <div class="text-7xl mb-4">ğŸ­</div>
                            <h1 class="text-2xl font-bold text-gray-800">${t('title')}</h1>
                            <p class="text-sm text-green-600 mt-2">â˜ï¸ Bulut + ğŸ¤– AI DoÄŸrulama</p>
                            <div class="flex justify-center gap-3 mt-5">
                                <button onclick="changeLang('tr')" class="px-4 py-2 rounded-lg ${state.lang==='tr'?'bg-indigo-600 text-white':'bg-gray-100'}">ğŸ‡¹ğŸ‡·</button>
                                <button onclick="changeLang('ru')" class="px-4 py-2 rounded-lg ${state.lang==='ru'?'bg-indigo-600 text-white':'bg-gray-100'}">ğŸ‡·ğŸ‡º</button>
                                <button onclick="changeLang('kk')" class="px-4 py-2 rounded-lg ${state.lang==='kk'?'bg-indigo-600 text-white':'bg-gray-100'}">ğŸ‡°ğŸ‡¿</button>
                            </div>
                        </div>
                        <div id="loginError" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-center"></div>
                        <div class="space-y-4">
                            <input id="username" type="text" class="input-field w-full px-4 py-3 border-2 rounded-xl" placeholder="${t('username')}">
                            <input id="password" type="password" class="input-field w-full px-4 py-3 border-2 rounded-xl" placeholder="${t('password')}">
                            <button onclick="doLogin()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg">${t('login')}</button>
                        </div>
                        <div class="mt-6 p-4 bg-gray-50 rounded-xl text-sm text-gray-600">
                            <p class="font-bold mb-2">${t('demo')}:</p>
                            <p>â€¢ <span class="font-mono bg-gray-200 px-1 rounded">yonetici/admin123</span></p>
                            <p>â€¢ <span class="font-mono bg-gray-200 px-1 rounded">ali/ali123</span></p>
                        </div>
                    </div>
                </div>`;
            return;
        }

        // MAIN APP
        // Proses seÃ§ilmemiÅŸse proses listesi gÃ¶ster
        if (!state.activeProses) {
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-slate-100 to-indigo-100">
                    <div class="bg-white shadow-lg">
                        <div class="max-w-4xl mx-auto p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-2xl font-bold text-indigo-900">ğŸ­ ${t('title')}</h1>
                                    <p class="text-gray-600">${t('welcome')}, <span class="font-semibold">${state.user.name}</span></p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex bg-gray-100 rounded-lg p-1">
                                        <button onclick="changeLang('tr')" class="px-3 py-1 rounded ${state.lang==='tr'?'bg-white shadow text-indigo-700 font-bold':'text-gray-600'}">ğŸ‡¹ğŸ‡·</button>
                                        <button onclick="changeLang('ru')" class="px-3 py-1 rounded ${state.lang==='ru'?'bg-white shadow text-indigo-700 font-bold':'text-gray-600'}">ğŸ‡·ğŸ‡º</button>
                                        <button onclick="changeLang('kk')" class="px-3 py-1 rounded ${state.lang==='kk'?'bg-white shadow text-indigo-700 font-bold':'text-gray-600'}">ğŸ‡°ğŸ‡¿</button>
                                    </div>
                                    <button onclick="doLogout()" class="bg-red-500 text-white px-4 py-2 rounded-lg">${t('logout')}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="max-w-4xl mx-auto p-4">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            ${PROSESLER.map(p => {
                                const hasAccess = state.user.permissions.includes(p.id);
                                return `
                                    <div onclick="${hasAccess && p.active ? `selectProses('${p.id}')` : ''}" 
                                         class="bg-white rounded-2xl shadow-lg p-6 transition-all ${hasAccess && p.active ? 'cursor-pointer hover:shadow-xl hover:scale-105' : ''} ${!hasAccess ? 'opacity-50' : ''} ${!p.active ? 'border-2 border-dashed border-gray-300' : ''}">
                                        <div class="text-center">
                                            <div class="${p.color} w-16 h-16 rounded-xl flex items-center justify-center text-3xl mx-auto mb-3 shadow-lg">${p.icon}</div>
                                            <h3 class="font-bold text-gray-800">${p.name[state.lang]}</h3>
                                            ${!p.active ? `<p class="text-xs text-amber-600 mt-1">â³ YakÄ±nda</p>` : ''}
                                            ${!hasAccess && p.active ? `<p class="text-xs text-red-500 mt-1">ğŸ”’ Yetki Yok</p>` : ''}
                                            ${hasAccess && p.active ? `<p class="text-xs text-green-600 mt-1">âœ“ GiriÅŸ</p>` : ''}
                                        </div>
                                    </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
            return;
        }

        // KURUTMA EKRANI
        const filteredReports = state.filtering ? state.reports.filter(r => {
            const d = r.date.split(' ')[0];
            return (!state.filterStart || d >= state.filterStart) && (!state.filterEnd || d <= state.filterEnd);
        }) : state.reports;

        const periodTotals = calculatePeriodTotals(filteredReports);
        const currentProses = PROSESLER.find(p => p.id === state.activeProses);

        app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-slate-100 to-orange-50 pb-8">
                <!-- Header -->
                <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white shadow-lg">
                    <div class="max-w-4xl mx-auto p-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <button onclick="goBack()" class="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-xl">â† Geri</button>
                                <div>
                                    <h1 class="text-xl font-bold">${currentProses.icon} ${currentProses.name[state.lang]}</h1>
                                    <p class="text-sm text-orange-100">${state.user.name} ${state.user.isAdmin ? 'ğŸ‘‘' : ''}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="flex bg-white/20 rounded-lg p-1">
                                    <button onclick="changeLang('tr')" class="px-2 py-1 rounded ${state.lang==='tr'?'bg-white text-orange-600':''}">ğŸ‡¹ğŸ‡·</button>
                                    <button onclick="changeLang('ru')" class="px-2 py-1 rounded ${state.lang==='ru'?'bg-white text-orange-600':''}">ğŸ‡·ğŸ‡º</button>
                                    <button onclick="changeLang('kk')" class="px-2 py-1 rounded ${state.lang==='kk'?'bg-white text-orange-600':''}">ğŸ‡°ğŸ‡¿</button>
                                </div>
                                <button onclick="doLogout()" class="bg-red-500 px-4 py-2 rounded-xl text-sm">${t('logout')}</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto p-4">
                    <!-- Tabs -->
                    <div class="flex gap-2 mb-4 bg-white rounded-2xl p-2 shadow">
                        <button onclick="setTab('giris')" class="flex-1 py-3 rounded-xl font-semibold ${state.tab==='giris'?'bg-orange-500 text-white':'text-gray-600'}">ğŸ“ ${t('dataEntry')}</button>
                        <button onclick="setTab('raporlar')" class="flex-1 py-3 rounded-xl font-semibold ${state.tab==='raporlar'?'bg-orange-500 text-white':'text-gray-600'}">ğŸ“‹ ${t('reports')}</button>
                        ${state.user.isAdmin ? `<button onclick="setTab('ayarlar')" class="flex-1 py-3 rounded-xl font-semibold ${state.tab==='ayarlar'?'bg-orange-500 text-white':'text-gray-600'}">âš™ï¸ Ayarlar</button>` : ''}
                    </div>

                    ${state.tab === 'giris' ? renderDataEntry() : state.tab === 'raporlar' ? renderReports(filteredReports, periodTotals) : renderSettings()}
                </div>
            </div>
            <div id="successMsg" class="fixed top-16 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl shadow-2xl hidden z-50">âœ… ${t('saved')}</div>
        `;
    }

    function renderDataEntry() {
        return `
            <!-- Shift & Date -->
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2">${t('shift')}</label>
                        <div class="flex gap-2">
                            <button onclick="setShift('sabah')" class="flex-1 py-3 rounded-xl font-semibold ${state.shift==='sabah'?'bg-amber-400 text-white':'bg-gray-100'}">ğŸŒ… ${t('morning')}</button>
                            <button onclick="setShift('aksam')" class="flex-1 py-3 rounded-xl font-semibold ${state.shift==='aksam'?'bg-indigo-500 text-white':'bg-gray-100'}">ğŸŒ™ ${t('evening')}</button>
                        </div>
                    </div>
                    ${state.user.isAdmin ? `
                        <div>
                            <label class="block text-sm font-semibold mb-2">ğŸ“… ${t('reportDate')}</label>
                            <input type="date" value="${state.date}" onchange="setDate(this.value)" class="w-full p-3 border-2 rounded-xl">
                        </div>
                    ` : '<div></div>'}
                </div>
            </div>

            <!-- Machines -->
            ${state.machines.map(m => `
                <div class="bg-white rounded-2xl shadow-lg p-4 mb-3 border-l-4 border-orange-400">
                    <!-- Header -->
                    <div class="flex items-center gap-2 mb-3">
                        <div class="bg-orange-100 text-orange-600 w-10 h-10 rounded-xl flex items-center justify-center font-bold text-lg">${m.id}</div>
                        <span class="font-bold text-lg">${t('machine')} ${m.id}</span>
                    </div>
                    
                    <!-- Photo Buttons - Kamera ve Galeri ayrÄ± -->
                    <div class="flex gap-2 mb-3">
                        <label class="cursor-pointer flex-1">
                            <div class="w-full py-3 rounded-xl text-center font-semibold ${m.photoPreview ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}">
                                ğŸ“· Kamera
                            </div>
                            <input type="file" accept="image/*" capture="environment" onchange="handleMachinePhoto(${m.id}, this)" class="hidden">
                        </label>
                        <label class="cursor-pointer flex-1">
                            <div class="w-full py-3 rounded-xl text-center font-semibold ${m.photoPreview ? 'bg-green-500 text-white' : 'bg-purple-500 text-white'}">
                                ğŸ–¼ï¸ Galeri
                            </div>
                            <input type="file" accept="image/*" onchange="handleMachinePhoto(${m.id}, this)" class="hidden">
                        </label>
                    </div>
                    
                    <!-- Photo Status -->
                    ${m.photoPreview ? `<div class="text-center text-green-600 text-sm mb-2">âœ… FotoÄŸraf eklendi</div>` : ''}
                    
                    <!-- Photo Preview -->
                    ${m.photoPreview ? `
                        <div class="mb-3 relative">
                            <img src="${m.photoPreview}" class="w-full h-32 object-cover rounded-xl border-2 border-green-300">
                            <button onclick="clearMachinePhoto(${m.id})" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full text-xl">âœ•</button>
                        </div>
                    ` : ''}
                    
                    <!-- Dimensions -->
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <div>
                            <label class="text-xs text-gray-500">${t('width')}</label>
                            <input type="number" value="${m.en}" onchange="updateMachine(${m.id},'en',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-emerald-50">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">${t('length')}</label>
                            <input type="number" value="${m.boy}" onchange="updateMachine(${m.id},'boy',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-emerald-50">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">${t('thickness')}</label>
                            <input type="number" value="${m.kalinlik}" onchange="updateMachine(${m.id},'kalinlik',this.value)" class="input-field w-full p-2 border rounded-lg text-center text-sm bg-emerald-50" step="0.1">
                        </div>
                    </div>
                    
                    <!-- Quantities -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-blue-50 p-3 rounded-xl border-2 border-blue-200">
                            <label class="text-xs text-blue-700 font-bold block mb-1">${t('poperechny')}</label>
                            <input type="number" value="${m.qp}" onchange="updateMachine(${m.id},'qp',this.value)" class="input-field w-full p-3 border-2 border-blue-300 rounded-xl text-center font-bold text-blue-700 text-lg" inputmode="numeric" placeholder="0">
                        </div>
                        <div class="bg-green-50 p-3 rounded-xl border-2 border-green-200">
                            <label class="text-xs text-green-700 font-bold block mb-1">${t('prodolny')}</label>
                            <input type="number" value="${m.qd}" onchange="updateMachine(${m.id},'qd',this.value)" class="input-field w-full p-3 border-2 border-green-300 rounded-xl text-center font-bold text-green-700 text-lg" inputmode="numeric" placeholder="0">
                        </div>
                    </div>
                    
                    <!-- Volume -->
                    <div class="mt-3 flex justify-end gap-2 text-sm">
                        <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded">${calcVol(m,'p')} mÂ³</span>
                        <span class="bg-green-100 text-green-700 px-2 py-1 rounded">${calcVol(m,'d')} mÂ³</span>
                    </div>
                </div>
            `).join('')}

            <!-- Totals & Save -->
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-5 text-white">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white/20 rounded-xl p-4 text-center">
                        <div class="text-sm opacity-80">${t('poperechny')}</div>
                        <div class="text-2xl font-bold">${totalQty('p')} ${t('qty')}</div>
                        <div class="text-lg">${totalVol('p')} mÂ³</div>
                    </div>
                    <div class="bg-white/20 rounded-xl p-4 text-center">
                        <div class="text-sm opacity-80">${t('prodolny')}</div>
                        <div class="text-2xl font-bold">${totalQty('d')} ${t('qty')}</div>
                        <div class="text-lg">${totalVol('d')} mÂ³</div>
                    </div>
                </div>
                <div class="bg-white/30 rounded-xl p-4 text-center mb-4">
                    <div class="text-lg">${t('grandTotal')}</div>
                    <div class="text-4xl font-bold">${grandTotal()} mÂ³</div>
                </div>
                <button onclick="doSaveReport()" id="saveBtn" class="w-full bg-green-500 hover:bg-green-600 py-4 rounded-xl font-bold text-lg" ${state.saving ? 'disabled' : ''}>
                    ${state.saving ? `<span class="spinner"></span> ${t('analyzing')}` : `ğŸ’¾ ${t('save')}`}
                </button>
            </div>
        `;
    }

    function renderReports(filteredReports, periodTotals) {
        const isAdmin = state.user.isAdmin;
        
        return `
            <!-- Period Summary (Admin Only) -->
            ${isAdmin ? `
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-4 mb-4 text-white">
                    <h3 class="font-bold mb-3">ğŸ“Š ${t('totalSummary')}</h3>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-white/20 rounded-xl p-2">
                            <div class="text-xs opacity-80">${t('poperechny')}</div>
                            <div class="text-lg font-bold">${periodTotals.poperechny}</div>
                        </div>
                        <div class="bg-white/20 rounded-xl p-2">
                            <div class="text-xs opacity-80">${t('prodolny')}</div>
                            <div class="text-lg font-bold">${periodTotals.prodolny}</div>
                        </div>
                        <div class="bg-white/20 rounded-xl p-2">
                            <div class="text-xs opacity-80">${t('grandTotal')}</div>
                            <div class="text-lg font-bold">${periodTotals.volume} mÂ³</div>
                        </div>
                    </div>
                    ${periodTotals.mismatchCount > 0 ? `
                        <div class="bg-red-500/50 rounded-xl p-2 mt-2 text-center text-sm">
                            âš ï¸ ${periodTotals.mismatchCount} ${t('mismatchCount')} (${t('operatorData')})
                        </div>
                    ` : ''}
                </div>
            ` : ''}

            <!-- Filters -->
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="text-xs text-gray-500">${t('startDate')}</label>
                        <input type="date" value="${state.filterStart}" onchange="state.filterStart=this.value" class="w-full p-2 border rounded-xl text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500">${t('endDate')}</label>
                        <input type="date" value="${state.filterEnd}" onchange="state.filterEnd=this.value" class="w-full p-2 border rounded-xl text-sm">
                    </div>
                    <div class="flex items-end">
                        <button onclick="applyFilter()" class="w-full bg-indigo-500 text-white py-2 rounded-xl text-sm">${t('filter')}</button>
                    </div>
                </div>
                <div class="flex gap-2 mt-2">
                    ${state.filtering ? `<button onclick="clearFilter()" class="flex-1 bg-gray-400 text-white py-2 rounded-xl text-sm">${t('showAll')}</button>` : ''}
                    <button onclick="doLoadReports()" class="flex-1 bg-blue-500 text-white py-2 rounded-xl text-sm">ğŸ”„ ${t('refresh')}</button>
                    <button onclick="exportExcel()" class="flex-1 bg-green-500 text-white py-2 rounded-xl text-sm">ğŸ“Š Excel</button>
                </div>
            </div>

            <!-- Reports List -->
            ${state.loading ? `
                <div class="text-center py-8">
                    <div class="spinner" style="width:40px;height:40px;border-top-color:#4F46E5;margin:0 auto"></div>
                    <p class="mt-2 text-gray-500">${t('loading')}</p>
                </div>
            ` : filteredReports.length === 0 ? `
                <div class="bg-white rounded-2xl p-8 text-center text-gray-500">ğŸ“‹ ${t('noReports')}</div>
            ` : filteredReports.map(r => renderReportCard(r)).join('')}
        `;
    }

    function renderSettings() {
        return `
            <div class="bg-white rounded-2xl shadow-lg p-5">
                <h3 class="text-xl font-bold text-gray-800 mb-4">âš™ï¸ Ayarlar</h3>
                
                <div class="bg-gray-50 rounded-xl p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Toplam Rapor:</span>
                        <span class="text-2xl font-bold text-indigo-600">${state.reports.length}</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">â˜ï¸ Veriler Supabase bulutunda saklanÄ±yor</p>
                </div>
                
                <div class="space-y-3">
                    <button onclick="doDeleteAllReports()" class="w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-bold">
                        ğŸ—‘ï¸ TÃ¼m RaporlarÄ± Sil
                    </button>
                    
                    <button onclick="doDeleteAllWarnings()" class="w-full bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-semibold">
                        ğŸ”„ UyarÄ± KayÄ±tlarÄ±nÄ± SÄ±fÄ±rla
                    </button>
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                    <h4 class="font-bold text-blue-800 mb-2">ğŸ“Š Sistem Bilgisi</h4>
                    <div class="text-sm text-blue-700 space-y-1">
                        <p>â€¢ VeritabanÄ±: Supabase</p>
                        <p>â€¢ FotoÄŸraf: Cloudinary</p>
                        <p>â€¢ AI DoÄŸrulama: Claude API</p>
                        <p>â€¢ Hosting: Vercel</p>
                    </div>
                </div>
            </div>
        `;
    }

    function renderReportCard(r) {
        const isAdmin = state.user.isAdmin;
        const statusColor = r.verification_status === 'verified' || r.verification_status === 'corrected' ? 'green' : 
                           r.verification_status === 'mismatch' ? 'red' : 'gray';
        const statusIcon = r.verification_status === 'verified' ? 'ğŸŸ¢' : 
                          r.verification_status === 'corrected' ? 'ğŸŸ¢âœ“' :
                          r.verification_status === 'mismatch' ? 'ğŸ”´' : 'âšª';
        const statusText = r.verification_status === 'verified' ? t('verified') :
                          r.verification_status === 'corrected' ? 'DÃ¼zeltildi' :
                          r.verification_status === 'mismatch' ? t('mismatch') : '-';

        return `
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-4 border-l-4 border-${statusColor}-500">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <div class="font-bold">${r.date}</div>
                        <div class="text-sm text-gray-500">${r.shift === 'sabah' ? 'ğŸŒ…' : 'ğŸŒ™'} ${r.user}</div>
                    </div>
                    ${isAdmin ? `
                        <div class="bg-${statusColor}-100 text-${statusColor}-700 px-3 py-1 rounded-full text-sm font-bold">
                            ${statusIcon} ${statusText}
                        </div>
                    ` : ''}
                </div>

                <!-- Machine Details (Admin sees photos & AI comparison) -->
                ${isAdmin && r.verification_details && r.verification_details.length > 0 ? `
                    <div class="space-y-2 mb-3">
                        ${r.verification_details.map((v, idx) => `
                            <div class="bg-gray-50 rounded-xl p-2 flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold">M${v.machineId}</span>
                                    ${r.photos && r.photos[v.machineId] ? `
                                        <img src="${r.photos[v.machineId]}" class="w-12 h-12 object-cover rounded cursor-pointer" onclick="window.open('${r.photos[v.machineId]}')">
                                    ` : '<span class="text-gray-400">ğŸ“· Yok</span>'}
                                </div>
                                <div class="text-right">
                                    ${v.status === 'unknown' ? `<span class="text-gray-400">-</span>` : `
                                        <div class="${v.status === 'mismatch' ? 'text-red-600' : 'text-green-600'}">
                                            ${v.status === 'mismatch' ? 'âŒ' : 'âœ…'} 
                                            AI: ${v.expected} â†’ Girilen: ${v.actual}
                                            ${v.diff > 0 ? `(${v.diff} fark)` : ''}
                                        </div>
                                    `}
                                </div>
                                ${isAdmin && v.status === 'mismatch' && r.verification_status !== 'corrected' ? `
                                    <button onclick="doCorrect(${r.id}, ${v.machineId}, ${v.expected}, '${v.type}')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs ml-2">âœï¸</button>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Totals -->
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div class="bg-blue-50 rounded-xl p-2 text-center">
                        <div class="text-xs text-blue-600">${t('poperechny')}</div>
                        <div class="font-bold text-blue-800">${r.tqp} â†’ ${r.tvp} mÂ³</div>
                    </div>
                    <div class="bg-green-50 rounded-xl p-2 text-center">
                        <div class="text-xs text-green-600">${t('prodolny')}</div>
                        <div class="font-bold text-green-800">${r.tqd} â†’ ${r.tvd} mÂ³</div>
                    </div>
                </div>

                <div class="bg-indigo-100 rounded-xl p-2 text-center">
                    <div class="text-sm text-indigo-600">${t('grandTotal')}</div>
                    <div class="text-xl font-bold text-indigo-800">${r.gt} mÂ³</div>
                </div>

                <!-- Admin Actions -->
                ${isAdmin && r.verification_status === 'mismatch' && !r.warning_logged ? `
                    <button onclick="logWarning(${r.id})" class="w-full mt-2 bg-amber-500 text-white py-2 rounded-xl text-sm">ğŸ“ ${t('warn')}</button>
                ` : ''}
                ${r.warning_logged ? `<div class="text-center text-amber-600 text-sm mt-2">ğŸ“ UyarÄ± kaydedildi</div>` : ''}
                ${r.corrected_by ? `<div class="text-center text-green-600 text-sm mt-2">âœ“ ${r.corrected_by} dÃ¼zeltti</div>` : ''}
            </div>
        `;
    }

    // ==================== HANDLERS ====================
    window.changeLang = (l) => { state.lang = l; localStorage.setItem('lang', l); render(); };
    window.doLogin = () => {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const user = USERS[u];
        if (!user || user.password !== p) { 
            document.getElementById('loginError').textContent = 'HatalÄ±!'; 
            document.getElementById('loginError').classList.remove('hidden'); 
            return; 
        }
        state.user = user; state.loggedIn = true; render();
    };
    window.doLogout = () => { state.loggedIn = false; state.user = null; state.activeProses = null; state.tab = 'giris'; render(); };
    window.selectProses = async (id) => { state.activeProses = id; state.tab = 'giris'; render(); await loadReports(); };
    window.goBack = () => { state.activeProses = null; render(); };
    window.setTab = (t) => { state.tab = t; render(); };
    window.setShift = (s) => { state.shift = s; render(); };
    window.setDate = (d) => { state.date = d; render(); };
    window.updateMachine = (id, field, val) => { 
        state.machines = state.machines.map(m => m.id === id ? {...m, [field]: val} : m); 
        render(); 
    };

    window.handleMachinePhoto = (machineId, input) => {
        const file = input.files[0];
        if (!file) return;
        
        state.machines = state.machines.map(m => {
            if (m.id === machineId) {
                return { ...m, photo: file, photoPreview: URL.createObjectURL(file) };
            }
            return m;
        });
        render();
    };

    window.clearMachinePhoto = (machineId) => {
        state.machines = state.machines.map(m => {
            if (m.id === machineId) {
                return { ...m, photo: null, photoPreview: null };
            }
            return m;
        });
        render();
    };

    window.doSaveReport = async () => {
        state.saving = true;
        render();

        const photos = {};
        const aiReadings = {};
        const verificationDetails = [];

        // Upload photos and analyze
        for (const m of state.machines) {
            if (m.photo) {
                // Upload to Cloudinary
                const photoUrl = await uploadToCloudinary(m.photo);
                if (photoUrl) {
                    photos[m.id] = photoUrl;
                    
                    // Analyze with Claude
                    const aiReading = await analyzeWithClaude(photoUrl);
                    aiReadings[m.id] = aiReading;
                    
                    // Verify
                    const verification = verifyMachine(m, aiReading);
                    verificationDetails.push({ machineId: m.id, ...verification });
                }
            } else {
                verificationDetails.push({ machineId: m.id, status: 'unknown' });
            }
        }

        const verificationStatus = getOverallVerification(verificationDetails);

        const report = { 
            date: state.date + ' ' + new Date().toTimeString().slice(0,5), 
            shift: state.shift, 
            user: state.user.name, 
            machines: state.machines.map(m => ({
                id: m.id,
                en: m.en,
                boy: m.boy,
                kalinlik: m.kalinlik,
                qp: m.qp,
                qd: m.qd,
                vp: calcVol(m,'p'), 
                vd: calcVol(m,'d')
            })), 
            tvp: totalVol('p'), 
            tvd: totalVol('d'), 
            tqp: totalQty('p'), 
            tqd: totalQty('d'), 
            gt: grandTotal(),
            photos,
            ai_readings: aiReadings,
            verification_status: verificationStatus,
            verification_details: verificationDetails
        };

        let saved = false;
        if (navigator.onLine) {
            saved = await saveReportToCloud(report);
            if (saved) {
                showSyncBadge();
                await loadReports();
            }
        }
        
        if (!saved) {
            savePendingReport(report);
        }

        // Reset form
        state.machines = createDefaultMachines();
        state.saving = false;
        render();
        
        const msg = document.getElementById('successMsg');
        if (msg) {
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 3000);
        }
    };

    window.logWarning = async (id) => {
        if (confirm('Bu rapor iÃ§in uyarÄ± kaydedilsin mi?')) {
            await updateReportWarning(id);
        }
    };

    window.doCorrect = (reportId, machineId, expectedValue, type) => {
        const newValue = prompt(`DoÄŸru deÄŸer nedir?\n\nAI okudu: ${expectedValue}`, expectedValue);
        if (newValue !== null) {
            correctReport(reportId, machineId, parseInt(newValue), type);
        }
    };

    window.doLoadReports = loadReports;
    window.applyFilter = () => { state.filtering = true; render(); };
    window.clearFilter = () => { state.filterStart = ''; state.filterEnd = ''; state.filtering = false; render(); };
    
    window.doDeleteAllReports = async () => {
        if (confirm('âš ï¸ TÃœM RAPORLAR SÄ°LÄ°NECEK!\n\nBu iÅŸlem geri alÄ±namaz. Emin misiniz?')) {
            if (confirm('Son kez: GerÃ§ekten tÃ¼m raporlarÄ± silmek istiyor musunuz?')) {
                try {
                    await db.from('reports').delete().neq('id', 0);
                    state.reports = [];
                    showSyncBadge();
                    alert('âœ… TÃ¼m raporlar silindi!');
                    render();
                } catch (error) {
                    console.error('Silme hatasÄ±:', error);
                    alert('âŒ Silme hatasÄ±: ' + error.message);
                }
            }
        }
    };
    
    window.doDeleteAllWarnings = async () => {
        if (confirm('TÃ¼m uyarÄ± kayÄ±tlarÄ± sÄ±fÄ±rlansÄ±n mÄ±?')) {
            try {
                await db.from('reports').update({ warning_logged: false }).neq('id', 0);
                showSyncBadge();
                await loadReports();
                alert('âœ… UyarÄ± kayÄ±tlarÄ± sÄ±fÄ±rlandÄ±!');
            } catch (error) {
                console.error('SÄ±fÄ±rlama hatasÄ±:', error);
            }
        }
    };
    
    window.exportExcel = () => {
        const rpts = state.filtering ? state.reports.filter(r => {
            const d = r.date.split(' ')[0];
            return (!state.filterStart || d >= state.filterStart) && (!state.filterEnd || d <= state.filterEnd);
        }) : state.reports;
        
        let csv = '\uFEFF' + `Tarih,Vardiya,KullanÄ±cÄ±,ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹,ĞŸĞ¾Ğ¿ĞµÑ€ĞµÑ‡Ğ½Ñ‹Ğ¹ mÂ³,ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹,ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»ÑŒĞ½Ñ‹Ğ¹ mÂ³,Toplam mÂ³,DoÄŸrulama\n`;
        rpts.forEach(r => {
            csv += `${r.date},${r.shift},${r.user},${r.tqp},${r.tvp},${r.tqd},${r.tvd},${r.gt},${r.verification_status}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'rapor_' + new Date().toISOString().split('T')[0] + '.csv';
        link.click();
    };

    // Initial render
    render();
    </script>
</body>
</html>
