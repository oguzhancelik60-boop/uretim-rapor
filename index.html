import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Trash2, Save, FileText, Settings, Home, Calculator, LogOut, Lock, Trees, Scissors, Flame, Plus, Droplet, Package, Globe } from 'lucide-react';

// √áEVƒ∞Rƒ∞LER
const TRANSLATIONS = {
  tr: {
    production_report_system: '√úretim Rapor Sistemi',
    login_to_continue: 'Devam etmek i√ßin giri≈ü yapƒ±n',
    username: 'Kullanƒ±cƒ± Adƒ±',
    password: '≈ûifre',
    enter_username: 'Kullanƒ±cƒ± adƒ±nƒ±zƒ± girin',
    enter_password: '≈ûifrenizi girin',
    login_button: 'Giri≈ü Yap',
    logout_button: '√áƒ±kƒ±≈ü',
    demo_users: 'Demo Kullanƒ±cƒ±lar',
    full_access: 'T√ºm eri≈üim',
    user_not_found: 'Kullanƒ±cƒ± bulunamadƒ±!',
    wrong_password: '≈ûifre yanlƒ±≈ü!',
    welcome: 'Ho≈ü geldiniz',
    manager: 'Y√∂netici',
    operator: 'Operat√∂r',
    report_date: 'Rapor Tarihi',
    select_date: 'Tarih Se√ß',
    filter_reports: 'Raporlarƒ± Filtrele',
    start_date: 'Ba≈ülangƒ±√ß Tarihi',
    end_date: 'Biti≈ü Tarihi',
    filter: 'Filtrele',
    show_all: 'T√ºm√ºn√º G√∂ster',
    today: 'Bug√ºn',
    export_excel: 'Excel\'e Aktar',
    export_this_report: 'Bu Raporu Aktar',
    export_filtered: 'Filtrelenenleri Aktar',
    export_all: 'T√ºm√ºn√º Aktar',
    share_whatsapp: 'WhatsApp\'ta Payla≈ü',
    wood_acceptance: 'Aƒüa√ß Kabul',
    veneer_cutting: 'Papel Soyma',
    drying: 'Kurutma',
    veneer_adding: 'Papel Ekleme',
    gluing: 'Tutkallama',
    warehouse: 'Depo',
    coming_soon: 'Yakƒ±nda Aktif Olacak',
    no_permission: 'Yetkiniz Yok',
    open: 'Giri≈ü Yap',
    back: 'Geri',
    drying_machine_report: 'Kurutma Makinesi √úretim Raporu',
    data_entry: 'Veri Giri≈üi',
    reports: 'Raporlar',
    settings: 'Ayarlar',
    shift_selection: 'Vardiya Se√ßimi',
    morning_shift: 'Sabah Vardiyasƒ±',
    evening_shift: 'Ak≈üam Vardiyasƒ±',
    machine: 'Makine',
    width_mm: 'En (mm)',
    length_mm: 'Boy (mm)',
    thickness_mm: 'Kalƒ±nlƒ±k (mm)',
    poperechny: '–ü–æ–ø–µ—Ä–µ—á–Ω—ã–π',
    prodolny: '–ü—Ä–æ–¥–æ–ª—å–Ω—ã–π',
    quantity: 'Adet',
    volume: 'Hacim',
    total_poperechny: '–ü–æ–ø–µ—Ä–µ—á–Ω—ã–π Toplam',
    total_prodolny: '–ü—Ä–æ–¥–æ–ª—å–Ω—ã–π Toplam',
    grand_total: 'Genel Toplam Hacim',
    total_quantity: 'Toplam Adet',
    save_report: 'Raporu Kaydet',
    report_saved: 'Rapor ba≈üarƒ±yla kaydedildi!',
    no_reports: 'Hen√ºz kayƒ±tlƒ± rapor bulunmuyor.',
    date: 'Tarih',
    shift: 'Vardiya',
    user: 'Kullanƒ±cƒ±',
    morning: 'Sabah',
    evening: 'Ak≈üam',
    danger_zone: 'Tehlikeli B√∂lge',
    delete_warning: 'Bu i≈ülem t√ºm kayƒ±tlƒ± raporlarƒ± kalƒ±cƒ± olarak silecektir.',
    delete_all_reports: 'T√ºm Raporlarƒ± Sƒ±fƒ±rla',
    confirm_delete: 'T√ºm raporlar silinecek. Emin misiniz?',
    statistics: 'ƒ∞statistikler',
    total_saved_reports: 'Toplam Kayƒ±tlƒ± Rapor',
    only_admin: 'Sadece',
  },
  ru: {
    production_report_system: '–°–∏—Å—Ç–µ–º–∞ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –û—Ç—á—ë—Ç–æ–≤',
    login_to_continue: '–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è',
    username: '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    password: '–ü–∞—Ä–æ–ª—å',
    enter_username: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
    enter_password: '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å',
    login_button: '–í–æ–π—Ç–∏',
    logout_button: '–í—ã—Ö–æ–¥',
    demo_users: '–î–µ–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
    full_access: '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø',
    user_not_found: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!',
    wrong_password: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!',
    welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å',
    manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä',
    operator: '–û–ø–µ—Ä–∞—Ç–æ—Ä',
    report_date: '–î–∞—Ç–∞ –û—Ç—á—ë—Ç–∞',
    select_date: '–í—ã–±—Ä–∞—Ç—å –î–∞—Ç—É',
    filter_reports: '–§–∏–ª—å—Ç—Ä –û—Ç—á—ë—Ç–æ–≤',
    start_date: '–ù–∞—á–∞–ª—å–Ω–∞—è –î–∞—Ç–∞',
    end_date: '–ö–æ–Ω–µ—á–Ω–∞—è –î–∞—Ç–∞',
    filter: '–§–∏–ª—å—Ç—Ä',
    show_all: '–ü–æ–∫–∞–∑–∞—Ç—å –í—Å–µ',
    today: '–°–µ–≥–æ–¥–Ω—è',
    export_excel: '–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel',
    export_this_report: '–≠–∫—Å–ø–æ—Ä—Ç –≠—Ç–æ–≥–æ –û—Ç—á—ë—Ç–∞',
    export_filtered: '–≠–∫—Å–ø–æ—Ä—Ç –§–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö',
    export_all: '–≠–∫—Å–ø–æ—Ä—Ç –í—Å–µ—Ö',
    share_whatsapp: '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ WhatsApp',
    wood_acceptance: '–ü—Ä–∏—ë–º –î–µ—Ä–µ–≤–∞',
    veneer_cutting: '–†–µ–∑–∫–∞ –®–ø–æ–Ω–∞',
    drying: '–°—É—à–∫–∞',
    veneer_adding: '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –®–ø–æ–Ω–∞',
    gluing: '–°–∫–ª–µ–∏–≤–∞–Ω–∏–µ',
    warehouse: '–°–∫–ª–∞–¥',
    coming_soon: '–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω',
    no_permission: '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞',
    open: '–û—Ç–∫—Ä—ã—Ç—å',
    back: '–ù–∞–∑–∞–¥',
    drying_machine_report: '–û—Ç—á—ë—Ç –æ –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ –°—É—à–∏–ª—å–Ω—ã—Ö –ú–∞—à–∏–Ω',
    data_entry: '–í–≤–æ–¥ –î–∞–Ω–Ω—ã—Ö',
    reports: '–û—Ç—á—ë—Ç—ã',
    settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
    shift_selection: '–í—ã–±–æ—Ä –°–º–µ–Ω—ã',
    morning_shift: '–£—Ç—Ä–µ–Ω–Ω—è—è –°–º–µ–Ω–∞',
    evening_shift: '–í–µ—á–µ—Ä–Ω—è—è –°–º–µ–Ω–∞',
    machine: '–ú–∞—à–∏–Ω–∞',
    width_mm: '–®–∏—Ä–∏–Ω–∞ (–º–º)',
    length_mm: '–î–ª–∏–Ω–∞ (–º–º)',
    thickness_mm: '–¢–æ–ª—â–∏–Ω–∞ (–º–º)',
    poperechny: '–ü–æ–ø–µ—Ä–µ—á–Ω—ã–π',
    prodolny: '–ü—Ä–æ–¥–æ–ª—å–Ω—ã–π',
    quantity: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
    volume: '–û–±—ä—ë–º',
    total_poperechny: '–ü–æ–ø–µ—Ä–µ—á–Ω—ã–π –ò—Ç–æ–≥–æ',
    total_prodolny: '–ü—Ä–æ–¥–æ–ª—å–Ω—ã–π –ò—Ç–æ–≥–æ',
    grand_total: '–û–±—â–∏–π –û–±—ä—ë–º',
    total_quantity: '–í—Å–µ–≥–æ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
    save_report: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û—Ç—á—ë—Ç',
    report_saved: '–û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!',
    no_reports: '–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤.',
    date: '–î–∞—Ç–∞',
    shift: '–°–º–µ–Ω–∞',
    user: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
    morning: '–£—Ç—Ä–µ–Ω–Ω—è—è',
    evening: '–í–µ—á–µ—Ä–Ω—è—è',
    danger_zone: '–û–ø–∞—Å–Ω–∞—è –ó–æ–Ω–∞',
    delete_warning: '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç—ã.',
    delete_all_reports: '–û—á–∏—Å—Ç–∏—Ç—å –í—Å–µ –û—Ç—á—ë—Ç—ã',
    confirm_delete: '–í—Å–µ –æ—Ç—á—ë—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –í—ã —É–≤–µ—Ä–µ–Ω—ã?',
    statistics: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
    total_saved_reports: '–í—Å–µ–≥–æ –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –û—Ç—á—ë—Ç–æ–≤',
    only_admin: '–¢–æ–ª—å–∫–æ',
  },
  kk: {
    production_report_system: '”®–Ω–¥—ñ—Ä—ñ—Å –µ—Å–µ–±—ñ –∂“Ø–π–µ—Å—ñ',
    login_to_continue: '–ñ–∞–ª“ì–∞—Å—Ç—ã—Ä—É “Ø—à—ñ–Ω –∫—ñ—Ä—ñ“£—ñ–∑',
    username: '–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã –∞—Ç—ã',
    password: '“ö“±–ø–∏—è —Å”©–∑',
    enter_username: '–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã –∞—Ç—ã–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑',
    enter_password: '“ö“±–ø–∏—è —Å”©–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑',
    login_button: '–ö—ñ—Ä—É',
    logout_button: '–®—ã“ì—É',
    demo_users: '–î–µ–º–æ –ø–∞–π–¥–∞–ª–∞–Ω—É—à—ã–ª–∞—Ä',
    full_access: '–¢–æ–ª—ã“õ “õ–æ–ª –∂–µ—Ç–∫—ñ–∑—É',
    user_not_found: '–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã —Ç–∞–±—ã–ª–º–∞–¥—ã!',
    wrong_password: '“ö“±–ø–∏—è —Å”©–∑ “õ–∞—Ç–µ!',
    welcome: '“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑',
    manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä',
    operator: '–û–ø–µ—Ä–∞—Ç–æ—Ä',
    report_date: '–ï—Å–µ–ø –ö“Ø–Ω—ñ',
    select_date: '–ö“Ø–Ω –¢–∞“£–¥–∞—É',
    filter_reports: '–ï—Å–µ–ø—Ç–µ—Ä–¥—ñ –°“Ø–∑—É',
    start_date: '–ë–∞—Å—Ç–∞–ª—É –ö“Ø–Ω—ñ',
    end_date: '–ê—è“õ—Ç–∞–ª—É –ö“Ø–Ω—ñ',
    filter: '–°“Ø–∑—É',
    show_all: '–ë–∞—Ä–ª—ã“ì—ã–Ω –ö”©—Ä—Å–µ—Ç—É',
    today: '–ë“Ø–≥—ñ–Ω',
    export_excel: 'Excel-–≥–µ –≠–∫—Å–ø–æ—Ä—Ç',
    export_this_report: '–ë“±–ª –ï—Å–µ–ø—Ç—ñ –≠–∫—Å–ø–æ—Ä—Ç—Ç–∞—É',
    export_filtered: '–°“Ø–∑—ñ–ª–≥–µ–Ω–¥–µ—Ä–¥—ñ –≠–∫—Å–ø–æ—Ä—Ç—Ç–∞—É',
    export_all: '–ë–∞—Ä–ª—ã“ì—ã–Ω –≠–∫—Å–ø–æ—Ä—Ç—Ç–∞—É',
    share_whatsapp: 'WhatsApp-—Ç–∞ –ë”©–ª—ñ—Å—É',
    wood_acceptance: '–ê“ì–∞—à “õ–∞–±—ã–ª–¥–∞—É',
    veneer_cutting: '“ö–∞–±–∞—Ç –∫–µ—Å—É',
    drying: '–ö–µ–ø—Ç—ñ—Ä—É',
    veneer_adding: '“ö–∞–±–∞—Ç “õ–æ—Å—É',
    gluing: '–ñ–µ–ª—ñ–º–¥–µ—É',
    warehouse: '“ö–æ–π–º–∞',
    coming_soon: '–ñ–∞“õ—ã–Ω–¥–∞ –±–µ–ª—Å–µ–Ω–¥—ñ –±–æ–ª–∞–¥—ã',
    no_permission: '–†“±“õ—Å–∞—Ç—ã“£—ã–∑ –∂–æ“õ',
    open: '–ê—à—É',
    back: '–ê—Ä—Ç“õ–∞',
    drying_machine_report: '–ö–µ–ø—Ç—ñ—Ä—É –º–∞—à–∏–Ω–∞—Å—ã ”©–Ω–¥—ñ—Ä—ñ—Å –µ—Å–µ–±—ñ',
    data_entry: '–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –µ–Ω–≥—ñ–∑—É',
    reports: '–ï—Å–µ–ø—Ç–µ—Ä',
    settings: '–ë–∞–ø—Ç–∞—É–ª–∞—Ä',
    shift_selection: '–ê—É—ã—Å—ã–º —Ç–∞“£–¥–∞—É',
    morning_shift: '–¢–∞“£“ì—ã –∞—É—ã—Å—ã–º',
    evening_shift: '–ö–µ—à–∫—ñ –∞—É—ã—Å—ã–º',
    machine: '–ú–∞—à–∏–Ω–∞',
    width_mm: '–ï–Ω—ñ (–º–º)',
    length_mm: '“∞–∑—ã–Ω–¥—ã“ì—ã (–º–º)',
    thickness_mm: '“ö–∞–ª—ã“£–¥—ã“ì—ã (–º–º)',
    poperechny: '–ö”©–ª–¥–µ–Ω–µ“£',
    prodolny: '–ë–æ–π–ª—ã“õ',
    quantity: '–°–∞–Ω—ã',
    volume: '–ö”©–ª–µ–º',
    total_poperechny: '–ö”©–ª–¥–µ–Ω–µ“£ –∂–∏—ã–Ω—ã',
    total_prodolny: '–ë–æ–π–ª—ã“õ –∂–∏—ã–Ω—ã',
    grand_total: '–ñ–∞–ª–ø—ã –∫”©–ª–µ–º',
    total_quantity: '–ñ–∞–ª–ø—ã —Å–∞–Ω—ã',
    save_report: '–ï—Å–µ–ø—Ç—ñ —Å–∞“õ—Ç–∞—É',
    report_saved: '–ï—Å–µ–ø —Å”ô—Ç—Ç—ñ —Å–∞“õ—Ç–∞–ª–¥—ã!',
    no_reports: '”ò–ª—ñ —Å–∞“õ—Ç–∞–ª“ì–∞–Ω –µ—Å–µ–ø—Ç–µ—Ä –∂–æ“õ.',
    date: '–ö“Ø–Ω—ñ',
    shift: '–ê—É—ã—Å—ã–º',
    user: '–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã',
    morning: '–¢–∞“£“ì—ã',
    evening: '–ö–µ—à–∫—ñ',
    danger_zone: '“ö–∞—É—ñ–ø—Ç—ñ –∞–π–º–∞“õ',
    delete_warning: '–ë“±–ª ”ô—Ä–µ–∫–µ—Ç –±–∞—Ä–ª—ã“õ —Å–∞“õ—Ç–∞–ª“ì–∞–Ω –µ—Å–µ–ø—Ç–µ—Ä–¥—ñ “õ–∞–π—Ç–∞—Ä—ã–ø –∞–ª–º–∞—Å—Ç–∞–Ω –∂–æ—è–¥—ã.',
    delete_all_reports: '–ë–∞—Ä–ª—ã“õ –µ—Å–µ–ø—Ç–µ—Ä–¥—ñ —Ç–∞–∑–∞–ª–∞—É',
    confirm_delete: '–ë–∞—Ä–ª—ã“õ –µ—Å–µ–ø—Ç–µ—Ä –∂–æ–π—ã–ª–∞–¥—ã. –°–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?',
    statistics: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
    total_saved_reports: '–ñ–∞–ª–ø—ã —Å–∞“õ—Ç–∞–ª“ì–∞–Ω –µ—Å–µ–ø—Ç–µ—Ä',
    only_admin: '–¢–µ–∫',
  }
};

const USERS = {
  'yonetici': { password: 'admin123', role: 'manager', name: 'Y√∂netici', permissions: ['agac_kabul', 'papel_soyma', 'kurutma', 'papel_ekleme', 'tutkallama', 'depo', 'raporlar', 'ayarlar'] },
  'ali': { password: 'ali123', role: 'operator', name: 'Ali', permissions: ['kurutma'] },
  'mehmet': { password: 'mehmet123', role: 'operator', name: 'Mehmet', permissions: ['kurutma', 'papel_soyma'] },
  'ayse': { password: 'ayse123', role: 'operator', name: 'Ay≈üe', permissions: ['agac_kabul', 'depo'] }
};

const PROSESLER = [
  { id: 'agac_kabul', nameKey: 'wood_acceptance', icon: Trees, color: 'bg-green-500', active: false },
  { id: 'papel_soyma', nameKey: 'veneer_cutting', icon: Scissors, color: 'bg-yellow-500', active: false },
  { id: 'kurutma', nameKey: 'drying', icon: Flame, color: 'bg-orange-500', active: true },
  { id: 'papel_ekleme', nameKey: 'veneer_adding', icon: Plus, color: 'bg-blue-500', active: false },
  { id: 'tutkallama', nameKey: 'gluing', icon: Droplet, color: 'bg-purple-500', active: false },
  { id: 'depo', nameKey: 'warehouse', icon: Package, color: 'bg-indigo-500', active: false }
];

const LANGUAGES = [
  { code: 'tr', name: 'T√ºrk√ße', flag: 'üáπüá∑' },
  { code: 'ru', name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫' },
  { code: 'kk', name: '“ö–∞–∑–∞“õ—à–∞', flag: 'üá∞üáø' }
];

const UretimRaporApp = () => {
  const [lang, setLang] = useState('tr');
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);
  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [loginError, setLoginError] = useState('');
  const [activeProses, setActiveProses] = useState(null);
  const [activeTab, setActiveTab] = useState('giris');
  const [vardiya, setVardiya] = useState('sabah');
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [filterStartDate, setFilterStartDate] = useState('');
  const [filterEndDate, setFilterEndDate] = useState('');
  const [filteredReports, setFilteredReports] = useState([]);
  const [isFiltering, setIsFiltering] = useState(false);
  const [makineler, setMakineler] = useState([
    { id: 1, en: '', boy: '', kalinlik: '', adet_poperechny: '', adet_prodolny: '' },
    { id: 2, en: '', boy: '', kalinlik: '', adet_poperechny: '', adet_prodolny: '' },
    { id: 3, en: '', boy: '', kalinlik: '', adet_poperechny: '', adet_prodolny: '' },
    { id: 4, en: '', boy: '', kalinlik: '', adet_poperechny: '', adet_prodolny: '' }
  ]);
  const [raporlar, setRaporlar] = useState([]);
  const [showSuccess, setShowSuccess] = useState(false);

  const t = (key) => TRANSLATIONS[lang][key] || key;

  useEffect(() => {
    const savedLang = localStorage.getItem('app_language');
    if (savedLang) setLang(savedLang);
    
    try {
      const savedReports = window.storage?.get('kurutma_raporlar');
      if (savedReports) setRaporlar(JSON.parse(savedReports.value || '[]'));
    } catch (error) {
      const localReports = localStorage.getItem('kurutma_raporlar');
      if (localReports) setRaporlar(JSON.parse(localReports));
    }
  }, []);

  const changeLang = (newLang) => {
    setLang(newLang);
    localStorage.setItem('app_language', newLang);
  };

  const handleLogin = (e) => {
    e.preventDefault();
    const user = USERS[loginForm.username];
    if (!user) { setLoginError(t('user_not_found')); return; }
    if (user.password !== loginForm.password) { setLoginError(t('wrong_password')); return; }
    setCurrentUser({ username: loginForm.username, ...user });
    setIsLoggedIn(true);
    setLoginError('');
    setLoginForm({ username: '', password: '' });
  };

  const handleLogout = () => {
    setIsLoggedIn(false);
    setCurrentUser(null);
    setActiveProses(null);
    setActiveTab('giris');
  };

  const hasPermission = (prosesId) => currentUser && currentUser.permissions.includes(prosesId);

  const hacimHesapla = (makine, tur) => {
    const en = parseFloat(makine.en) || 0;
    const boy = parseFloat(makine.boy) || 0;
    const kalinlik = parseFloat(makine.kalinlik) || 0;
    const adet = parseFloat(makine[`adet_${tur}`]) || 0;
    return ((en/1000) * (boy/1000) * (kalinlik/1000) * adet).toFixed(3);
  };

  const toplamHacimHesapla = (tur) => makineler.reduce((t, m) => t + parseFloat(hacimHesapla(m, tur)), 0).toFixed(3);
  const genelToplamHacim = () => (parseFloat(toplamHacimHesapla('poperechny')) + parseFloat(toplamHacimHesapla('prodolny'))).toFixed(3);
  const toplamPapelSayisi = (tur) => makineler.reduce((t, m) => t + (parseFloat(m[`adet_${tur}`]) || 0), 0);

  const makineGuncelle = (id, field, value) => {
    setMakineler(makineler.map(m => m.id === id ? { ...m, [field]: value } : m));
  };

  const raporKaydet = async () => {
    const reportDate = new Date(selectedDate + 'T' + new Date().toTimeString().split(' ')[0]);
    const yeniRapor = {
      id: Date.now(),
      tarih: reportDate.toLocaleString(lang === 'ru' ? 'ru-RU' : lang === 'kk' ? 'kk-KZ' : 'tr-TR'),
      tarihTimestamp: reportDate.getTime(),
      vardiya,
      kullanici: currentUser.name,
      makineler: makineler.map(m => ({ ...m, hacim_poperechny: hacimHesapla(m, 'poperechny'), hacim_prodolny: hacimHesapla(m, 'prodolny') })),
      toplam_poperechny_hacim: toplamHacimHesapla('poperechny'),
      toplam_prodolny_hacim: toplamHacimHesapla('prodolny'),
      toplam_poperechny_adet: toplamPapelSayisi('poperechny'),
      toplam_prodolny_adet: toplamPapelSayisi('prodolny'),
      genel_toplam_hacim: genelToplamHacim()
    };

    const yeniRaporlar = [...raporlar, yeniRapor];
    setRaporlar(yeniRaporlar);
    try { await window.storage?.set('kurutma_raporlar', JSON.stringify(yeniRaporlar)); } 
    catch { localStorage.setItem('kurutma_raporlar', JSON.stringify(yeniRaporlar)); }

    setMakineler([
      { id: 1, en: '', boy: '', kalinlik: '', adet_poperechny: '', adet_prodolny: '' },
      { id: 2, en: '', boy: '', kalinlik: '', adet_poperechny: '', adet_prodolny: '' },
      { id: 3, en: '', boy: '', kalinlik: '', adet_poperechny: '', adet_prodolny: '' },
      { id: 4, en: '', boy: '', kalinlik: '', adet_poperechny: '', adet_prodolny: '' }
    ]);

    setShowSuccess(true);
    setTimeout(() => setShowSuccess(false), 3000);
  };

  const filterReports = () => {
    if (!filterStartDate && !filterEndDate) {
      setIsFiltering(false);
      setFilteredReports([]);
      return;
    }

    const start = filterStartDate ? new Date(filterStartDate).setHours(0,0,0,0) : 0;
    const end = filterEndDate ? new Date(filterEndDate).setHours(23,59,59,999) : Date.now() + 86400000;

    const filtered = raporlar.filter(r => {
      const reportTime = r.tarihTimestamp || new Date(r.tarih).getTime();
      return reportTime >= start && reportTime <= end;
    });

    setFilteredReports(filtered);
    setIsFiltering(true);
  };

  const clearFilter = () => {
    setFilterStartDate('');
    setFilterEndDate('');
    setIsFiltering(false);
    setFilteredReports([]);
  };

  const displayReports = isFiltering ? filteredReports : raporlar;

  const exportToExcel = (reports, filename) => {
    let csv = '\uFEFF'; // UTF-8 BOM for Excel
    
    // Header
    csv += `${t('date')},${t('shift')},${t('user')},${t('machine')},${t('width_mm')},${t('length_mm')},${t('thickness_mm')},${t('poperechny')} ${t('quantity')},${t('poperechny')} ${t('volume')},${t('prodolny')} ${t('quantity')},${t('prodolny')} ${t('volume')}\n`;
    
    // Data rows
    reports.forEach(rapor => {
      rapor.makineler.forEach(m => {
        csv += `${rapor.tarih},${rapor.vardiya === 'sabah' ? t('morning') : t('evening')},${rapor.kullanici},${t('machine')} ${m.id},${m.en},${m.boy},${m.kalinlik},${m.adet_poperechny},${m.hacim_poperechny},${m.adet_prodolny},${m.hacim_prodolny}\n`;
      });
      
      // Summary row
      csv += `${rapor.tarih},${rapor.vardiya === 'sabah' ? t('morning') : t('evening')},${rapor.kullanici},${t('total_poperechny')},,,,${rapor.toplam_poperechny_adet},${rapor.toplam_poperechny_hacim},,\n`;
      csv += `${rapor.tarih},${rapor.vardiya === 'sabah' ? t('morning') : t('evening')},${rapor.kullanici},${t('total_prodolny')},,,,,,${rapor.toplam_prodolny_adet},${rapor.toplam_prodolny_hacim}\n`;
      csv += `${rapor.tarih},${rapor.vardiya === 'sabah' ? t('morning') : t('evening')},${rapor.kullanici},${t('grand_total')},,,,${rapor.toplam_poperechny_adet + rapor.toplam_prodolny_adet},${rapor.genel_toplam_hacim},,\n`;
      csv += '\n';
    });
    
    // Create blob and download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const shareViaWhatsApp = (rapor) => {
    let message = `*${t('drying_machine_report')}*\n\n`;
    message += `üìÖ ${t('date')}: ${rapor.tarih}\n`;
    message += `‚è∞ ${t('shift')}: ${rapor.vardiya === 'sabah' ? t('morning') : t('evening')}\n`;
    message += `üë§ ${t('user')}: ${rapor.kullanici}\n\n`;
    
    rapor.makineler.forEach(m => {
      message += `*${t('machine')} ${m.id}*\n`;
      message += `${t('width_mm')}: ${m.en}mm | ${t('length_mm')}: ${m.boy}mm | ${t('thickness_mm')}: ${m.kalinlik}mm\n`;
      message += `üîµ ${t('poperechny')}: ${m.adet_poperechny} ${t('quantity').toLowerCase()} (${m.hacim_poperechny} m¬≥)\n`;
      message += `üü¢ ${t('prodolny')}: ${m.adet_prodolny} ${t('quantity').toLowerCase()} (${m.hacim_prodolny} m¬≥)\n\n`;
    });
    
    message += `*${t('grand_total').toUpperCase()}*\n`;
    message += `üîµ ${t('total_poperechny')}: ${rapor.toplam_poperechny_adet} ${t('quantity').toLowerCase()} ‚Üí ${rapor.toplam_poperechny_hacim} m¬≥\n`;
    message += `üü¢ ${t('total_prodolny')}: ${rapor.toplam_prodolny_adet} ${t('quantity').toLowerCase()} ‚Üí ${rapor.toplam_prodolny_hacim} m¬≥\n`;
    message += `üìä ${t('grand_total')}: ${rapor.genel_toplam_hacim} m¬≥`;
    
    const encodedMessage = encodeURIComponent(message);
    window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
  };

  const tumuSifirla = async () => {
    if (window.confirm(t('confirm_delete'))) {
      setRaporlar([]);
      try { await window.storage?.set('kurutma_raporlar', '[]'); }
      catch { localStorage.setItem('kurutma_raporlar', '[]'); }
    }
  };

  const raporSil = async (id) => {
    const yeniRaporlar = raporlar.filter(r => r.id !== id);
    setRaporlar(yeniRaporlar);
    try { await window.storage?.set('kurutma_raporlar', JSON.stringify(yeniRaporlar)); }
    catch { localStorage.setItem('kurutma_raporlar', JSON.stringify(yeniRaporlar)); }
  };

  if (!isLoggedIn) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-800 flex items-center justify-center p-4">
        <Card className="w-full max-w-md">
          <CardHeader className="text-center">
            <div className="mx-auto w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mb-4">
              <Lock className="w-10 h-10 text-indigo-600" />
            </div>
            <CardTitle className="text-2xl">{t('production_report_system')}</CardTitle>
            <p className="text-sm text-gray-500 mt-2">{t('login_to_continue')}</p>
            
            <div className="flex justify-center gap-2 mt-4">
              {LANGUAGES.map(l => (
                <Button
                  key={l.code}
                  onClick={() => changeLang(l.code)}
                  variant={lang === l.code ? 'default' : 'outline'}
                  size="sm"
                  className="text-lg"
                >
                  {l.flag}
                </Button>
              ))}
            </div>
          </CardHeader>
          <CardContent>
            <form onSubmit={handleLogin} className="space-y-4">
              {loginError && (
                <Alert className="bg-red-50 border-red-200">
                  <AlertDescription className="text-red-800">{loginError}</AlertDescription>
                </Alert>
              )}
              <div>
                <label className="block text-sm font-medium mb-2">{t('username')}</label>
                <Input type="text" value={loginForm.username} onChange={(e) => setLoginForm({...loginForm, username: e.target.value})} placeholder={t('enter_username')} required />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">{t('password')}</label>
                <Input type="password" value={loginForm.password} onChange={(e) => setLoginForm({...loginForm, password: e.target.value})} placeholder={t('enter_password')} required />
              </div>
              <Button type="submit" className="w-full" size="lg">{t('login_button')}</Button>
            </form>
            <div className="mt-6 p-4 bg-gray-50 rounded-lg text-xs text-gray-600">
              <p className="font-semibold mb-2">{t('demo_users')}:</p>
              <div className="space-y-1">
                <p>‚Ä¢ yonetici / admin123 ({t('full_access')})</p>
                <p>‚Ä¢ ali / ali123 ({t('only_admin')} {t('drying')})</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!activeProses) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
        <div className="max-w-6xl mx-auto">
          <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div>
                <h1 className="text-3xl font-bold text-indigo-900">{t('production_report_system')}</h1>
                <p className="text-gray-600 mt-1">{t('welcome')}, {currentUser.name} ({t(currentUser.role)})</p>
              </div>
              <div className="flex gap-2">
                {LANGUAGES.map(l => (
                  <Button key={l.code} onClick={() => changeLang(l.code)} variant={lang === l.code ? 'default' : 'outline'} size="sm">{l.flag}</Button>
                ))}
                <Button onClick={handleLogout} variant="outline"><LogOut className="w-4 h-4 mr-2" />{t('logout_button')}</Button>
              </div>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {PROSESLER.map((proses) => {
              const Icon = proses.icon;
              const hasAccess = hasPermission(proses.id);
              return (
                <Card key={proses.id} className={`cursor-pointer transition-all hover:shadow-xl ${!hasAccess ? 'opacity-50 cursor-not-allowed' : ''} ${!proses.active ? 'border-2 border-dashed border-gray-300' : ''}`} onClick={() => { if (hasAccess && proses.active) setActiveProses(proses.id); }}>
                  <CardHeader>
                    <div className="flex items-center gap-4">
                      <div className={`w-16 h-16 ${proses.color} rounded-lg flex items-center justify-center`}><Icon className="w-8 h-8 text-white" /></div>
                      <div className="flex-1">
                        <CardTitle className="text-xl">{t(proses.nameKey)}</CardTitle>
                        {!proses.active && <p className="text-xs text-gray-500 mt-1">{t('coming_soon')}</p>}
                        {!hasAccess && proses.active && <p className="text-xs text-red-500 mt-1"><Lock className="w-3 h-3 inline mr-1" />{t('no_permission')}</p>}
                      </div>
                    </div>
                  </CardHeader>
                  {hasAccess && proses.active && <CardContent><Button className="w-full" variant="outline">{t('open')} ‚Üí</Button></CardContent>}
                </Card>
              );
            })}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div className="flex items-center justify-between flex-wrap gap-4">
            <div className="flex items-center gap-4">
              <Button onClick={() => setActiveProses(null)} variant="outline" size="sm">‚Üê {t('back')}</Button>
              <div>
                <h1 className="text-2xl md:text-3xl font-bold text-indigo-900 flex items-center gap-2">
                  <Flame className="w-8 h-8 text-orange-500" />{t('drying_machine_report')}
                </h1>
                <p className="text-sm text-gray-600 mt-1">{currentUser.name} - {t(currentUser.role)}</p>
              </div>
            </div>
            <div className="flex gap-2">
              {LANGUAGES.map(l => (
                <Button key={l.code} onClick={() => changeLang(l.code)} variant={lang === l.code ? 'default' : 'outline'} size="sm">{l.flag}</Button>
              ))}
              <Button onClick={handleLogout} variant="outline"><LogOut className="w-4 h-4 mr-2" />{t('logout_button')}</Button>
            </div>
          </div>
        </div>

        <div className="flex gap-2 mb-6 flex-wrap">
          <Button onClick={() => setActiveTab('giris')} variant={activeTab === 'giris' ? 'default' : 'outline'} className="flex-1 min-w-[120px]">
            <Home className="w-4 h-4 mr-2" />{t('data_entry')}
          </Button>
          <Button onClick={() => setActiveTab('raporlar')} variant={activeTab === 'raporlar' ? 'default' : 'outline'} className="flex-1 min-w-[120px]">
            <FileText className="w-4 h-4 mr-2" />{t('reports')}
          </Button>
          {hasPermission('ayarlar') && (
            <Button onClick={() => setActiveTab('ayarlar')} variant={activeTab === 'ayarlar' ? 'default' : 'outline'} className="flex-1 min-w-[120px]">
              <Settings className="w-4 h-4 mr-2" />{t('settings')}
            </Button>
          )}
        </div>

        {showSuccess && (
          <Alert className="mb-6 bg-green-50 border-green-200">
            <AlertDescription className="text-green-800">‚úì {t('report_saved')}</AlertDescription>
          </Alert>
        )}

        {activeTab === 'giris' && (
          <div className="space-y-6">
            <Card>
              <CardHeader><CardTitle>{t('shift_selection')}</CardTitle></CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <div className="flex gap-4">
                      <Button onClick={() => setVardiya('sabah')} variant={vardiya === 'sabah' ? 'default' : 'outline'} className="flex-1">{t('morning_shift')}</Button>
                      <Button onClick={() => setVardiya('aksam')} variant={vardiya === 'aksam' ? 'default' : 'outline'} className="flex-1">{t('evening_shift')}</Button>
                    </div>
                  </div>
                  {currentUser.role === 'manager' && (
                    <div className="space-y-2">
                      <label className="block text-sm font-medium">{t('report_date')}</label>
                      <Input 
                        type="date" 
                        value={selectedDate} 
                        onChange={(e) => setSelectedDate(e.target.value)}
                        max={new Date().toISOString().split('T')[0]}
                        className="w-full"
                      />
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>

            {makineler.map((makine) => (
              <Card key={makine.id}>
                <CardHeader>
                  <CardTitle className="flex items-center justify-between flex-wrap gap-2">
                    <span>{t('machine')} {makine.id}</span>
                    <div className="text-sm font-normal text-gray-600 space-y-1">
                      <div className="text-blue-700">{t('poperechny')}: {hacimHesapla(makine, 'poperechny')} m¬≥</div>
                      <div className="text-green-700">{t('prodolny')}: {hacimHesapla(makine, 'prodolny')} m¬≥</div>
                    </div>
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div>
                      <label className="block text-sm font-medium mb-2">{t('width_mm')}</label>
                      <Input type="number" step="1" value={makine.en} onChange={(e) => makineGuncelle(makine.id, 'en', e.target.value)} placeholder="0" inputMode="numeric" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2">{t('length_mm')}</label>
                      <Input type="number" step="1" value={makine.boy} onChange={(e) => makineGuncelle(makine.id, 'boy', e.target.value)} placeholder="0" inputMode="numeric" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2">{t('thickness_mm')}</label>
                      <Input type="number" step="0.1" value={makine.kalinlik} onChange={(e) => makineGuncelle(makine.id, 'kalinlik', e.target.value)} placeholder="0.0" inputMode="decimal" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2 text-blue-700">{t('poperechny')}</label>
                      <Input type="number" value={makine.adet_poperechny} onChange={(e) => makineGuncelle(makine.id, 'adet_poperechny', e.target.value)} placeholder="0" inputMode="numeric" className="border-blue-300" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2 text-green-700">{t('prodolny')}</label>
                      <Input type="number" value={makine.adet_prodolny} onChange={(e) => makineGuncelle(makine.id, 'adet_prodolny', e.target.value)} placeholder="0" inputMode="numeric" className="border-green-300" />
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}

            <Card className="bg-gradient-to-br from-indigo-50 to-purple-50 border-2 border-indigo-200">
              <CardContent className="pt-6 space-y-4">
                <div className="flex items-center justify-between p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                  <div>
                    <div className="text-sm text-blue-700 font-medium">{t('total_poperechny')}</div>
                    <div className="text-xs text-blue-600 mt-1">{t('quantity')}: {toplamPapelSayisi('poperechny')}</div>
                  </div>
                  <div className="text-2xl font-bold text-blue-700">{toplamHacimHesapla('poperechny')} m¬≥</div>
                </div>
                <div className="flex items-center justify-between p-4 bg-green-50 rounded-lg border-2 border-green-200">
                  <div>
                    <div className="text-sm text-green-700 font-medium">{t('total_prodolny')}</div>
                    <div className="text-xs text-green-600 mt-1">{t('quantity')}: {toplamPapelSayisi('prodolny')}</div>
                  </div>
                  <div className="text-2xl font-bold text-green-700">{toplamHacimHesapla('prodolny')} m¬≥</div>
                </div>
                <div className="flex items-center justify-between p-4 bg-indigo-100 rounded-lg border-2 border-indigo-300">
                  <div className="flex items-center gap-2">
                    <Calculator className="w-6 h-6 text-indigo-700" />
                    <div>
                      <div className="text-lg font-bold text-indigo-900">{t('grand_total')}</div>
                      <div className="text-xs text-indigo-600 mt-1">{t('total_quantity')}: {toplamPapelSayisi('poperechny') + toplamPapelSayisi('prodolny')}</div>
                    </div>
                  </div>
                  <div className="text-3xl font-bold text-indigo-700">{genelToplamHacim()} m¬≥</div>
                </div>
                <Button onClick={raporKaydet} className="w-full bg-green-600 hover:bg-green-700" size="lg">
                  <Save className="w-5 h-5 mr-2" />{t('save_report')}
                </Button>
              </CardContent>
            </Card>
          </div>
        )}

        {activeTab === 'raporlar' && (
          <div className="space-y-4">
            <Card className="bg-indigo-50">
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <span>{t('filter_reports')}</span>
                  <div className="flex gap-2">
                    <Button 
                      onClick={() => exportToExcel(displayReports, `${t('reports')}_${new Date().toISOString().split('T')[0]}.csv`)}
                      variant="outline"
                      size="sm"
                      className="bg-green-600 text-white hover:bg-green-700"
                    >
                      üìä {isFiltering ? t('export_filtered') : t('export_all')}
                    </Button>
                  </div>
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">{t('start_date')}</label>
                    <Input 
                      type="date" 
                      value={filterStartDate} 
                      onChange={(e) => setFilterStartDate(e.target.value)}
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">{t('end_date')}</label>
                    <Input 
                      type="date" 
                      value={filterEndDate} 
                      onChange={(e) => setFilterEndDate(e.target.value)}
                    />
                  </div>
                  <div className="flex items-end gap-2">
                    <Button onClick={filterReports} className="flex-1 bg-indigo-600 hover:bg-indigo-700">
                      {t('filter')}
                    </Button>
                    {isFiltering && (
                      <Button onClick={clearFilter} variant="outline" className="flex-1">
                        {t('show_all')}
                      </Button>
                    )}
                  </div>
                </div>
                {isFiltering && (
                  <div className="mt-3 text-sm text-indigo-700">
                    {t('filter')}: {filteredReports.length} {t('reports').toLowerCase()}
                  </div>
                )}
              </CardContent>
            </Card>

            {displayReports.length === 0 ? (
              <Card><CardContent className="py-12 text-center text-gray-500">{t('no_reports')}</CardContent></Card>
            ) : (
              displayReports.slice().reverse().map((rapor) => (
                <Card key={rapor.id}>
                  <CardHeader>
                    <CardTitle className="flex items-center justify-between flex-wrap gap-2">
                      <div>
                        <div className="text-lg">{rapor.tarih}</div>
                        <div className="text-sm font-normal text-gray-600">
                          {rapor.vardiya === 'sabah' ? t('morning') : t('evening')} {t('shift')} ‚Ä¢ {rapor.kullanici}
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <Button
                          onClick={() => shareViaWhatsApp(rapor)}
                          variant="outline"
                          size="sm"
                          className="bg-green-500 text-white hover:bg-green-600"
                        >
                          üì±
                        </Button>
                        <Button
                          onClick={() => exportToExcel([rapor], `${t('reports')}_${rapor.tarih.replace(/[/:]/g, '-')}.csv`)}
                          variant="outline"
                          size="sm"
                          className="bg-blue-500 text-white hover:bg-blue-600"
                        >
                          üìä
                        </Button>
                        {hasPermission('ayarlar') && (
                          <Button onClick={() => raporSil(rapor.id)} variant="destructive" size="sm">
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        )}
                      </div>
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-3">
                      {rapor.makineler.map((m) => (
                        <div key={m.id} className="border-l-4 border-indigo-400 pl-4 py-2">
                          <div className="font-semibold">{t('machine')} {m.id}</div>
                          <div className="text-sm text-gray-600 space-y-1 mt-1">
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                              <span>{t('width_mm').replace(' (mm)', '')}: {m.en}mm</span>
                              <span>{t('length_mm').replace(' (mm)', '')}: {m.boy}mm</span>
                              <span>{t('thickness_mm').replace(' (mm)', '')}: {m.kalinlik}mm</span>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 pt-2 border-t">
                              <div className="bg-blue-50 p-2 rounded">
                                <span className="text-blue-700 font-medium">{t('poperechny')}:</span> {m.adet_poperechny} {t('quantity').toLowerCase()}
                                <span className="ml-2 text-blue-600">({m.hacim_poperechny} m¬≥)</span>
                              </div>
                              <div className="bg-green-50 p-2 rounded">
                                <span className="text-green-700 font-medium">{t('prodolny')}:</span> {m.adet_prodolny} {t('quantity').toLowerCase()}
                                <span className="ml-2 text-green-600">({m.hacim_prodolny} m¬≥)</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                      <div className="border-t-2 pt-4 mt-4 space-y-2">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div className="bg-blue-100 p-3 rounded-lg">
                            <div className="text-sm text-blue-700 font-medium">{t('total_poperechny')}</div>
                            <div className="text-lg font-bold text-blue-900">{rapor.toplam_poperechny_hacim} m¬≥</div>
                            <div className="text-xs text-blue-600">{t('quantity')}: {rapor.toplam_poperechny_adet}</div>
                          </div>
                          <div className="bg-green-100 p-3 rounded-lg">
                            <div className="text-sm text-green-700 font-medium">{t('total_prodolny')}</div>
                            <div className="text-lg font-bold text-green-900">{rapor.toplam_prodolny_hacim} m¬≥</div>
                            <div className="text-xs text-green-600">{t('quantity')}: {rapor.toplam_prodolny_adet}</div>
                          </div>
                        </div>
                        <div className="bg-indigo-100 p-4 rounded-lg border-2 border-indigo-300">
                          <div className="text-sm text-indigo-700 font-medium">{t('grand_total').toUpperCase()}</div>
                          <div className="text-2xl font-bold text-indigo-900">{rapor.genel_toplam_hacim} m¬≥</div>
                          <div className="text-xs text-indigo-600">{t('total_quantity')}: {rapor.toplam_poperechny_adet + rapor.toplam_prodolny_adet}</div>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))
            )}
          </div>
        )}

        {activeTab === 'ayarlar' && hasPermission('ayarlar') && (
          <Card>
            <CardHeader><CardTitle>{t('settings')}</CardTitle></CardHeader>
            <CardContent className="space-y-4">
              <div className="border border-red-200 rounded-lg p-4 bg-red-50">
                <h3 className="font-semibold text-red-900 mb-2">{t('danger_zone')}</h3>
                <p className="text-sm text-red-700 mb-4">{t('delete_warning')}</p>
                <Button onClick={tumuSifirla} variant="destructive" className="w-full">
                  <Trash2 className="w-4 h-4 mr-2" />{t('delete_all_reports')}
                </Button>
              </div>
              <div className="border rounded-lg p-4 bg-gray-50">
                <h3 className="font-semibold mb-2">{t('statistics')}</h3>
                <p className="text-sm text-gray-600">{t('total_saved_reports')}: <span className="font-bold">{raporlar.length}</span></p>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
};

export default UretimRaporApp;
